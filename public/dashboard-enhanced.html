<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ - MVP Analitika</title>
  <link rel="stylesheet" href="/no-badge.css" />
  <link rel="stylesheet" href="/assets/advanced-charts.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      color-scheme: dark light;
      /* Dark theme */
      --bg-primary: #0f1115;
      --bg-secondary: #1a1d24;
      --bg-tertiary: #232a36;
      --border: #2b3444;
      --text-primary: #e8eef7;
      --text-secondary: #9fb0c9;
      --text-muted: #6a7789;
      --accent-blue: #2563eb;
      --accent-blue-light: #8ab4ff;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
    }

    body.light-theme {
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --bg-tertiary: #e9ecef;
      --border: #dee2e6;
      --text-primary: #212529;
      --text-secondary: #495057;
      --text-muted: #6c757d;
      --accent-blue: #0d6efd;
      --accent-blue-light: #0d6efd;
      --success: #198754;
      --danger: #dc3545;
      --warning: #ffc107;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border);
      padding: 20px;
    }

    .header-content {
      max-width: 1600px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 { font-size: 24px; margin: 0; }
    .subtitle { color: var(--text-secondary); font-size: 14px; margin: 4px 0 0 0; }

    main {
      max-width: 1600px;
      margin: 0 auto;
      padding: 24px;
    }

    .section {
      margin-bottom: 48px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--text-primary);
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 24px;
    }

    .chart-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .chart-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .kpi-card {
      background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      overflow: hidden;
    }

    .kpi-icon { font-size: 32px; margin-bottom: 12px; }
    .kpi-label {
      color: var(--text-secondary);
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .kpi-value {
      font-size: 36px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }
    .kpi-change {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      font-weight: 600;
    }
    .kpi-change.positive { color: var(--success); }
    .kpi-change.negative { color: var(--danger); }

    .btn {
      padding: 8px 16px;
      background: var(--accent-blue);
      border: 1px solid var(--accent-blue);
      border-radius: 8px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:hover {
      background: #1d4ed8;
      border-color: #1d4ed8;
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      border-color: var(--border);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: var(--border);
    }

    a {
      color: var(--accent-blue-light);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>

<header>
  <div class="header-content">
    <div>
      <h1>üìä –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>
      <p class="subtitle">–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑, —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏</p>
    </div>
    <div>
      <a href="/dashboard" class="btn btn-secondary">‚Üê –ö –æ—Å–Ω–æ–≤–Ω–æ–º—É –¥–∞—à–±–æ—Ä–¥—É</a>
    </div>
  </div>
</header>

<main>

  <!-- KPI Cards with Sparklines -->
  <div class="section">
    <h2 class="section-title">üìà KPI —Å —Ç—Ä–µ–Ω–¥–∞–º–∏</h2>
    <div class="kpi-grid" id="kpi-with-sparklines">
      <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>
  </div>

  <!-- Comparison Analysis -->
  <div class="section">
    <h2 class="section-title">üîÑ –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑</h2>
    <div class="comparison-section">
      <div class="comparison-header">
        <h3 class="comparison-title">–¢–µ–∫—É—â–∏–π vs –ü—Ä–µ–¥—ã–¥—É—â–∏–π –ø–µ—Ä–∏–æ–¥</h3>
        <div class="comparison-toggle">
          <button class="active" data-type="yoy">YoY</button>
          <button data-type="mom">MoM</button>
        </div>
      </div>
      <div class="comparison-chart-wrapper">
        <canvas id="comparison-chart"></canvas>
      </div>
    </div>
  </div>

  <!-- Rankings -->
  <div class="section">
    <h2 class="section-title">üèÜ –†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤</h2>
    <div id="ranking-widget">
      <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>
  </div>

  <!-- Bullet Charts (–ü–ª–∞–Ω vs –§–∞–∫—Ç) -->
  <div class="section">
    <h2 class="section-title">üéØ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤</h2>
    <div class="grid-2">
      <div class="chart-card">
        <div class="chart-header">
          <h4 class="chart-title">–£—Å–ª—É–≥–∏ –Ω–∞—Å–µ–ª–µ–Ω–∏—é</h4>
        </div>
        <div class="bullet-chart-container">
          <canvas id="bullet-chart-1" width="600" height="60"></canvas>
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <h4 class="chart-title">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h4>
        </div>
        <div class="bullet-chart-container">
          <canvas id="bullet-chart-2" width="600" height="60"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Interactive Charts with Drill-Down -->
  <div class="section">
    <h2 class="section-title">üîç –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏</h2>

    <!-- Breadcrumb for drill-down -->
    <div class="drilldown-breadcrumb" id="breadcrumb" style="display: none;">
      <span class="breadcrumb-item active">–í—Å–µ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç—ã</span>
    </div>

    <div class="grid-2">
      <!-- Chart with Brush Zooming -->
      <div class="chart-card chart-with-controls">
        <div class="chart-header">
          <h4 class="chart-title">–í—Ä–µ–º–µ–Ω–Ω–∞—è –¥–∏–Ω–∞–º–∏–∫–∞ (—Å Brush Zooming)</h4>
        </div>
        <div class="chart-controls">
          <button class="chart-control-btn" id="reset-zoom">–°–±—Ä–æ—Å–∏—Ç—å –∑—É–º</button>
        </div>
        <canvas id="brush-zoom-chart"></canvas>
        <div class="zoom-indicator" id="zoom-indicator">
          –ó—É–º –∞–∫—Ç–∏–≤–µ–Ω
          <button class="zoom-reset-btn">√ó</button>
        </div>
      </div>

      <!-- Chart with Cross-Filtering -->
      <div class="chart-card">
        <div class="chart-header">
          <h4 class="chart-title">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ (–∫—Ä–æ—Å—Å-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è)</h4>
        </div>
        <canvas id="cross-filter-chart"></canvas>
      </div>
    </div>
  </div>

  <!-- Synchronized Tooltips -->
  <div class="section">
    <h2 class="section-title">üîó –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏</h2>
    <div class="grid-2">
      <div class="chart-card">
        <div class="chart-header">
          <h4 class="chart-title">–ì—Ä–∞—Ñ–∏–∫ 1</h4>
        </div>
        <canvas id="sync-chart-1"></canvas>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <h4 class="chart-title">–ì—Ä–∞—Ñ–∏–∫ 2</h4>
        </div>
        <canvas id="sync-chart-2"></canvas>
      </div>
    </div>
  </div>

  <!-- Insights -->
  <div class="section">
    <h2 class="section-title">üí° –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω—Å–∞–π—Ç—ã</h2>
    <div id="insights-container">
      <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>
  </div>

</main>

<script src="/assets/advanced-charts.js"></script>
<script>
// ========================================
// INITIALIZATION
// ========================================

const currentYear = new Date().getFullYear();
const currentMonth = new Date().getMonth() + 1;
let comparisonType = 'yoy';
let charts = {};

// ========================================
// 1. KPI WITH SPARKLINES
// ========================================

async function loadKPIWithSparklines() {
  const container = document.getElementById('kpi-with-sparklines');

  // Sample data (in real app, fetch from API)
  const kpis = [
    {
      icon: 'üìä',
      label: '–í—Å–µ–≥–æ —É—Å–ª—É–≥',
      value: 145832,
      change: 12.5,
      trend: [120000, 125000, 130000, 135000, 140000, 145832]
    },
    {
      icon: 'üöó',
      label: '–î–¢–ü',
      value: 234,
      change: -8.3,
      trend: [280, 270, 260, 250, 240, 234]
    },
    {
      icon: 'üí∞',
      label: '–ë—é–¥–∂–µ—Ç (–º–ª–Ω ‚ÇΩ)',
      value: 4523,
      change: 5.7,
      trend: [4200, 4300, 4350, 4400, 4450, 4523]
    }
  ];

  container.innerHTML = kpis.map((kpi, idx) => `
    <div class="kpi-card kpi-card-with-sparkline">
      <span class="kpi-icon">${kpi.icon}</span>
      <div class="kpi-label">${kpi.label}</div>
      <div class="kpi-value">${kpi.value.toLocaleString()}</div>
      <div class="kpi-change ${kpi.change > 0 ? 'positive' : 'negative'}">
        <span class="kpi-arrow">${kpi.change > 0 ? '‚Üë' : '‚Üì'}</span>
        <span>${Math.abs(kpi.change)}%</span>
      </div>
      <div class="kpi-sparkline">
        <canvas id="sparkline-${idx}" width="200" height="40"></canvas>
      </div>
    </div>
  `).join('');

  // Render sparklines
  kpis.forEach((kpi, idx) => {
    const canvas = document.getElementById(`sparkline-${idx}`);
    new AdvancedCharts.SparklineChart(canvas, kpi.trend, {
      color: kpi.change > 0 ? '#10b981' : '#ef4444',
      fillOpacity: 0.2
    });
  });
}

// ========================================
// 2. COMPARISON CHART
// ========================================

async function loadComparisonChart(type = 'yoy') {
  try {
    const response = await fetch(`/api/services-dashboard/comparison?year=${currentYear}&comparison_type=${type}`);
    const data = await response.json();

    const ctx = document.getElementById('comparison-chart').getContext('2d');

    // Destroy existing chart
    if (charts.comparison) {
      charts.comparison.destroy();
    }

    const monthLabels = ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω', '–ò—é–ª', '–ê–≤–≥', '–°–µ–Ω', '–û–∫—Ç', '–ù–æ—è', '–î–µ–∫'];

    charts.comparison = AdvancedCharts.createComparisonChart(
      ctx,
      data.current_period.monthly.map(d => d.total),
      data.previous_period.monthly.map(d => d.total),
      monthLabels,
      {
        currentLabel: `${data.current_period.year} –≥–æ–¥`,
        previousLabel: `${data.previous_period.year} –≥–æ–¥`
      }
    );

  } catch (err) {
    console.error('Error loading comparison chart:', err);
  }
}

// Comparison toggle buttons
document.querySelectorAll('.comparison-toggle button').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.comparison-toggle button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    comparisonType = btn.dataset.type;
    loadComparisonChart(comparisonType);
  });
});

// ========================================
// 3. RANKING WIDGET
// ========================================

async function loadRankingWidget() {
  try {
    const response = await fetch(`/api/services-dashboard/ranking?year=${currentYear}`);
    const data = await response.json();

    const container = document.getElementById('ranking-widget');
    const rankingData = data.all_rankings.map(r => ({
      name: r.name,
      value: r.total
    }));

    AdvancedCharts.createRankingWidget(container, rankingData);

  } catch (err) {
    console.error('Error loading ranking:', err);
  }
}

// ========================================
// 4. BULLET CHARTS
// ========================================

function loadBulletCharts() {
  const canvas1 = document.getElementById('bullet-chart-1');
  new AdvancedCharts.BulletChart(canvas1, {
    plan: 150000,
    actual: 145832,
    min: 0,
    max: 180000,
    ranges: [100000, 140000, 180000]
  });

  const canvas2 = document.getElementById('bullet-chart-2');
  new AdvancedCharts.BulletChart(canvas2, {
    plan: 5000,
    actual: 4523,
    min: 0,
    max: 6000,
    ranges: [3000, 4500, 6000]
  });
}

// ========================================
// 5. BRUSH ZOOMING
// ========================================

function loadBrushZoomChart() {
  const ctx = document.getElementById('brush-zoom-chart').getContext('2d');

  const monthlyData = Array.from({ length: 12 }, (_, i) => Math.floor(Math.random() * 5000) + 8000);

  charts.brushZoom = new Chart(ctx, {
    type: 'line',
    data: {
      labels: ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω', '–ò—é–ª', '–ê–≤–≥', '–°–µ–Ω', '–û–∫—Ç', '–ù–æ—è', '–î–µ–∫'],
      datasets: [{
        label: '–£—Å–ª—É–≥–∏',
        data: monthlyData,
        borderColor: '#2563eb',
        backgroundColor: 'rgba(37, 99, 235, 0.1)',
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        brushZoom: { enabled: true },
        legend: { labels: { color: '#e8eef7' } }
      },
      scales: {
        x: { grid: { color: '#2b3444' }, ticks: { color: '#9fb0c9' } },
        y: { grid: { color: '#2b3444' }, ticks: { color: '#9fb0c9' } }
      }
    }
  });

  document.getElementById('reset-zoom').addEventListener('click', () => {
    charts.brushZoom.resetZoom();
  });
}

// ========================================
// 6. CROSS-FILTER CHART
// ========================================

function loadCrossFilterChart() {
  const ctx = document.getElementById('cross-filter-chart').getContext('2d');

  charts.crossFilter = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['–ó–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ', '–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ', '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', '–ñ–ö–•', '–ö—É–ª—å—Ç—É—Ä–∞'],
      datasets: [{
        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ª—É–≥',
        data: [45000, 38000, 25000, 22000, 15832],
        backgroundColor: '#2563eb'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      onClick: (event, elements) => {
        if (elements.length > 0) {
          const index = elements[0].index;
          const category = charts.crossFilter.data.labels[index];
          showInsight(`–í—ã–±—Ä–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è: ${category}`);
        }
      },
      plugins: {
        crossFilter: { enabled: true },
        legend: { labels: { color: '#e8eef7' } }
      },
      scales: {
        x: { grid: { color: '#2b3444' }, ticks: { color: '#9fb0c9' } },
        y: { grid: { color: '#2b3444' }, ticks: { color: '#9fb0c9' } }
      }
    }
  });
}

// ========================================
// 7. SYNCHRONIZED TOOLTIPS
// ========================================

function loadSynchronizedCharts() {
  const monthlyData1 = Array.from({ length: 12 }, (_, i) => Math.floor(Math.random() * 5000) + 8000);
  const monthlyData2 = Array.from({ length: 12 }, (_, i) => Math.floor(Math.random() * 300) + 150);

  const labels = ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω', '–ò—é–ª', '–ê–≤–≥', '–°–µ–Ω', '–û–∫—Ç', '–ù–æ—è', '–î–µ–∫'];

  const commonOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      syncTooltips: { group: 'sync-group-1' },
      legend: { labels: { color: '#e8eef7' } }
    },
    scales: {
      x: { grid: { color: '#2b3444' }, ticks: { color: '#9fb0c9' } },
      y: { grid: { color: '#2b3444' }, ticks: { color: '#9fb0c9' } }
    }
  };

  charts.sync1 = new Chart(document.getElementById('sync-chart-1'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{ label: '–£—Å–ª—É–≥–∏', data: monthlyData1, borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)', fill: true }]
    },
    options: commonOptions
  });

  charts.sync2 = new Chart(document.getElementById('sync-chart-2'), {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{ label: '–î–¢–ü', data: monthlyData2, backgroundColor: '#ef4444' }]
    },
    options: commonOptions
  });
}

// ========================================
// 8. AUTO INSIGHTS
// ========================================

function showInsight(text) {
  const container = document.getElementById('insights-container');
  const insight = document.createElement('div');
  insight.className = 'insight-card';
  insight.innerHTML = `
    <div class="insight-icon">üí°</div>
    <div class="insight-title">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∏–Ω—Å–∞–π—Ç</div>
    <div class="insight-text">${text}</div>
  `;
  container.appendChild(insight);

  setTimeout(() => {
    insight.style.transition = 'opacity 0.5s';
    insight.style.opacity = '0';
    setTimeout(() => insight.remove(), 500);
  }, 5000);
}

// ========================================
// LOAD ALL
// ========================================

async function init() {
  await loadKPIWithSparklines();
  await loadComparisonChart(comparisonType);
  await loadRankingWidget();
  loadBulletCharts();
  loadBrushZoomChart();
  loadCrossFilterChart();
  loadSynchronizedCharts();

  showInsight('–î–∞—à–±–æ—Ä–¥ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω! –í—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã.');
}

init();
</script>

</body>
</html>
