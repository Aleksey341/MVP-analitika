<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–î–∞—à–±–æ—Ä–¥ - –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</title>
  <style>
    :root {
      color-scheme: dark light;
      /* Dark theme (default) */
      --bg-primary: #0f1115;
      --bg-secondary: #1a1d24;
      --bg-tertiary: #232a36;
      --border: #2b3444;
      --text-primary: #e8eef7;
      --text-secondary: #9fb0c9;
      --text-muted: #6a7789;
      --accent-blue: #2563eb;
      --accent-blue-light: #8ab4ff;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
    }

    /* Light theme */
    body.light-theme {
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --bg-tertiary: #e9ecef;
      --border: #dee2e6;
      --text-primary: #212529;
      --text-secondary: #495057;
      --text-muted: #6c757d;
      --accent-blue: #0d6efd;
      --accent-blue-light: #0d6efd;
      --success: #198754;
      --danger: #dc3545;
      --warning: #ffc107;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg-primary);color:var(--text-primary)}
    header{position:sticky;top:0;z-index:100;background:var(--bg-primary);border-bottom:1px solid var(--border);padding:24px;max-width:1600px;margin:auto}
    main{max-width:1600px;margin:auto;padding:24px}
    h1{font-size:28px;margin-bottom:8px}
    .subtitle{color:var(--text-secondary);font-size:14px;margin:0 0 16px 0}
    a{color:var(--accent-blue-light);text-decoration:none} a:hover{text-decoration:underline}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .ctl{display:flex;flex-direction:column;gap:6px}
    select{background:var(--bg-primary);border:1px solid var(--border);border-radius:10px;color:var(--text-primary);padding:10px 12px;min-width:200px}
    .banner{background:var(--danger);border:1px solid var(--danger);color:#ffd6de;border-radius:10px;padding:12px;margin:12px 0;display:none;opacity:0.9}
    .banner.info{background:var(--accent-blue);border-color:var(--accent-blue);color:#d6f0ff}

    /* KPI Cards */
    .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin:32px 0}
    .kpi-card{
      background:linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
      border:1px solid var(--border);
      border-radius:16px;
      padding:24px;
      position:relative;
      overflow:hidden;
      transition:transform 0.2s, box-shadow 0.2s;
    }
    .kpi-card:hover{transform:translateY(-4px);box-shadow:0 12px 24px rgba(0,0,0,0.4)}
    .kpi-card::before{
      content:'';
      position:absolute;
      top:0;
      right:0;
      width:100px;
      height:100px;
      background:radial-gradient(circle, rgba(37,99,235,0.1) 0%, transparent 70%);
      border-radius:50%;
    }
    .kpi-icon{font-size:32px;margin-bottom:12px;display:block}
    .kpi-label{color:var(--text-secondary);font-size:13px;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
    .kpi-value{font-size:36px;font-weight:700;color:var(--text-primary);margin-bottom:8px;font-variant-numeric:tabular-nums}
    .kpi-change{display:flex;align-items:center;gap:6px;font-size:14px;font-weight:600}
    .kpi-change.positive{color:var(--success)}
    .kpi-change.negative{color:var(--danger)}
    .kpi-change.neutral{color:var(--text-muted)}
    .kpi-arrow{font-size:18px}

    /* Tabs */
    .tabs{display:flex;gap:8px;margin:24px 0;border-bottom:2px solid var(--border)}
    .tab{
      background:transparent;
      border:none;
      color:var(--text-secondary);
      padding:12px 24px;
      font-size:16px;
      font-weight:600;
      cursor:pointer;
      border-bottom:3px solid transparent;
      transition:all 0.2s;
      position:relative;
      top:2px;
    }
    .tab:hover{color:var(--text-primary);background:var(--bg-secondary)}
    .tab.active{color:var(--accent-blue-light);border-bottom-color:var(--accent-blue)}
    .tab-content{display:none}
    .tab-content.active{display:block}

    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin:24px 0}
    .stat-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;padding:20px}
    .stat-value{font-size:32px;font-weight:600;color:var(--accent-blue-light);margin:8px 0}
    .stat-label{color:var(--text-secondary);font-size:14px}
    .stat-change{font-size:12px;color:var(--success)}
    .stat-change.negative{color:var(--danger)}

    .chart-container{background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;padding:20px;margin:16px 0}
    .chart-title{font-size:18px;font-weight:600;margin-bottom:16px;color:var(--text-primary)}
    canvas{max-height:300px}

    table{width:100%;border-collapse:collapse;background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    th{background:var(--bg-tertiary);padding:12px;text-align:left;color:var(--text-secondary);font-weight:600;font-size:13px;text-transform:uppercase;letter-spacing:0.5px}
    td{padding:12px;border-top:1px solid var(--border)}
    tr:hover{background:var(--bg-tertiary)}
    .badge{display:inline-block;padding:4px 12px;border-radius:12px;font-size:11px;font-weight:500}
    .badge.new{background:var(--success);color:#fff;opacity:0.8}
    .badge.updated{background:var(--accent-blue);color:#fff;opacity:0.8}

    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:24px}
    @media(max-width:900px){.grid-2{grid-template-columns:1fr}}

    .loading{text-align:center;padding:40px;color:var(--text-secondary)}
    .empty{text-align:center;padding:40px;color:var(--text-muted)}

    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–µ—á–∞—Ç–∏ */
    @media print {
      body {background: white; color: black;}
      header {position: static; border-bottom: 2px solid #000;}
      .chart-container {page-break-inside: avoid; border: 1px solid #ccc;}
      button, .banner {display: none !important;}
      canvas {max-height: none;}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header>
  <a href="/">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
  <h1>üìä –û–±—â–∏–π –¥–∞—à–±–æ—Ä–¥ –õ–∏–ø–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏</h1>
  <p class="subtitle">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º –∏ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–∞–º</p>
  <div id="banner" class="banner"></div>

  <div class="row" style="margin-top:16px">
    <div class="ctl">
      <label for="year">–ì–æ–¥</label>
      <select id="year"></select>
    </div>

    <div class="ctl">
      <label for="month">–ú–µ—Å—è—Ü</label>
      <select id="month">
        <option value="">–í—Å–µ –º–µ—Å—è—Ü—ã</option>
        <option value="01">–Ø–Ω–≤–∞—Ä—å</option>
        <option value="02">–§–µ–≤—Ä–∞–ª—å</option>
        <option value="03">–ú–∞—Ä—Ç</option>
        <option value="04">–ê–ø—Ä–µ–ª—å</option>
        <option value="05">–ú–∞–π</option>
        <option value="06">–ò—é–Ω—å</option>
        <option value="07">–ò—é–ª—å</option>
        <option value="08">–ê–≤–≥—É—Å—Ç</option>
        <option value="09">–°–µ–Ω—Ç—è–±—Ä—å</option>
        <option value="10">–û–∫—Ç—è–±—Ä—å</option>
        <option value="11">–ù–æ—è–±—Ä—å</option>
        <option value="12">–î–µ–∫–∞–±—Ä—å</option>
      </select>
    </div>

    <div class="ctl">
      <label for="municipality">–ú—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç</label>
      <select id="municipality">
        <option value="">–í—Å–µ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç—ã</option>
      </select>
    </div>

    <div class="ctl">
      <label>&nbsp;</label>
      <button id="themeToggle" class="btn" style="min-width:140px">üåô –¢–µ–º–Ω–∞—è —Ç–µ–º–∞</button>
    </div>
  </div>
</header>

<main>
  <!-- Tabs Navigation -->
  <div class="tabs">
    <button class="tab active" data-tab="services">üìã –£—Å–ª—É–≥–∏</button>
    <button class="tab" data-tab="dtp">üöó –î–¢–ü</button>
    <button class="tab" data-tab="finance">üí∞ –§–∏–Ω–∞–Ω—Å—ã</button>
  </div>

  <!-- Tab: –£—Å–ª—É–≥–∏ -->
  <div class="tab-content active" id="tab-services">
    <!-- KPI Cards –¥–ª—è —É—Å–ª—É–≥ -->
    <div class="kpi-grid">
      <div class="kpi-card">
        <span class="kpi-icon">üìã</span>
        <div class="kpi-label">–£—Å–ª—É–≥ –æ–∫–∞–∑–∞–Ω–æ</div>
        <div class="kpi-value" id="kpi-services-total">-</div>
        <div class="kpi-change neutral" id="kpi-services-total-change">
          <span class="kpi-arrow">‚Üí</span>
          <span>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
        </div>
      </div>
    </div>

    <!-- –î–∏–Ω–∞–º–∏–∫–∞ –æ–∫–∞–∑–∞–Ω–∏—è —É—Å–ª—É–≥ –ø–æ –º–µ—Å—è—Ü–∞–º -->
    <div class="chart-container">
      <div class="chart-title">üìà –î–∏–Ω–∞–º–∏–∫–∞ –æ–∫–∞–∑–∞–Ω–∏—è —É—Å–ª—É–≥ –ø–æ –º–µ—Å—è—Ü–∞–º</div>
      <canvas id="chartServicesMonthly"></canvas>
    </div>

    <!-- –¢–û–ü-10 –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —É—Å–ª—É–≥ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
    <div class="grid-2">
      <div class="chart-container">
        <div class="chart-title">üèÜ –¢–û–ü-10 –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —É—Å–ª—É–≥</div>
        <canvas id="chartTopServices"></canvas>
      </div>

      <div class="chart-container">
        <div class="chart-title">üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div>
        <canvas id="chartServicesCategories"></canvas>
      </div>
    </div>

    <!-- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤ -->
    <div class="chart-container">
      <div class="chart-title">üèõÔ∏è –¢–û–ü-10 –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤ –ø–æ —É—Å–ª—É–≥–∞–º</div>
      <canvas id="chartServicesMunicipalities"></canvas>
    </div>
  </div>

  <!-- Tab: –î–¢–ü -->
  <div class="tab-content" id="tab-dtp">
    <!-- KPI Cards –¥–ª—è –î–¢–ü -->
    <div class="kpi-grid">
    <div class="kpi-card">
      <span class="kpi-icon">üöó</span>
      <div class="kpi-label">–î–¢–ü (–≤—Å–µ–≥–æ)</div>
      <div class="kpi-value" id="kpi-dtp">-</div>
      <div class="kpi-change neutral" id="kpi-dtp-change">
        <span class="kpi-arrow">‚Üí</span>
        <span>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
      </div>
    </div>

    <div class="kpi-card">
      <span class="kpi-icon">‚ö†Ô∏è</span>
      <div class="kpi-label">–ü–æ–≥–∏–±–ª–æ</div>
      <div class="kpi-value" id="kpi-dead">-</div>
      <div class="kpi-change neutral" id="kpi-dead-change">
        <span class="kpi-arrow">‚Üí</span>
        <span>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
      </div>
    </div>

    <div class="kpi-card">
      <span class="kpi-icon">üè•</span>
      <div class="kpi-label">–†–∞–Ω–µ–Ω–æ</div>
      <div class="kpi-value" id="kpi-injured">-</div>
      <div class="kpi-change neutral" id="kpi-injured-change">
        <span class="kpi-arrow">‚Üí</span>
        <span>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
      </div>
    </div>
  </div>

  <!-- –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º (–ª–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫) -->
  <div class="chart-container">
    <div class="chart-title">üìà –î–∏–Ω–∞–º–∏–∫–∞ –î–¢–ü –∏ –ø–æ—Å—Ç—Ä–∞–¥–∞–≤—à–∏—Ö –ø–æ –º–µ—Å—è—Ü–∞–º</div>
    <canvas id="chartMonthlyDynamics"></canvas>
  </div>

  <!-- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–æ–≤ –∏ –¢–û–ü —Ä–∞–π–æ–Ω–æ–≤ -->
  <div class="grid-2">
    <div class="chart-container">
      <div class="chart-title">üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–æ–≤ (–≥–æ–¥ –∫ –≥–æ–¥—É)</div>
      <canvas id="chartPeriodComparison"></canvas>
    </div>

    <div class="chart-container">
      <div class="chart-title">üèõÔ∏è –¢–û–ü-10 –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤ –ø–æ –î–¢–ü</div>
      <canvas id="chartTopMunicipalities"></canvas>
    </div>
  </div>

  <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
  <div class="grid-2">
    <div class="chart-container">
      <div class="chart-title">üîç –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –î–¢–ü –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div>
      <canvas id="chartAccidentCategories"></canvas>
    </div>

    <div class="chart-container">
      <div class="chart-title">üìç –î–¢–ü –ø–æ –º–µ—Å—Ç–∞–º —Å–æ–≤–µ—Ä—à–µ–Ω–∏—è</div>
      <canvas id="chartAccidentLocations"></canvas>
    </div>
  </div>

  <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
  <div class="grid-2">
    <div class="chart-container">
      <div class="chart-title">üë• –ü–æ—Å—Ç—Ä–∞–¥–∞–≤—à–∏–µ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–Ω—ã–º –≥—Ä—É–ø–ø–∞–º</div>
      <canvas id="chartVictimsByAge"></canvas>
    </div>

    <div class="chart-container">
      <div class="chart-title">üö® –û—Å–æ–±—ã–µ —Å–ª—É—á–∞–∏ –î–¢–ü</div>
      <canvas id="chartSpecialCases"></canvas>
    </div>
  </div>

    <!-- –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –î–¢–ü -->
    <div class="chart-container" style="margin-top: 24px;">
      <div class="chart-title">üì• –≠–∫—Å–ø–æ—Ä—Ç –∏ –ø–µ—á–∞—Ç—å</div>
      <div class="row" style="padding: 20px; gap: 16px;">
        <button id="btnExportExcel" class="btn">üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
        <button id="btnExportPDF" class="btn">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF</button>
        <button id="btnPrint" class="btn">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- Tab: –§–∏–Ω–∞–Ω—Å—ã -->
  <div class="tab-content" id="tab-finance">
    <div class="kpi-grid">
      <div class="kpi-card">
        <span class="kpi-icon">üí∞</span>
        <div class="kpi-label">–î–æ—Ö–æ–¥—ã</div>
        <div class="kpi-value">-</div>
        <div class="kpi-change neutral">
          <span class="kpi-arrow">‚Üí</span>
          <span>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
        </div>
      </div>

      <div class="kpi-card">
        <span class="kpi-icon">üí∏</span>
        <div class="kpi-label">–†–∞—Å—Ö–æ–¥—ã</div>
        <div class="kpi-value">-</div>
        <div class="kpi-change neutral">
          <span class="kpi-arrow">‚Üí</span>
          <span>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
        </div>
      </div>

      <div class="kpi-card">
        <span class="kpi-icon">üìä</span>
        <div class="kpi-label">–ë–∞–ª–∞–Ω—Å</div>
        <div class="kpi-value">-</div>
        <div class="kpi-change neutral">
          <span class="kpi-arrow">‚Üí</span>
          <span>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
        </div>
      </div>

      <div class="kpi-card">
        <span class="kpi-icon">üìà</span>
        <div class="kpi-label">–î–∏–Ω–∞–º–∏–∫–∞</div>
        <div class="kpi-value">-</div>
        <div class="kpi-change neutral">
          <span class="kpi-arrow">‚Üí</span>
          <span>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
        </div>
      </div>
    </div>

    <div class="chart-container">
      <div class="chart-title">üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
      <p style="text-align:center;padding:40px;color:var(--text-muted)">–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –ó–¥–µ—Å—å –±—É–¥—É—Ç –≥—Ä–∞—Ñ–∏–∫–∏ –¥–æ—Ö–æ–¥–æ–≤, —Ä–∞—Å—Ö–æ–¥–æ–≤ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π.</p>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
const $ = s => document.querySelector(s);
const banner = $('#banner');
function showBanner(msg, isInfo){
  if(!msg){banner.style.display='none'; return;}
  banner.textContent = msg;
  banner.className = isInfo ? 'banner info' : 'banner';
  banner.style.display='block';
}

let charts = {};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–≤–µ—Ç–æ–≤ —Ç–µ–º—ã –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
function getThemeColors() {
  const isLight = document.body.classList.contains('light-theme');
  return {
    gridColor: isLight ? '#e0e0e0' : '#232a36',
    textColor: isLight ? '#495057' : '#9fb0c9',
    tooltipBg: isLight ? 'rgba(0,0,0,0.8)' : 'rgba(0,0,0,0.8)',
    borderColor: isLight ? '#dee2e6' : '#1a1d24'
  };
}

// Chart.js plugin –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –Ω–∞ –∫—Ä—É–≥–æ–≤—ã—Ö –¥–∏–∞–≥—Ä–∞–º–º–∞—Ö
const datalabelsPlugin = {
  id: 'datalabels',
  afterDatasetDraw(chart, args, options) {
    const { ctx, data } = chart;
    const meta = args.meta;

    if (chart.config.type !== 'pie' && chart.config.type !== 'doughnut') return;

    meta.data.forEach((element, index) => {
      const value = data.datasets[0].data[index];
      const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
      const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;

      if (value === 0 || percentage < 5) return; // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–µ—Ç–∫–∏ –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤

      const { x, y } = element.tooltipPosition();

      ctx.save();
      ctx.font = 'bold 14px system-ui';
      ctx.fillStyle = '#fff';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.shadowColor = 'rgba(0,0,0,0.5)';
      ctx.shadowBlur = 4;
      ctx.fillText(`${value}`, x, y - 8);
      ctx.font = '12px system-ui';
      ctx.fillText(`(${percentage}%)`, x, y + 8);
      ctx.restore();
    });
  }
};

// Chart.js plugin –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –Ω–∞ —Å—Ç–æ–ª–±—á–∞—Ç—ã—Ö –¥–∏–∞–≥—Ä–∞–º–º–∞—Ö
const barLabelsPlugin = {
  id: 'barLabels',
  afterDatasetDraw(chart, args, options) {
    const { ctx } = chart;
    const meta = args.meta;
    const dataset = chart.data.datasets[args.index];

    if (chart.config.type !== 'bar') return;
    if (!meta || !dataset) return;

    ctx.save();
    ctx.font = 'bold 11px system-ui';
    ctx.fillStyle = getThemeColors().textColor;

    meta.data.forEach((bar, index) => {
      const value = dataset.data[index];
      if (!value || value === 0) return;

      const { x, y } = bar.tooltipPosition();

      // –î–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ (indexAxis: 'y')
      if (chart.config.options.indexAxis === 'y') {
        ctx.textAlign = 'left';
        ctx.textBaseline = 'middle';
        ctx.fillText(value, x + 5, y);
      } else {
        // –î–ª—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom';
        ctx.fillText(value, x, y - 5);
      }
    });

    ctx.restore();
  }
};

// –£—Ç–∏–ª–∏—Ç—ã
function escapeHtml(s){return (s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function formatNum(n){return Number(n||0).toLocaleString('ru-RU')}
function formatDate(d){return new Date(d).toLocaleDateString('ru-RU')}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
function getFilters(){
  return {
    year: $('#year').value,
    month: $('#month').value,
    municipalityId: $('#municipality').value
  };
}

// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç—É
function filterDataByMunicipality(data, municipalityId){
  if (!municipalityId) return data;
  return data.filter(row => row.municipality_id == municipalityId);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ KPI-–¥–∞–Ω–Ω—ã—Ö —Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤
async function loadKPIData(){
  try{
    const filters = getFilters();
    const currentYearPeriods = await fetch(`/api/gibdd/periods`, {credentials: 'include'}).then(r=>r.json());

    if(currentYearPeriods.length === 0){
      updateKPI('kpi-dtp', '-', null);
      updateKPI('kpi-dead', '-', null);
      updateKPI('kpi-injured', '-', null);
      updateKPI('kpi-services', '-', null);
      return;
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–∏–æ–¥ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    let latestPeriod;
    if (filters.month) {
      // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –º–µ—Å—è—Ü, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–µ—Å—è—Ü
      latestPeriod = `${filters.year}-${filters.month}`;
    } else {
      // –ò–Ω–∞—á–µ –±–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –¥–ª—è –≥–æ–¥–∞
      const yearPeriods = currentYearPeriods.filter(p => p.period.startsWith(filters.year));
      if (yearPeriods.length === 0) {
        updateKPI('kpi-dtp', '-', null);
        updateKPI('kpi-dead', '-', null);
        updateKPI('kpi-injured', '-', null);
        updateKPI('kpi-services', '-', null);
        return;
      }
      latestPeriod = yearPeriods[0].period;
    }

    const gibddData = await fetch(`/api/gibdd/data?period=${latestPeriod}`, {credentials: 'include'}).then(r=>r.json());

    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç—É –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω
    const filteredData = filterDataByMunicipality(gibddData, filters.municipalityId);

    // –ü–æ–¥—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤
    const totals = filteredData.reduce((acc, row) => {
      acc.dtp += Number(row.dtp_total || 0);
      acc.dead += Number(row.dtp_total_dead || 0);
      acc.injured += Number(row.dtp_total_injured || 0);
      return acc;
    }, {dtp: 0, dead: 0, injured: 0});

    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≥–æ–¥–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    const [y, m] = latestPeriod.split('-');
    const prevYear = Number(y) - 1;
    const prevPeriod = `${prevYear}-${m}`;

    let prevTotals = {dtp: 0, dead: 0, injured: 0};
    try{
      const prevData = await fetch(`/api/gibdd/data?period=${prevPeriod}`, {credentials: 'include'}).then(r=>r.json());
      const filteredPrevData = filterDataByMunicipality(prevData, filters.municipalityId);
      prevTotals = filteredPrevData.reduce((acc, row) => {
        acc.dtp += Number(row.dtp_total || 0);
        acc.dead += Number(row.dtp_total_dead || 0);
        acc.injured += Number(row.dtp_total_injured || 0);
        return acc;
      }, {dtp: 0, dead: 0, injured: 0});
    }catch(e){
      console.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥–æ–¥');
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ KPI-–∫–∞—Ä—Ç–æ—á–µ–∫
    updateKPI('kpi-dtp', totals.dtp, prevTotals.dtp);
    updateKPI('kpi-dead', totals.dead, prevTotals.dead);
    updateKPI('kpi-injured', totals.injured, prevTotals.injured);
    updateKPI('kpi-services', '-', null);

  }catch(e){
    console.error('loadKPIData:', e);
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–π KPI-–∫–∞—Ä—Ç–æ—á–∫–∏
function updateKPI(id, current, previous){
  const valueEl = $('#'+id);
  const changeEl = $('#'+id+'-change');

  valueEl.textContent = formatNum(current);

  if(previous === null || previous === undefined || current === '-'){
    changeEl.className = 'kpi-change neutral';
    changeEl.innerHTML = '<span class="kpi-arrow">‚Üí</span><span>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>';
    return;
  }

  const change = current - previous;
  const changePercent = previous > 0 ? ((change / previous) * 100).toFixed(1) : 0;

  if(change > 0){
    changeEl.className = 'kpi-change negative'; // –î–ª—è –î–¢–ü —Ä–æ—Å—Ç - —ç—Ç–æ –ø–ª–æ—Ö–æ
    changeEl.innerHTML = `<span class="kpi-arrow">‚ñ≤</span><span>+${changePercent}% (+${formatNum(change)})</span>`;
  }else if(change < 0){
    changeEl.className = 'kpi-change positive'; // –î–ª—è –î–¢–ü —Å–Ω–∏–∂–µ–Ω–∏–µ - —ç—Ç–æ —Ö–æ—Ä–æ—à–æ
    changeEl.innerHTML = `<span class="kpi-arrow">‚ñº</span><span>${changePercent}% (${formatNum(change)})</span>`;
  }else{
    changeEl.className = 'kpi-change neutral';
    changeEl.innerHTML = '<span class="kpi-arrow">‚Üí</span><span>–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π</span>';
  }
}

// –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≥–æ–¥–∞
function fillYears(){
  const now = new Date().getFullYear();
  const sel = $('#year'); sel.innerHTML = '';
  for (let y=now-3; y<=now+1; y++){
    const o = document.createElement('option');
    o.value = o.textContent = y;
    if (y===now) o.selected = true;
    sel.appendChild(o);
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤
async function loadMunicipalities(){
  try{
    const r = await fetch('/api/municipalities');
    if(!r.ok) throw new Error('HTTP '+r.status);
    const rows = await r.json();
    const sel = $('#municipality');
    sel.innerHTML = '<option value="">–í—Å–µ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç—ã</option>' +
      rows.map(x=>`<option value="${x.id}">${escapeHtml(x.name)}</option>`).join('');
  }catch(e){
    console.error('loadMunicipalities:', e);
  }
}


// –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
function updateChart(id, config){
  if(charts[id]) charts[id].destroy();

  // –î–æ–±–∞–≤–ª—è–µ–º –ø–ª–∞–≥–∏–Ω –¥–ª—è –∫—Ä—É–≥–æ–≤—ã—Ö –¥–∏–∞–≥—Ä–∞–º–º
  if (config.type === 'pie' || config.type === 'doughnut') {
    if (!config.plugins) config.plugins = [];
    config.plugins.push(datalabelsPlugin);
  }

  // –î–æ–±–∞–≤–ª—è–µ–º –ø–ª–∞–≥–∏–Ω –¥–ª—è —Å—Ç–æ–ª–±—á–∞—Ç—ã—Ö –¥–∏–∞–≥—Ä–∞–º–º
  if (config.type === 'bar') {
    if (!config.plugins) config.plugins = [];
    config.plugins.push(barLabelsPlugin);
  }

  charts[id] = new Chart($('#'+id).getContext('2d'), config);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤
async function refreshDashboard(){
  showBanner('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...', true);

  try{
    await renderMonthlyDynamics();
    await renderPeriodComparison();
    await renderTopMunicipalities();
    await renderAccidentCategories();
    await renderAccidentLocations();
    await renderVictimsByAge();
    await renderSpecialCases();
    showBanner('');
  }catch(e){
    console.error(e);
    showBanner('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
  }
}

// === –≠–¢–ê–ü 2: –õ–ò–ù–ï–ô–ù–´–ï –ì–†–ê–§–ò–ö–ò –î–ò–ù–ê–ú–ò–ö–ò ===

// 1. –î–∏–Ω–∞–º–∏–∫–∞ –î–¢–ü –ø–æ –º–µ—Å—è—Ü–∞–º (–º—É–ª—å—Ç–∏–ª–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫) —Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤
async function renderMonthlyDynamics(){
  try{
    const filters = getFilters();
    const periods = await fetch('/api/gibdd/periods', {credentials: 'include'}).then(r=>r.json());
    const yearPeriods = periods.filter(p => p.period.startsWith(filters.year));

    if(yearPeriods.length === 0){
      updateChart('chartMonthlyDynamics', {type: 'line', data: {labels: [], datasets: []}});
      return;
    }

    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—Å–µ–º –º–µ—Å—è—Ü–∞–º –≥–æ–¥–∞
    const monthlyData = {dtp: [], dead: [], injured: []};
    const labels = [];

    for(let m = 1; m <= 12; m++){
      const period = `${filters.year}-${String(m).padStart(2, '0')}`;
      labels.push(['–Ø–Ω–≤','–§–µ–≤','–ú–∞—Ä','–ê–ø—Ä','–ú–∞–π','–ò—é–Ω','–ò—é–ª','–ê–≤–≥','–°–µ–Ω','–û–∫—Ç','–ù–æ—è','–î–µ–∫'][m-1]);

      try{
        const data = await fetch(`/api/gibdd/data?period=${period}`, {credentials: 'include'}).then(r=>r.json());
        const filteredData = filterDataByMunicipality(data, filters.municipalityId);
        const totals = filteredData.reduce((acc, row) => {
          acc.dtp += Number(row.dtp_total || 0);
          acc.dead += Number(row.dtp_total_dead || 0);
          acc.injured += Number(row.dtp_total_injured || 0);
          return acc;
        }, {dtp: 0, dead: 0, injured: 0});

        monthlyData.dtp.push(totals.dtp);
        monthlyData.dead.push(totals.dead);
        monthlyData.injured.push(totals.injured);
      }catch(e){
        monthlyData.dtp.push(null);
        monthlyData.dead.push(null);
        monthlyData.injured.push(null);
      }
    }

    updateChart('chartMonthlyDynamics', {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: '–î–¢–ü',
            data: monthlyData.dtp,
            borderColor: '#2563eb',
            backgroundColor: 'rgba(37,99,235,0.1)',
            tension: 0.4,
            fill: true,
            borderWidth: 3
          },
          {
            label: '–ü–æ–≥–∏–±–ª–æ',
            data: monthlyData.dead,
            borderColor: '#ef4444',
            backgroundColor: 'rgba(239,68,68,0.1)',
            tension: 0.4,
            fill: true,
            borderWidth: 3
          },
          {
            label: '–†–∞–Ω–µ–Ω–æ',
            data: monthlyData.injured,
            borderColor: '#f59e0b',
            backgroundColor: 'rgba(245,158,11,0.1)',
            tension: 0.4,
            fill: true,
            borderWidth: 3
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        interaction: {mode: 'index', intersect: false},
        plugins: {
          legend: {display: true, position: 'top', labels: {color: getThemeColors().textColor, padding: 15, font: {size: 13}}},
          tooltip: {backgroundColor: getThemeColors().tooltipBg, padding: 12, titleFont: {size: 14}, bodyFont: {size: 13}}
        },
        scales: {
          y: {beginAtZero: true, grid: {display: false}, ticks: {color: getThemeColors().textColor}},
          x: {grid: {display: false}, ticks: {color: getThemeColors().textColor}}
        }
      }
    });
  }catch(e){
    console.error('renderMonthlyDynamics:', e);
  }
}

// 2. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–æ–≤ (—Å—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ - —Ç–µ–∫—É—â–∏–π vs –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥–æ–¥) —Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤
async function renderPeriodComparison(){
  try{
    const filters = getFilters();
    const currentPeriods = await fetch('/api/gibdd/periods', {credentials: 'include'}).then(r=>r.json());
    const yearPeriods = currentPeriods.filter(p => p.period.startsWith(filters.year));

    if(yearPeriods.length === 0){
      updateChart('chartPeriodComparison', {type: 'bar', data: {labels: [], datasets: []}});
      return;
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–∏–æ–¥ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∏–ª—å—Ç—Ä–∞ –º–µ—Å—è—Ü–∞
    let latestPeriod;
    if (filters.month) {
      latestPeriod = `${filters.year}-${filters.month}`;
    } else {
      latestPeriod = yearPeriods[0].period;
    }
    const [y, m] = latestPeriod.split('-');

    const currentData = await fetch(`/api/gibdd/data?period=${latestPeriod}`, {credentials: 'include'}).then(r=>r.json());
    const filteredCurrentData = filterDataByMunicipality(currentData, filters.municipalityId);
    const currentTotals = filteredCurrentData.reduce((acc, row) => {
      acc.dtp += Number(row.dtp_total || 0);
      acc.dead += Number(row.dtp_total_dead || 0);
      acc.injured += Number(row.dtp_total_injured || 0);
      return acc;
    }, {dtp: 0, dead: 0, injured: 0});

    let prevTotals = {dtp: 0, dead: 0, injured: 0};
    try{
      const prevPeriod = `${Number(y)-1}-${m}`;
      const prevData = await fetch(`/api/gibdd/data?period=${prevPeriod}`, {credentials: 'include'}).then(r=>r.json());
      const filteredPrevData = filterDataByMunicipality(prevData, filters.municipalityId);
      prevTotals = filteredPrevData.reduce((acc, row) => {
        acc.dtp += Number(row.dtp_total || 0);
        acc.dead += Number(row.dtp_total_dead || 0);
        acc.injured += Number(row.dtp_total_injured || 0);
        return acc;
      }, {dtp: 0, dead: 0, injured: 0});
    }catch(e){}

    updateChart('chartPeriodComparison', {
      type: 'bar',
      data: {
        labels: ['–î–¢–ü', '–ü–æ–≥–∏–±–ª–æ', '–†–∞–Ω–µ–Ω–æ'],
        datasets: [
          {
            label: `${Number(y)-1} –≥–æ–¥`,
            data: [prevTotals.dtp, prevTotals.dead, prevTotals.injured],
            backgroundColor: '#6a7789'
          },
          {
            label: `${y} –≥–æ–¥`,
            data: [currentTotals.dtp, currentTotals.dead, currentTotals.injured],
            backgroundColor: '#2563eb'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {display: true, position: 'top', labels: {color: getThemeColors().textColor, padding: 15}},
          tooltip: {backgroundColor: getThemeColors().tooltipBg, padding: 12}
        },
        scales: {
          y: {beginAtZero: true, grid: {color: getThemeColors().gridColor}, ticks: {color: getThemeColors().textColor}},
          x: {grid: {display: false}, ticks: {color: getThemeColors().textColor}}
        }
      }
    });
  }catch(e){
    console.error('renderPeriodComparison:', e);
  }
}

// 3. –¢–û–ü-10 –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤ –ø–æ –î–¢–ü (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è —Å—Ç–æ–ª–±—á–∞—Ç–∞—è) —Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤
async function renderTopMunicipalities(){
  try{
    const filters = getFilters();
    const periods = await fetch('/api/gibdd/periods', {credentials: 'include'}).then(r=>r.json());
    const yearPeriods = periods.filter(p => p.period.startsWith(filters.year));

    if(yearPeriods.length === 0){
      updateChart('chartTopMunicipalities', {type: 'bar', data: {labels: [], datasets: []}});
      return;
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–∏–æ–¥
    let latestPeriod;
    if (filters.month) {
      latestPeriod = `${filters.year}-${filters.month}`;
    } else {
      latestPeriod = yearPeriods[0].period;
    }

    const data = await fetch(`/api/gibdd/data?period=${latestPeriod}`, {credentials: 'include'}).then(r=>r.json());

    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ–≥–æ
    const filteredData = filterDataByMunicipality(data, filters.municipalityId);

    const sorted = filteredData
      .map(row => ({name: row.municipality_name, dtp: Number(row.dtp_total || 0)}))
      .sort((a, b) => b.dtp - a.dtp)
      .slice(0, 10);

    updateChart('chartTopMunicipalities', {
      type: 'bar',
      data: {
        labels: sorted.map(x => x.name),
        datasets: [{
          label: '–î–¢–ü',
          data: sorted.map(x => x.dtp),
          backgroundColor: '#8b5cf6'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        indexAxis: 'y',
        plugins: {
          legend: {display: false},
          tooltip: {backgroundColor: getThemeColors().tooltipBg, padding: 12}
        },
        scales: {
          x: {beginAtZero: true, grid: {color: getThemeColors().gridColor}, ticks: {color: getThemeColors().textColor}},
          y: {grid: {display: false}, ticks: {color: getThemeColors().textColor, font: {size: 11}}}
        }
      }
    });
  }catch(e){
    console.error('renderTopMunicipalities:', e);
  }
}

/* ========== –≠—Ç–∞–ø 3: –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ (pie/donut charts) ========== */

async function renderAccidentCategories(){
  try {
    const filters = getFilters();
    const yearPeriods = await fetch(`/api/gibdd/periods`, {credentials: 'include'}).then(r=>r.json());
    if(!yearPeriods || yearPeriods.length === 0) return;

    let latestPeriod;
    if (filters.month) {
      latestPeriod = `${filters.year}-${filters.month}`;
    } else {
      const yearPeriods2 = yearPeriods.filter(p => p.period.startsWith(filters.year));
      if (yearPeriods2.length === 0) return;
      latestPeriod = yearPeriods2[0].period;
    }

    const data = await fetch(`/api/gibdd/data?period=${latestPeriod}`, {credentials: 'include'}).then(r=>r.json());
    const filteredData = filterDataByMunicipality(data, filters.municipalityId);

    const totals = filteredData.reduce((acc, row) => {
      acc.pedestrians += Number(row.dtp_pedestrians || 0);
      acc.driversViolation += Number(row.dtp_drivers_violation || 0);
      acc.oncomingLane += Number(row.dtp_oncoming_lane || 0);
      acc.hitAndRun += Number(row.dtp_hit_and_run || 0);
      acc.photoRadar += Number(row.dtp_photo_radar || 0);
      return acc;
    }, {pedestrians: 0, driversViolation: 0, oncomingLane: 0, hitAndRun: 0, photoRadar: 0});

    updateChart('chartAccidentCategories', {
      type: 'pie',
      data: {
        labels: ['–ü–µ—à–µ—Ö–æ–¥—ã', '–ù–∞—Ä—É—à–µ–Ω–∏—è –≤–æ–¥–∏—Ç–µ–ª–µ–π', '–í—Å—Ç—Ä–µ—á–Ω–∞—è –ø–æ–ª–æ—Å–∞', '–°–∫—Ä—ã–≤—à–∏–µ—Å—è –¢–°', '–§–æ—Ç–æ—Ñ–∏–∫—Å–∞—Ü–∏—è'],
        datasets: [{
          data: [
            totals.pedestrians,
            totals.driversViolation,
            totals.oncomingLane,
            totals.hitAndRun,
            totals.photoRadar
          ],
          backgroundColor: [
            '#3b82f6', // blue
            '#ef4444', // red
            '#f59e0b', // orange
            '#8b5cf6', // purple
            '#10b981'  // green
          ],
          borderColor: 'transparent',
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            display: true,
            position: 'bottom',
            labels: {color: getThemeColors().textColor, padding: 15, font: {size: 12}}
          },
          tooltip: {
            backgroundColor: getThemeColors().tooltipBg,
            padding: 12,
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                return `${label}: ${value} (${percentage}%)`;
              }
            }
          }
        }
      }
    });
  }catch(e){
    console.error('renderAccidentCategories:', e);
  }
}

async function renderAccidentLocations(){
  try {
    const filters = getFilters();
    const yearPeriods = await fetch(`/api/gibdd/periods`, {credentials: 'include'}).then(r=>r.json());
    if(!yearPeriods || yearPeriods.length === 0) return;

    let latestPeriod;
    if (filters.month) {
      latestPeriod = `${filters.year}-${filters.month}`;
    } else {
      const yearPeriods2 = yearPeriods.filter(p => p.period.startsWith(filters.year));
      if (yearPeriods2.length === 0) return;
      latestPeriod = yearPeriods2[0].period;
    }

    const data = await fetch(`/api/gibdd/data?period=${latestPeriod}`, {credentials: 'include'}).then(r=>r.json());
    const filteredData = filterDataByMunicipality(data, filters.municipalityId);

    const totals = filteredData.reduce((acc, row) => {
      acc.inSettlements += Number(row.dtp_in_settlements || 0);
      acc.onHighways += Number(row.dtp_on_highways || 0);
      acc.outsideSettlements += Number(row.dtp_outside_settlements || 0);
      acc.railwayCrossings += Number(row.dtp_railway_crossings || 0);
      return acc;
    }, {inSettlements: 0, onHighways: 0, outsideSettlements: 0, railwayCrossings: 0});

    updateChart('chartAccidentLocations', {
      type: 'doughnut',
      data: {
        labels: ['–í –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–∞—Ö', '–ù–∞ –∞–≤—Ç–æ–¥–æ—Ä–æ–≥–∞—Ö', '–í–Ω–µ –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤', '–ñ/–¥ –ø–µ—Ä–µ–µ–∑–¥—ã'],
        datasets: [{
          data: [
            totals.inSettlements,
            totals.onHighways,
            totals.outsideSettlements,
            totals.railwayCrossings
          ],
          backgroundColor: [
            '#2563eb', // blue
            '#f59e0b', // orange
            '#8b5cf6', // purple
            '#ef4444'  // red
          ],
          borderColor: 'transparent',
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            display: true,
            position: 'bottom',
            labels: {color: getThemeColors().textColor, padding: 15, font: {size: 12}}
          },
          tooltip: {
            backgroundColor: getThemeColors().tooltipBg,
            padding: 12,
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                return `${label}: ${value} (${percentage}%)`;
              }
            }
          }
        }
      }
    });
  }catch(e){
    console.error('renderAccidentLocations:', e);
  }
}

async function renderVictimsByAge(){
  try {
    const filters = getFilters();
    const yearPeriods = await fetch(`/api/gibdd/periods`, {credentials: 'include'}).then(r=>r.json());
    if(!yearPeriods || yearPeriods.length === 0) return;

    let latestPeriod;
    if (filters.month) {
      latestPeriod = `${filters.year}-${filters.month}`;
    } else {
      const yearPeriods2 = yearPeriods.filter(p => p.period.startsWith(filters.year));
      if (yearPeriods2.length === 0) return;
      latestPeriod = yearPeriods2[0].period;
    }

    const data = await fetch(`/api/gibdd/data?period=${latestPeriod}`, {credentials: 'include'}).then(r=>r.json());
    const filteredData = filterDataByMunicipality(data, filters.municipalityId);

    const totals = filteredData.reduce((acc, row) => {
      acc.children16Dead += Number(row.dtp_children_16_dead || 0);
      acc.children16Injured += Number(row.dtp_children_16_injured || 0);
      acc.children18Dead += Number(row.dtp_children_18_dead || 0);
      acc.children18Injured += Number(row.dtp_children_18_injured || 0);
      acc.totalDead += Number(row.dtp_total_dead || 0);
      acc.totalInjured += Number(row.dtp_total_injured || 0);
      return acc;
    }, {children16Dead: 0, children16Injured: 0, children18Dead: 0, children18Injured: 0, totalDead: 0, totalInjured: 0});

    const adults = {
      dead: totals.totalDead - totals.children18Dead,
      injured: totals.totalInjured - totals.children18Injured
    };

    updateChart('chartVictimsByAge', {
      type: 'bar',
      data: {
        labels: ['–î–µ—Ç–∏ –¥–æ 16 –ª–µ—Ç', '–î–µ—Ç–∏ –¥–æ 18 –ª–µ—Ç', '–í–∑—Ä–æ—Å–ª—ã–µ'],
        datasets: [
          {
            label: '–ü–æ–≥–∏–±–ª–æ',
            data: [totals.children16Dead, totals.children18Dead, adults.dead],
            backgroundColor: '#ef4444',
            borderColor: '#dc2626',
            borderWidth: 1
          },
          {
            label: '–†–∞–Ω–µ–Ω–æ',
            data: [totals.children16Injured, totals.children18Injured, adults.injured],
            backgroundColor: '#f59e0b',
            borderColor: '#d97706',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {color: getThemeColors().textColor, padding: 15}
          },
          tooltip: {backgroundColor: getThemeColors().tooltipBg, padding: 12}
        },
        scales: {
          x: {grid: {display: false}, ticks: {color: getThemeColors().textColor}},
          y: {beginAtZero: true, grid: {color: getThemeColors().gridColor}, ticks: {color: getThemeColors().textColor}}
        }
      }
    });
  }catch(e){
    console.error('renderVictimsByAge:', e);
  }
}

async function renderSpecialCases(){
  try {
    const filters = getFilters();
    const yearPeriods = await fetch(`/api/gibdd/periods`, {credentials: 'include'}).then(r=>r.json());
    if(!yearPeriods || yearPeriods.length === 0) return;

    let latestPeriod;
    if (filters.month) {
      latestPeriod = `${filters.year}-${filters.month}`;
    } else {
      const yearPeriods2 = yearPeriods.filter(p => p.period.startsWith(filters.year));
      if (yearPeriods2.length === 0) return;
      latestPeriod = yearPeriods2[0].period;
    }

    const data = await fetch(`/api/gibdd/data?period=${latestPeriod}`, {credentials: 'include'}).then(r=>r.json());
    const filteredData = filterDataByMunicipality(data, filters.municipalityId);

    const totals = filteredData.reduce((acc, row) => {
      acc.hitAndRun += Number(row.dtp_hit_and_run || 0);
      acc.driverFled += Number(row.dtp_driver_fled || 0);
      acc.unknownVehicle += Number(row.dtp_unknown_vehicle || 0);
      acc.photoRadar += Number(row.dtp_photo_radar || 0);
      return acc;
    }, {hitAndRun: 0, driverFled: 0, unknownVehicle: 0, photoRadar: 0});

    updateChart('chartSpecialCases', {
      type: 'doughnut',
      data: {
        labels: ['–°–∫—Ä—ã–≤—à–∏–µ—Å—è –¢–°', '–°–∫—Ä—ã–≤—à–∏–π—Å—è –≤–æ–¥–∏—Ç–µ–ª—å', '–ù–µ—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¢–°', '–° —Ñ–æ—Ç–æ—Ñ–∏–∫—Å–∞—Ü–∏–µ–π'],
        datasets: [{
          data: [
            totals.hitAndRun,
            totals.driverFled,
            totals.unknownVehicle,
            totals.photoRadar
          ],
          backgroundColor: [
            '#ef4444', // red
            '#f59e0b', // orange
            '#8b5cf6', // purple
            '#10b981'  // green
          ],
          borderColor: 'transparent',
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            display: true,
            position: 'bottom',
            labels: {color: getThemeColors().textColor, padding: 15, font: {size: 12}}
          },
          tooltip: {
            backgroundColor: getThemeColors().tooltipBg,
            padding: 12,
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                return `${label}: ${value} (${percentage}%)`;
              }
            }
          }
        }
      }
    });
  }catch(e){
    console.error('renderSpecialCases:', e);
  }
}

/* ========== –£–°–õ–£–ì–ò: –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö ========== */

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–£—Å–ª—É–≥–∏"
async function loadServicesData() {
  try {
    showBanner('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥...', true);
    const filters = getFilters();

    const params = new URLSearchParams({
      year: filters.year,
      ...(filters.month && { month: filters.month }),
      ...(filters.municipalityId && { municipality_id: filters.municipalityId })
    });

    const response = await fetch(`/api/services-dashboard/data?${params}`, {
      credentials: 'include'
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();

    // –û–±–Ω–æ–≤–ª—è–µ–º KPI
    updateServicesKPI(data.kpi);

    // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
    renderServicesMonthlyDynamics(data.monthly_dynamics);
    renderTopServices(data.top_services);
    renderServicesCategories(data.categories);
    renderServicesMunicipalities(data.top_municipalities);

    showBanner('');
  } catch (e) {
    console.error('loadServicesData:', e);
    showBanner('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥');

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    updateKPI('kpi-services-total', '-', null);
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ KPI –¥–ª—è —É—Å–ª—É–≥
function updateServicesKPI(kpi) {
  if (!kpi) return;

  const current = kpi.total_services || 0;
  const previous = kpi.prev_total_services || 0;

  updateKPI('kpi-services-total', current, previous);
}

// –ì—Ä–∞—Ñ–∏–∫: –î–∏–Ω–∞–º–∏–∫–∞ —É—Å–ª—É–≥ –ø–æ –º–µ—Å—è—Ü–∞–º (–ª–∏–Ω–µ–π–Ω—ã–π)
function renderServicesMonthlyDynamics(monthlyData) {
  if (!monthlyData || monthlyData.length === 0) {
    updateChart('chartServicesMonthly', {
      type: 'line',
      data: { labels: [], datasets: [] }
    });
    return;
  }

  const labels = ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω', '–ò—é–ª', '–ê–≤–≥', '–°–µ–Ω', '–û–∫—Ç', '–ù–æ—è', '–î–µ–∫'];
  const values = monthlyData.map(m => m.total);

  updateChart('chartServicesMonthly', {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: '–£—Å–ª—É–≥ –æ–∫–∞–∑–∞–Ω–æ',
        data: values,
        borderColor: '#2563eb',
        backgroundColor: 'rgba(37, 99, 235, 0.1)',
        tension: 0.4,
        fill: true,
        pointRadius: 4,
        pointHoverRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: true, position: 'top', labels: { color: getThemeColors().textColor, padding: 15 } },
        tooltip: { backgroundColor: getThemeColors().tooltipBg, padding: 12 }
      },
      scales: {
        y: { beginAtZero: true, grid: { display: false }, ticks: { color: getThemeColors().textColor } },
        x: { grid: { display: false }, ticks: { color: getThemeColors().textColor } }
      }
    }
  });
}

// –ì—Ä–∞—Ñ–∏–∫: –¢–û–ü-10 –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —É—Å–ª—É–≥ (—Å—Ç–æ–ª–±—á–∞—Ç—ã–π)
function renderTopServices(topServices) {
  if (!topServices || topServices.length === 0) {
    updateChart('chartTopServices', {
      type: 'bar',
      data: { labels: [], datasets: [] }
    });
    return;
  }

  updateChart('chartTopServices', {
    type: 'bar',
    data: {
      labels: topServices.map(s => s.name.length > 30 ? s.name.substring(0, 30) + '...' : s.name),
      datasets: [{
        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
        data: topServices.map(s => s.total),
        backgroundColor: '#10b981'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: getThemeColors().tooltipBg,
          padding: 12,
          callbacks: {
            title: (items) => {
              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ –ø–æ–¥—Å–∫–∞–∑–∫–µ
              const index = items[0].dataIndex;
              return topServices[index].name;
            }
          }
        }
      },
      scales: {
        x: { grid: { display: false }, ticks: { color: getThemeColors().textColor } },
        y: { beginAtZero: true, grid: { color: getThemeColors().gridColor }, ticks: { color: getThemeColors().textColor } }
      }
    }
  });
}

// –ì—Ä–∞—Ñ–∏–∫: –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (–∫—Ä—É–≥–æ–≤–∞—è)
function renderServicesCategories(categories) {
  if (!categories || categories.length === 0) {
    updateChart('chartServicesCategories', {
      type: 'doughnut',
      data: { labels: [], datasets: [] }
    });
    return;
  }

  updateChart('chartServicesCategories', {
    type: 'doughnut',
    data: {
      labels: categories.map(c => c.category),
      datasets: [{
        data: categories.map(c => c.total),
        backgroundColor: [
          '#2563eb', // blue
          '#10b981', // green
          '#f59e0b', // orange
          '#8b5cf6', // purple
          '#ef4444', // red
          '#06b6d4', // cyan
          '#ec4899', // pink
          '#84cc16'  // lime
        ],
        borderColor: 'transparent',
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          display: true,
          position: 'right',
          labels: { color: getThemeColors().textColor, padding: 10 }
        },
        tooltip: { backgroundColor: getThemeColors().tooltipBg, padding: 12 }
      }
    }
  });
}

// –ì—Ä–∞—Ñ–∏–∫: –¢–û–ü-10 –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤ (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π bar)
function renderServicesMunicipalities(topMunicipalities) {
  if (!topMunicipalities || topMunicipalities.length === 0) {
    updateChart('chartServicesMunicipalities', {
      type: 'bar',
      data: { labels: [], datasets: [] }
    });
    return;
  }

  updateChart('chartServicesMunicipalities', {
    type: 'bar',
    data: {
      labels: topMunicipalities.map(m => m.name),
      datasets: [{
        label: '–£—Å–ª—É–≥ –æ–∫–∞–∑–∞–Ω–æ',
        data: topMunicipalities.map(m => m.total),
        backgroundColor: '#8b5cf6'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      indexAxis: 'y',
      plugins: {
        legend: { display: false },
        tooltip: { backgroundColor: getThemeColors().tooltipBg, padding: 12 }
      },
      scales: {
        x: { beginAtZero: true, grid: { color: getThemeColors().gridColor }, ticks: { color: getThemeColors().textColor } },
        y: { grid: { display: false }, ticks: { color: getThemeColors().textColor } }
      }
    }
  });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
fillYears();
loadMunicipalities();
const currentYear = new Date().getFullYear();
// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "–£—Å–ª—É–≥–∏")
loadServicesData();

/* ========== –≠—Ç–∞–ø 4: –≠–∫—Å–ø–æ—Ä—Ç –∏ –ø–µ—á–∞—Ç—å ========== */

// –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel (CSV —Ñ–æ—Ä–º–∞—Ç)
async function exportToExcel() {
  try {
    showBanner('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞...', true);
    const year = $('#year').value;
    const yearPeriods = await fetch(`/api/gibdd/periods`, {credentials: 'include'}).then(r=>r.json());

    if (!yearPeriods || yearPeriods.length === 0) {
      showBanner('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
      return;
    }

    const latestPeriod = yearPeriods[0].period;
    const data = await fetch(`/api/gibdd/data?period=${latestPeriod}`, {credentials: 'include'}).then(r=>r.json());

    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ CSV
    const headers = [
      '–ú—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç',
      '–î–¢–ü –≤—Å–µ–≥–æ', '–ü–æ–≥–∏–±–ª–æ', '–†–∞–Ω–µ–Ω–æ',
      '–ü–µ—à–µ—Ö–æ–¥—ã', '–ü–µ—à–µ—Ö–æ–¥—ã –ø–æ–≥–∏–±–ª–æ', '–ü–µ—à–µ—Ö–æ–¥—ã —Ä–∞–Ω–µ–Ω–æ',
      '–î–µ—Ç–∏ –¥–æ 16', '–î–µ—Ç–∏ –¥–æ 16 –ø–æ–≥–∏–±–ª–æ', '–î–µ—Ç–∏ –¥–æ 16 —Ä–∞–Ω–µ–Ω–æ',
      '–í –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–∞—Ö', '–ù–∞ –∞–≤—Ç–æ–¥–æ—Ä–æ–≥–∞—Ö', '–í–Ω–µ –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤',
      '–°–∫—Ä—ã–≤—à–∏–µ—Å—è –¢–°', '–°–∫—Ä—ã–≤—à–∏–π—Å—è –≤–æ–¥–∏—Ç–µ–ª—å', '–° —Ñ–æ—Ç–æ—Ñ–∏–∫—Å–∞—Ü–∏–µ–π'
    ];

    const rows = data.map(row => [
      row.municipality_name,
      row.dtp_total || 0,
      row.dtp_total_dead || 0,
      row.dtp_total_injured || 0,
      row.dtp_pedestrians || 0,
      row.dtp_pedestrians_dead || 0,
      row.dtp_pedestrians_injured || 0,
      row.dtp_children_16 || 0,
      row.dtp_children_16_dead || 0,
      row.dtp_children_16_injured || 0,
      row.dtp_in_settlements || 0,
      row.dtp_on_highways || 0,
      row.dtp_outside_settlements || 0,
      row.dtp_hit_and_run || 0,
      row.dtp_driver_fled || 0,
      row.dtp_photo_radar || 0
    ]);

    // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ CSV
    const csvContent = [
      headers.join(';'),
      ...rows.map(row => row.join(';'))
    ].join('\n');

    // BOM –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∏—Ä–∏–ª–ª–∏—Ü—ã –≤ Excel
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `gibdd_${latestPeriod}.csv`;
    link.click();

    showBanner('Excel —Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', true);
    setTimeout(() => showBanner(''), 2000);
  } catch (e) {
    console.error('exportToExcel:', e);
    showBanner('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel');
  }
}

// –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF
async function exportToPDF() {
  try {
    showBanner('–°–æ–∑–¥–∞–Ω–∏–µ PDF...', true);

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫
    if (!window.jspdf) {
      showBanner('–û—à–∏–±–∫–∞: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ jsPDF –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
      return;
    }
    if (!window.html2canvas) {
      showBanner('–û—à–∏–±–∫–∞: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ html2canvas –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
      return;
    }

    const { jsPDF } = window.jspdf;
    const year = $('#year').value;

    // –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
    const activeTab = document.querySelector('.tab-content.active');
    if (!activeTab) {
      showBanner('–û—à–∏–±–∫–∞: –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏');
      return;
    }

    // –ü–æ–ª—É—á–∞–µ–º —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ –∏–∑ CSS –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
    const bgColor = getComputedStyle(document.body).getPropertyValue('--bg-primary').trim();

    // –ó–∞—Ö–≤–∞—Ç —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
    const canvas = await html2canvas(activeTab, {
      scale: 2,
      backgroundColor: bgColor,
      logging: false,
      useCORS: true,
      allowTaint: true
    });

    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

    // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –±–æ–ª—å—à–µ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã, —Ä–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ
    const pageHeight = pdf.internal.pageSize.getHeight();
    let heightLeft = pdfHeight;
    let position = 0;

    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
    heightLeft -= pageHeight;

    while (heightLeft > 0) {
      position = heightLeft - pdfHeight;
      pdf.addPage();
      pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
      heightLeft -= pageHeight;
    }

    pdf.save(`dashboard_${year}.pdf`);

    showBanner('PDF —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω', true);
    setTimeout(() => showBanner(''), 2000);
  } catch (e) {
    console.error('exportToPDF:', e);
    showBanner('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è PDF: ' + e.message);
  }
}

// –ü–µ—á–∞—Ç—å –¥–∞—à–±–æ—Ä–¥–∞
function printDashboard() {
  // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –ø–µ—á–∞—Ç–∏
  const originalTitle = document.title;
  const year = $('#year').value;
  const month = $('#month').value;
  const monthNames = ['', '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];

  document.title = `–î–∞—à–±–æ—Ä–¥ - ${year}${month ? ' - ' + monthNames[parseInt(month)] : ''}`;

  window.print();

  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
  setTimeout(() => {
    document.title = originalTitle;
  }, 100);
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
function switchTab(tabName) {
  // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });

  // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
  document.querySelectorAll('.tab').forEach(btn => {
    btn.classList.remove('active');
  });

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
  const targetTab = document.getElementById(`tab-${tabName}`);
  if (targetTab) {
    targetTab.classList.add('active');
  }

  // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
  const targetBtn = document.querySelector(`.tab[data-tab="${tabName}"]`);
  if (targetBtn) {
    targetBtn.classList.add('active');
  }

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
  if (tabName === 'services') {
    loadServicesData();
  } else if (tabName === 'dtp') {
    loadKPIData();
    refreshDashboard();
  }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–∫–ª–∞–¥–æ–∫
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const tabName = tab.getAttribute('data-tab');
    switchTab(tabName);
  });
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
$('#year').addEventListener('change', ()=>{
  const activeTab = document.querySelector('.tab.active')?.getAttribute('data-tab');
  if (activeTab === 'services') {
    loadServicesData();
  } else if (activeTab === 'dtp') {
    loadKPIData();
    refreshDashboard();
  }
});

$('#month').addEventListener('change', ()=>{
  const activeTab = document.querySelector('.tab.active')?.getAttribute('data-tab');
  if (activeTab === 'services') {
    loadServicesData();
  } else if (activeTab === 'dtp') {
    loadKPIData();
    refreshDashboard();
  }
});

$('#municipality').addEventListener('change', ()=>{
  const activeTab = document.querySelector('.tab.active')?.getAttribute('data-tab');
  if (activeTab === 'services') {
    loadServicesData();
  } else if (activeTab === 'dtp') {
    loadKPIData();
    refreshDashboard();
  }
});

$('#btnExportExcel').addEventListener('click', exportToExcel);
$('#btnExportPDF').addEventListener('click', exportToPDF);
$('#btnPrint').addEventListener('click', printDashboard);

</script>
<script src="/theme.js"></script>
</body>
</html>
