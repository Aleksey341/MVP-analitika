<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–î–∞—à–±–æ—Ä–¥ - –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</title>
  <style>
    :root {
      color-scheme: dark light;
      --bg-primary: #0f1115;
      --bg-secondary: #1a1d24;
      --bg-tertiary: #232a36;
      --border: #2b3444;
      --text-primary: #e8eef7;
      --text-secondary: #9fb0c9;
      --text-muted: #6a7789;
      --accent-blue: #2563eb;
      --accent-blue-light: #8ab4ff;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg-primary);color:var(--text-primary)}
    header{position:sticky;top:0;z-index:100;background:var(--bg-primary);border-bottom:1px solid var(--border);padding:24px;max-width:1600px;margin:auto}
    main{max-width:1600px;margin:auto;padding:24px}
    h1{font-size:28px;margin-bottom:8px}
    .subtitle{color:var(--text-secondary);font-size:14px;margin:0 0 16px 0}
    a{color:var(--accent-blue-light);text-decoration:none} a:hover{text-decoration:underline}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .ctl{display:flex;flex-direction:column;gap:6px}
    select{background:var(--bg-primary);border:1px solid var(--border);border-radius:10px;color:var(--text-primary);padding:10px 12px;min-width:200px}
    .banner{background:#2a1620;border:1px solid #6a1b2a;color:#ffd6de;border-radius:10px;padding:12px;margin:12px 0;display:none}
    .banner.info{background:#1a2a30;border-color:#1b6a7a;color:#d6f0ff}

    /* KPI Cards */
    .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin:32px 0}
    .kpi-card{
      background:linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
      border:1px solid var(--border);
      border-radius:16px;
      padding:24px;
      position:relative;
      overflow:hidden;
      transition:transform 0.2s, box-shadow 0.2s;
    }
    .kpi-card:hover{transform:translateY(-4px);box-shadow:0 12px 24px rgba(0,0,0,0.4)}
    .kpi-card::before{
      content:'';
      position:absolute;
      top:0;
      right:0;
      width:100px;
      height:100px;
      background:radial-gradient(circle, rgba(37,99,235,0.1) 0%, transparent 70%);
      border-radius:50%;
    }
    .kpi-icon{font-size:32px;margin-bottom:12px;display:block}
    .kpi-label{color:var(--text-secondary);font-size:13px;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
    .kpi-value{font-size:36px;font-weight:700;color:var(--text-primary);margin-bottom:8px;font-variant-numeric:tabular-nums}
    .kpi-change{display:flex;align-items:center;gap:6px;font-size:14px;font-weight:600}
    .kpi-change.positive{color:var(--success)}
    .kpi-change.negative{color:var(--danger)}
    .kpi-change.neutral{color:var(--text-muted)}
    .kpi-arrow{font-size:18px}

    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin:24px 0}
    .stat-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;padding:20px}
    .stat-value{font-size:32px;font-weight:600;color:var(--accent-blue-light);margin:8px 0}
    .stat-label{color:var(--text-secondary);font-size:14px}
    .stat-change{font-size:12px;color:var(--success)}
    .stat-change.negative{color:var(--danger)}

    .chart-container{background:#1a1d24;border:1px solid #2b3444;border-radius:12px;padding:20px;margin:16px 0}
    .chart-title{font-size:18px;font-weight:600;margin-bottom:16px;color:#e8eef7}
    canvas{max-height:300px}

    table{width:100%;border-collapse:collapse;background:#1a1d24;border:1px solid #2b3444;border-radius:12px;overflow:hidden}
    th{background:#232a36;padding:12px;text-align:left;color:#a7b3c6;font-weight:600;font-size:13px;text-transform:uppercase;letter-spacing:0.5px}
    td{padding:12px;border-top:1px solid #2b3444}
    tr:hover{background:#1e2430}
    .badge{display:inline-block;padding:4px 12px;border-radius:12px;font-size:11px;font-weight:500}
    .badge.new{background:#1a3a1a;color:#6fb36f}
    .badge.updated{background:#1a2a3a;color:#6fa3bf}

    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:24px}
    @media(max-width:900px){.grid-2{grid-template-columns:1fr}}

    .loading{text-align:center;padding:40px;color:#9fb0c9}
    .empty{text-align:center;padding:40px;color:#6a7789}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header>
  <a href="/">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
  <h1>üìä –û–±—â–∏–π –¥–∞—à–±–æ—Ä–¥ –õ–∏–ø–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏</h1>
  <p class="subtitle">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º –∏ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–∞–º</p>
  <div id="banner" class="banner"></div>

  <div class="row" style="margin-top:16px">
    <div class="ctl">
      <label for="year">–ì–æ–¥</label>
      <select id="year"></select>
    </div>

    <div class="ctl">
      <label for="municipality">–ú—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç</label>
      <select id="municipality">
        <option value="">–í—Å–µ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç—ã</option>
      </select>
    </div>

    <div class="ctl">
      <label for="cat">–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É—Å–ª—É–≥</label>
      <select id="cat">
        <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
      </select>
    </div>

    <div class="ctl">
      <label for="service">–£—Å–ª—É–≥–∞</label>
      <select id="service" disabled>
        <option value="">–í—Å–µ —É—Å–ª—É–≥–∏</option>
      </select>
    </div>
  </div>
</header>

<main>
  <!-- KPI Cards -->
  <div class="kpi-grid">
    <div class="kpi-card">
      <span class="kpi-icon">üöó</span>
      <div class="kpi-label">–î–¢–ü (–≤—Å–µ–≥–æ)</div>
      <div class="kpi-value" id="kpi-dtp">-</div>
      <div class="kpi-change neutral" id="kpi-dtp-change">
        <span class="kpi-arrow">‚Üí</span>
        <span>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
      </div>
    </div>

    <div class="kpi-card">
      <span class="kpi-icon">‚ö†Ô∏è</span>
      <div class="kpi-label">–ü–æ–≥–∏–±–ª–æ</div>
      <div class="kpi-value" id="kpi-dead">-</div>
      <div class="kpi-change neutral" id="kpi-dead-change">
        <span class="kpi-arrow">‚Üí</span>
        <span>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
      </div>
    </div>

    <div class="kpi-card">
      <span class="kpi-icon">üè•</span>
      <div class="kpi-label">–†–∞–Ω–µ–Ω–æ</div>
      <div class="kpi-value" id="kpi-injured">-</div>
      <div class="kpi-change neutral" id="kpi-injured-change">
        <span class="kpi-arrow">‚Üí</span>
        <span>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
      </div>
    </div>

    <div class="kpi-card">
      <span class="kpi-icon">üìã</span>
      <div class="kpi-label">–£—Å–ª—É–≥ –æ–∫–∞–∑–∞–Ω–æ</div>
      <div class="kpi-value" id="kpi-services">-</div>
      <div class="kpi-change neutral" id="kpi-services-change">
        <span class="kpi-arrow">‚Üí</span>
        <span>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
      </div>
    </div>
  </div>

  <!-- –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º (–ª–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫) -->
  <div class="chart-container">
    <div class="chart-title">üìà –î–∏–Ω–∞–º–∏–∫–∞ –î–¢–ü –∏ –ø–æ—Å—Ç—Ä–∞–¥–∞–≤—à–∏—Ö –ø–æ –º–µ—Å—è—Ü–∞–º</div>
    <canvas id="chartMonthlyDynamics"></canvas>
  </div>

  <!-- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–æ–≤ –∏ –¢–û–ü —Ä–∞–π–æ–Ω–æ–≤ -->
  <div class="grid-2">
    <div class="chart-container">
      <div class="chart-title">üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–æ–≤ (–≥–æ–¥ –∫ –≥–æ–¥—É)</div>
      <canvas id="chartPeriodComparison"></canvas>
    </div>

    <div class="chart-container">
      <div class="chart-title">üèõÔ∏è –¢–û–ü-10 –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤ –ø–æ –î–¢–ü</div>
      <canvas id="chartTopMunicipalities"></canvas>
    </div>
  </div>
</main>

<script>
const $ = s => document.querySelector(s);
const banner = $('#banner');
function showBanner(msg, isInfo){
  if(!msg){banner.style.display='none'; return;}
  banner.textContent = msg;
  banner.className = isInfo ? 'banner info' : 'banner';
  banner.style.display='block';
}

let charts = {};

// –£—Ç–∏–ª–∏—Ç—ã
function escapeHtml(s){return (s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function formatNum(n){return Number(n||0).toLocaleString('ru-RU')}
function formatDate(d){return new Date(d).toLocaleDateString('ru-RU')}

// –ó–∞–≥—Ä—É–∑–∫–∞ KPI-–¥–∞–Ω–Ω—ã—Ö
async function loadKPIData(year){
  try{
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ì–ò–ë–î–î –∑–∞ —Ç–µ–∫—É—â–∏–π –∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥–æ–¥
    const currentYearPeriods = await fetch(`/api/gibdd/periods`, {credentials: 'include'}).then(r=>r.json());

    if(currentYearPeriods.length === 0){
      updateKPI('kpi-dtp', '-', null);
      updateKPI('kpi-dead', '-', null);
      updateKPI('kpi-injured', '-', null);
      updateKPI('kpi-services', '-', null);
      return;
    }

    // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –ø–µ—Ä–∏–æ–¥
    const latestPeriod = currentYearPeriods[0].period;
    const gibddData = await fetch(`/api/gibdd/data?period=${latestPeriod}`, {credentials: 'include'}).then(r=>r.json());

    // –ü–æ–¥—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤ –ø–æ –ì–ò–ë–î–î
    const totals = gibddData.reduce((acc, row) => {
      acc.dtp += Number(row.dtp_total || 0);
      acc.dead += Number(row.dtp_total_dead || 0);
      acc.injured += Number(row.dtp_total_injured || 0);
      return acc;
    }, {dtp: 0, dead: 0, injured: 0});

    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≥–æ–¥–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    const [y, m] = latestPeriod.split('-');
    const prevYear = Number(y) - 1;
    const prevPeriod = `${prevYear}-${m}`;

    let prevTotals = {dtp: 0, dead: 0, injured: 0};
    try{
      const prevData = await fetch(`/api/gibdd/data?period=${prevPeriod}`, {credentials: 'include'}).then(r=>r.json());
      prevTotals = prevData.reduce((acc, row) => {
        acc.dtp += Number(row.dtp_total || 0);
        acc.dead += Number(row.dtp_total_dead || 0);
        acc.injured += Number(row.dtp_total_injured || 0);
        return acc;
      }, {dtp: 0, dead: 0, injured: 0});
    }catch(e){
      console.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥–æ–¥');
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ KPI-–∫–∞—Ä—Ç–æ—á–µ–∫
    updateKPI('kpi-dtp', totals.dtp, prevTotals.dtp);
    updateKPI('kpi-dead', totals.dead, prevTotals.dead);
    updateKPI('kpi-injured', totals.injured, prevTotals.injured);

    // –ü–æ–¥—Å—á–µ—Ç —É—Å–ª—É–≥ (–∑–∞–≥–ª—É—à–∫–∞, –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å)
    updateKPI('kpi-services', '-', null);

  }catch(e){
    console.error('loadKPIData:', e);
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–π KPI-–∫–∞—Ä—Ç–æ—á–∫–∏
function updateKPI(id, current, previous){
  const valueEl = $('#'+id);
  const changeEl = $('#'+id+'-change');

  valueEl.textContent = formatNum(current);

  if(previous === null || previous === undefined || current === '-'){
    changeEl.className = 'kpi-change neutral';
    changeEl.innerHTML = '<span class="kpi-arrow">‚Üí</span><span>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>';
    return;
  }

  const change = current - previous;
  const changePercent = previous > 0 ? ((change / previous) * 100).toFixed(1) : 0;

  if(change > 0){
    changeEl.className = 'kpi-change negative'; // –î–ª—è –î–¢–ü —Ä–æ—Å—Ç - —ç—Ç–æ –ø–ª–æ—Ö–æ
    changeEl.innerHTML = `<span class="kpi-arrow">‚ñ≤</span><span>+${changePercent}% (+${formatNum(change)})</span>`;
  }else if(change < 0){
    changeEl.className = 'kpi-change positive'; // –î–ª—è –î–¢–ü —Å–Ω–∏–∂–µ–Ω–∏–µ - —ç—Ç–æ —Ö–æ—Ä–æ—à–æ
    changeEl.innerHTML = `<span class="kpi-arrow">‚ñº</span><span>${changePercent}% (${formatNum(change)})</span>`;
  }else{
    changeEl.className = 'kpi-change neutral';
    changeEl.innerHTML = '<span class="kpi-arrow">‚Üí</span><span>–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π</span>';
  }
}

// –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≥–æ–¥–∞
function fillYears(){
  const now = new Date().getFullYear();
  const sel = $('#year'); sel.innerHTML = '';
  for (let y=now-3; y<=now+1; y++){
    const o = document.createElement('option');
    o.value = o.textContent = y;
    if (y===now) o.selected = true;
    sel.appendChild(o);
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤
async function loadMunicipalities(){
  try{
    const r = await fetch('/api/municipalities');
    if(!r.ok) throw new Error('HTTP '+r.status);
    const rows = await r.json();
    const sel = $('#municipality');
    sel.innerHTML = '<option value="">–í—Å–µ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç—ã</option>' +
      rows.map(x=>`<option value="${x.id}">${escapeHtml(x.name)}</option>`).join('');
  }catch(e){
    console.error('loadMunicipalities:', e);
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
async function loadCategories(){
  try{
    const r = await fetch('/api/service-categories');
    if(!r.ok) throw new Error('HTTP '+r.status);
    const rows = await r.json();
    const sel = $('#cat');
    sel.innerHTML = '<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>' +
      rows.map(x=>`<option value="${escapeHtml(x.category)}">${escapeHtml(x.category)} (${x.cnt})</option>`).join('');
  }catch(e){
    console.error('loadCategories:', e);
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —É—Å–ª—É–≥ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
async function loadServices(cat){
  try{
    const r = await fetch('/api/services' + (cat ? `?category=${encodeURIComponent(cat)}` : ''));
    if(!r.ok) throw new Error('HTTP '+r.status);
    const rows = await r.json();
    const sel = $('#service');
    sel.innerHTML = '<option value="">–í—Å–µ —É—Å–ª—É–≥–∏</option>' +
      rows.map(x=>`<option value="${x.id}">${escapeHtml(x.name)}</option>`).join('');
    sel.disabled = false;
  }catch(e){
    console.error('loadServices:', e);
    $('#service').innerHTML = '<option value="">–í—Å–µ —É—Å–ª—É–≥–∏</option>';
    $('#service').disabled = true;
  }
}

// –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
function updateChart(id, config){
  if(charts[id]) charts[id].destroy();
  charts[id] = new Chart($('#'+id).getContext('2d'), config);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
async function refreshDashboard(){
  const year = $('#year').value;
  showBanner('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...', true);

  try{
    await renderMonthlyDynamics(year);
    await renderPeriodComparison(year);
    await renderTopMunicipalities(year);
    showBanner('');
  }catch(e){
    console.error(e);
    showBanner('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
  }
}

// === –≠–¢–ê–ü 2: –õ–ò–ù–ï–ô–ù–´–ï –ì–†–ê–§–ò–ö–ò –î–ò–ù–ê–ú–ò–ö–ò ===

// 1. –î–∏–Ω–∞–º–∏–∫–∞ –î–¢–ü –ø–æ –º–µ—Å—è—Ü–∞–º (–º—É–ª—å—Ç–∏–ª–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫)
async function renderMonthlyDynamics(year){
  try{
    const periods = await fetch('/api/gibdd/periods', {credentials: 'include'}).then(r=>r.json());
    const yearPeriods = periods.filter(p => p.period.startsWith(year));

    if(yearPeriods.length === 0){
      updateChart('chartMonthlyDynamics', {type: 'line', data: {labels: [], datasets: []}});
      return;
    }

    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—Å–µ–º –º–µ—Å—è—Ü–∞–º –≥–æ–¥–∞
    const monthlyData = {dtp: [], dead: [], injured: []};
    const labels = [];

    for(let m = 1; m <= 12; m++){
      const period = `${year}-${String(m).padStart(2, '0')}`;
      labels.push(['–Ø–Ω–≤','–§–µ–≤','–ú–∞—Ä','–ê–ø—Ä','–ú–∞–π','–ò—é–Ω','–ò—é–ª','–ê–≤–≥','–°–µ–Ω','–û–∫—Ç','–ù–æ—è','–î–µ–∫'][m-1]);

      try{
        const data = await fetch(`/api/gibdd/data?period=${period}`, {credentials: 'include'}).then(r=>r.json());
        const totals = data.reduce((acc, row) => {
          acc.dtp += Number(row.dtp_total || 0);
          acc.dead += Number(row.dtp_total_dead || 0);
          acc.injured += Number(row.dtp_total_injured || 0);
          return acc;
        }, {dtp: 0, dead: 0, injured: 0});

        monthlyData.dtp.push(totals.dtp);
        monthlyData.dead.push(totals.dead);
        monthlyData.injured.push(totals.injured);
      }catch(e){
        monthlyData.dtp.push(null);
        monthlyData.dead.push(null);
        monthlyData.injured.push(null);
      }
    }

    updateChart('chartMonthlyDynamics', {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: '–î–¢–ü',
            data: monthlyData.dtp,
            borderColor: '#2563eb',
            backgroundColor: 'rgba(37,99,235,0.1)',
            tension: 0.4,
            fill: true,
            borderWidth: 3
          },
          {
            label: '–ü–æ–≥–∏–±–ª–æ',
            data: monthlyData.dead,
            borderColor: '#ef4444',
            backgroundColor: 'rgba(239,68,68,0.1)',
            tension: 0.4,
            fill: true,
            borderWidth: 3
          },
          {
            label: '–†–∞–Ω–µ–Ω–æ',
            data: monthlyData.injured,
            borderColor: '#f59e0b',
            backgroundColor: 'rgba(245,158,11,0.1)',
            tension: 0.4,
            fill: true,
            borderWidth: 3
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        interaction: {mode: 'index', intersect: false},
        plugins: {
          legend: {display: true, position: 'top', labels: {color: '#9fb0c9', padding: 15, font: {size: 13}}},
          tooltip: {backgroundColor: 'rgba(0,0,0,0.8)', padding: 12, titleFont: {size: 14}, bodyFont: {size: 13}}
        },
        scales: {
          y: {beginAtZero: true, grid: {color: '#232a36'}, ticks: {color: '#9fb0c9'}},
          x: {grid: {color: '#232a36'}, ticks: {color: '#9fb0c9'}}
        }
      }
    });
  }catch(e){
    console.error('renderMonthlyDynamics:', e);
  }
}

// 2. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–æ–≤ (—Å—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ - —Ç–µ–∫—É—â–∏–π vs –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥–æ–¥)
async function renderPeriodComparison(year){
  try{
    const currentPeriods = await fetch('/api/gibdd/periods', {credentials: 'include'}).then(r=>r.json());
    const yearPeriods = currentPeriods.filter(p => p.period.startsWith(year));

    if(yearPeriods.length === 0){
      updateChart('chartPeriodComparison', {type: 'bar', data: {labels: [], datasets: []}});
      return;
    }

    // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –º–µ—Å—è—Ü
    const latestPeriod = yearPeriods[0].period;
    const [y, m] = latestPeriod.split('-');

    const currentData = await fetch(`/api/gibdd/data?period=${latestPeriod}`, {credentials: 'include'}).then(r=>r.json());
    const currentTotals = currentData.reduce((acc, row) => {
      acc.dtp += Number(row.dtp_total || 0);
      acc.dead += Number(row.dtp_total_dead || 0);
      acc.injured += Number(row.dtp_total_injured || 0);
      return acc;
    }, {dtp: 0, dead: 0, injured: 0});

    let prevTotals = {dtp: 0, dead: 0, injured: 0};
    try{
      const prevPeriod = `${Number(y)-1}-${m}`;
      const prevData = await fetch(`/api/gibdd/data?period=${prevPeriod}`, {credentials: 'include'}).then(r=>r.json());
      prevTotals = prevData.reduce((acc, row) => {
        acc.dtp += Number(row.dtp_total || 0);
        acc.dead += Number(row.dtp_total_dead || 0);
        acc.injured += Number(row.dtp_total_injured || 0);
        return acc;
      }, {dtp: 0, dead: 0, injured: 0});
    }catch(e){}

    updateChart('chartPeriodComparison', {
      type: 'bar',
      data: {
        labels: ['–î–¢–ü', '–ü–æ–≥–∏–±–ª–æ', '–†–∞–Ω–µ–Ω–æ'],
        datasets: [
          {
            label: `${Number(y)-1} –≥–æ–¥`,
            data: [prevTotals.dtp, prevTotals.dead, prevTotals.injured],
            backgroundColor: '#6a7789'
          },
          {
            label: `${y} –≥–æ–¥`,
            data: [currentTotals.dtp, currentTotals.dead, currentTotals.injured],
            backgroundColor: '#2563eb'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {display: true, position: 'top', labels: {color: '#9fb0c9', padding: 15}},
          tooltip: {backgroundColor: 'rgba(0,0,0,0.8)', padding: 12}
        },
        scales: {
          y: {beginAtZero: true, grid: {color: '#232a36'}, ticks: {color: '#9fb0c9'}},
          x: {grid: {display: false}, ticks: {color: '#9fb0c9'}}
        }
      }
    });
  }catch(e){
    console.error('renderPeriodComparison:', e);
  }
}

// 3. –¢–û–ü-10 –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤ –ø–æ –î–¢–ü (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è —Å—Ç–æ–ª–±—á–∞—Ç–∞—è)
async function renderTopMunicipalities(year){
  try{
    const periods = await fetch('/api/gibdd/periods', {credentials: 'include'}).then(r=>r.json());
    const yearPeriods = periods.filter(p => p.period.startsWith(year));

    if(yearPeriods.length === 0){
      updateChart('chartTopMunicipalities', {type: 'bar', data: {labels: [], datasets: []}});
      return;
    }

    const latestPeriod = yearPeriods[0].period;
    const data = await fetch(`/api/gibdd/data?period=${latestPeriod}`, {credentials: 'include'}).then(r=>r.json());

    const sorted = data
      .map(row => ({name: row.municipality_name, dtp: Number(row.dtp_total || 0)}))
      .sort((a, b) => b.dtp - a.dtp)
      .slice(0, 10);

    updateChart('chartTopMunicipalities', {
      type: 'bar',
      data: {
        labels: sorted.map(x => x.name),
        datasets: [{
          label: '–î–¢–ü',
          data: sorted.map(x => x.dtp),
          backgroundColor: '#8b5cf6'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        indexAxis: 'y',
        plugins: {
          legend: {display: false},
          tooltip: {backgroundColor: 'rgba(0,0,0,0.8)', padding: 12}
        },
        scales: {
          x: {beginAtZero: true, grid: {color: '#232a36'}, ticks: {color: '#9fb0c9'}},
          y: {grid: {display: false}, ticks: {color: '#9fb0c9', font: {size: 11}}}
        }
      }
    });
  }catch(e){
    console.error('renderTopMunicipalities:', e);
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
fillYears();
const currentYear = new Date().getFullYear();
loadKPIData(currentYear);
refreshDashboard();

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
$('#year').addEventListener('change', ()=>{
  const year = $('#year').value;
  loadKPIData(year);
  refreshDashboard();
});
</script>
</body>
</html>
