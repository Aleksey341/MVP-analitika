<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Дашборд</title>
  <style>
    :root { color-scheme: dark light; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:#0f1115;color:#e8eef7}
    header,main{max-width:1100px;margin:auto;padding:24px}
    a{color:#8ab4ff;text-decoration:none} a:hover{text-decoration:underline}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .ctl{display:flex;flex-direction:column;gap:6px}
    select{background:#0f1115;border:1px solid #2b3444;border-radius:10px;color:#e8eef7;padding:10px 12px;min-width:220px}
    .muted{color:#9fb0c9}
    .banner{background:#2a1620;border:1px solid #6a1b2a;color:#ffd6de;border-radius:10px;padding:12px;margin:12px 0;display:none}
    canvas{background:#0f1115;border:1px solid #232a36;border-radius:12px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header>
  <a href="/">← На главную</a>
  <h1>Дашборд</h1>
  <div id="banner" class="banner"></div>

  <div class="row" style="margin-top:8px">
    <div class="ctl">
      <label for="year">Год</label>
      <select id="year"></select>
    </div>

    <div class="ctl">
      <label for="cat">Категория услуг</label>
      <select id="cat">
        <option value="">Все категории</option>
      </select>
    </div>

    <div class="ctl">
      <label for="service">Услуга</label>
      <select id="service" disabled>
        <option value="">Все услуги</option>
      </select>
      <small class="muted">Заполняется после выбора категории.</small>
    </div>
  </div>
</header>

<main>
  <h3>Суммы по месяцам</h3>
  <canvas id="chart" height="120"></canvas>
</main>

<script>
const $ = s => document.querySelector(s);
const banner = $('#banner');
function showBanner(msg){ banner.textContent = msg||''; banner.style.display = msg ? 'block' : 'none'; }

const ctx = $('#chart').getContext('2d');
let chart;

function makeChart(byMonth){
  const labels = Array.from({length:12}, (_,i)=>String(i+1).padStart(2,'0'));
  const data = labels.map((_,i)=>{
    const row = byMonth.find(x=>Number(x.month)===i+1);
    // два варианта: старый эндпойнт отдаёт total_value, новый для услуги — total
    return row ? Number(row.total_value ?? row.total ?? 0) : 0;
  });
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label:'Итого', data }] },
    options: { responsive:true, plugins:{legend:{display:true}} }
  });
}

// год
function fillYears(){
  const now = new Date().getFullYear();
  const sel = $('#year'); sel.innerHTML = '';
  for (let y=now-3; y<=now+1; y++){
    const o = document.createElement('option');
    o.value = o.textContent = y; if (y===now) o.selected = true;
    sel.appendChild(o);
  }
}

// категории
async function loadCategories(){
  try{
    const r = await fetch('/api/service-categories');
    if(!r.ok) throw new Error('HTTP '+r.status);
    const rows = await r.json();
    const sel = $('#cat');
    sel.innerHTML = '<option value="">Все категории</option>' +
      rows.map(x=>`<option value="${escapeHtml(x.category)}">${escapeHtml(x.category)} (${x.cnt})</option>`).join('');
  }catch(e){
    console.info('Категории недоступны:', e);
  }
}

// услуги по категории
async function loadServices(cat){
  try{
    const r = await fetch('/api/services' + (cat ? `?category=${encodeURIComponent(cat)}` : ''));
    if(!r.ok) throw new Error('HTTP '+r.status);
    const rows = await r.json();
    const sel = $('#service');
    sel.innerHTML = '<option value="">Все услуги</option>' +
      rows.map(x=>`<option value="${x.id}">${escapeHtml(x.name)}</option>`).join('');
    sel.disabled = false;
  }catch(e){
    console.info('Список услуг недоступен:', e);
    $('#service').innerHTML = '<option value="">Все услуги</option>';
    $('#service').disabled = true;
  }
}

// данные для графика:
//  - если выбрана услуга → /api/services/:id/monthly?year=YYYY
//  - иначе (без услуги) → /api/dashboard/data?year=YYYY
async function refreshChart(){
  const year = $('#year').value;
  const serviceId = $('#service').value;

  try{
    let j;
    if (serviceId){
      const r = await fetch(`/api/services/${serviceId}/monthly?year=${encodeURIComponent(year)}`);
      if(!r.ok) throw new Error('HTTP '+r.status);
      j = await r.json();
      makeChart(j.byMonth || []);
    } else {
      const r = await fetch(`/api/dashboard/data?year=${encodeURIComponent(year)}`);
      if(!r.ok) throw new Error('HTTP '+r.status);
      j = await r.json();
      makeChart(j.byMonth || []);
    }
    showBanner('');
  }catch(e){
    console.error(e);
    showBanner('Ошибка загрузки данных');
  }
}

function escapeHtml(s){return (s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

// init
fillYears();
loadCategories().then(()=> loadServices($('#cat').value));
refreshChart();

// handlers
$('#year').addEventListener('change', refreshChart);
$('#cat').addEventListener('change', e=>{
  const cat = e.target.value;
  $('#service').value='';
  loadServices(cat).then(refreshChart);
});
$('#service').addEventListener('change', refreshChart);
</script>
</body>
</html>
