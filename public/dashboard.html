<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Дашборд</title>
  <style>
    :root { color-scheme: dark light; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:#0f1115;color:#e8eef7}
    header,main{max-width:1100px;margin:auto;padding:24px}
    a{color:#8ab4ff;text-decoration:none} a:hover{text-decoration:underline}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .ctl{display:flex;flex-direction:column;gap:6px}
    select{background:#0f1115;border:1px solid #2b3444;border-radius:10px;color:#e8eef7;padding:10px 12px;min-width:220px}
    .muted{color:#9fb0c9}
    .banner{background:#2a1620;border:1px solid #6a1b2a;color:#ffd6de;border-radius:10px;padding:12px;margin:12px 0;display:none}
    canvas{background:#0f1115;border:1px solid #232a36;border-radius:12px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header>
  <a href="/">← На главную</a>
  <h1>Дашборд</h1>
  <div id="banner" class="banner"></div>

  <div class="row" style="margin-top:8px">
    <div class="ctl">
      <label for="year">Год</label>
      <select id="year"></select>
    </div>

    <div class="ctl" id="services-wrap" style="display:none">
      <label for="service">Услуга</label>
      <select id="service">
        <option value="">Все услуги</option>
      </select>
      <small class="muted">Если список пуст — проверь, добавлен ли эндпойнт <code>/api/services</code> на сервере.</small>
    </div>
  </div>
</header>

<main>
  <h3>Суммы по месяцам</h3>
  <canvas id="chart" height="120"></canvas>
</main>

<script>
const $ = (s)=>document.querySelector(s);
const banner = $('#banner');
function showBanner(msg){ if(!msg){banner.style.display='none';return;} banner.textContent=msg; banner.style.display='block'; }

const ctx = $('#chart').getContext('2d');
let chart;

function makeChart(data){
  const labels = Array.from({length:12}, (_,i)=>String(i+1).padStart(2,'0'));
  const series = labels.map((_,i)=>{
    const f = data.find(x=>Number(x.month)===i+1);
    return f ? Number(f.total_value||0) : 0;
  });
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label:'Итого', data: series }] },
    options: { responsive:true, plugins:{ legend:{display:true} } }
  });
}

async function loadByYear(year){
  try{
    const r = await fetch(`/api/dashboard/data?year=${encodeURIComponent(year)}`);
    if(!r.ok) throw new Error('HTTP '+r.status);
    const j = await r.json();
    makeChart(j.byMonth || []);
    showBanner('');
  }catch(e){
    console.error(e);
    showBanner('Ошибка загрузки данных дашборда');
  }
}

function fillYears(){
  const now = new Date().getFullYear();
  const sel = $('#year');
  sel.innerHTML = '';
  for(let y=now-3; y<=now+1; y++){
    const opt = document.createElement('option');
    opt.value = opt.textContent = y;
    if(y===now) opt.selected = true;
    sel.appendChild(opt);
  }
}

/* ===== услуги (если есть эндпойнт /api/services) ===== */
async function tryLoadServices(){
  try{
    const r = await fetch('/api/services');   // эндпойнт должен быть добавлен в server.js
    if(!r.ok) throw new Error('HTTP '+r.status);
    const rows = await r.json();
    if(Array.isArray(rows) && rows.length){
      const wrap = $('#services-wrap');
      const sel = $('#service');
      sel.innerHTML = '<option value="">Все услуги</option>' +
        rows.map(x=>`<option value="${x.id}">${escapeHtml(x.name)}</option>`).join('');
      wrap.style.display = '';
    }
  }catch(e){
    // тихо игнорируем (UI просто не покажет блок услуг)
    console.info('Список услуг недоступен (добавь /api/services на сервере).', e);
  }
}

/* ===== init ===== */
function escapeHtml(s){ return (s??'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

fillYears();
loadByYear($('#year').value);
tryLoadServices();

$('#year').addEventListener('change', e=> loadByYear(e.target.value));
</script>
</body>
</html>
