<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–î–∞—à–±–æ—Ä–¥ - –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</title>
  <style>
    :root { color-scheme: dark light; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:#0f1115;color:#e8eef7}
    header{position:sticky;top:0;z-index:100;background:#0f1115;border-bottom:1px solid #232a36;padding:24px;max-width:1400px;margin:auto}
    main{max-width:1400px;margin:auto;padding:24px}
    a{color:#8ab4ff;text-decoration:none} a:hover{text-decoration:underline}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .ctl{display:flex;flex-direction:column;gap:6px}
    select{background:#0f1115;border:1px solid #2b3444;border-radius:10px;color:#e8eef7;padding:10px 12px;min-width:200px}
    .banner{background:#2a1620;border:1px solid #6a1b2a;color:#ffd6de;border-radius:10px;padding:12px;margin:12px 0;display:none}
    .banner.info{background:#1a2a30;border-color:#1b6a7a;color:#d6f0ff}

    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin:24px 0}
    .stat-card{background:#1a1d24;border:1px solid #2b3444;border-radius:12px;padding:20px}
    .stat-value{font-size:32px;font-weight:600;color:#8ab4ff;margin:8px 0}
    .stat-label{color:#9fb0c9;font-size:14px}
    .stat-change{font-size:12px;color:#6fb36f}
    .stat-change.negative{color:#f66}

    .chart-container{background:#1a1d24;border:1px solid #2b3444;border-radius:12px;padding:20px;margin:16px 0}
    .chart-title{font-size:18px;font-weight:600;margin-bottom:16px;color:#e8eef7}
    canvas{max-height:300px}

    table{width:100%;border-collapse:collapse;background:#1a1d24;border:1px solid #2b3444;border-radius:12px;overflow:hidden}
    th{background:#232a36;padding:12px;text-align:left;color:#a7b3c6;font-weight:600;font-size:13px;text-transform:uppercase;letter-spacing:0.5px}
    td{padding:12px;border-top:1px solid #2b3444}
    tr:hover{background:#1e2430}
    .badge{display:inline-block;padding:4px 12px;border-radius:12px;font-size:11px;font-weight:500}
    .badge.new{background:#1a3a1a;color:#6fb36f}
    .badge.updated{background:#1a2a3a;color:#6fa3bf}

    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:24px}
    @media(max-width:900px){.grid-2{grid-template-columns:1fr}}

    .loading{text-align:center;padding:40px;color:#9fb0c9}
    .empty{text-align:center;padding:40px;color:#6a7789}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header>
  <a href="/">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
  <h1>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —É—Å–ª—É–≥</h1>
  <div id="banner" class="banner"></div>

  <div class="row" style="margin-top:16px">
    <div class="ctl">
      <label for="year">–ì–æ–¥</label>
      <select id="year"></select>
    </div>

    <div class="ctl">
      <label for="municipality">–ú—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç</label>
      <select id="municipality">
        <option value="">–í—Å–µ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç—ã</option>
      </select>
    </div>

    <div class="ctl">
      <label for="cat">–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É—Å–ª—É–≥</label>
      <select id="cat">
        <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
      </select>
    </div>

    <div class="ctl">
      <label for="service">–£—Å–ª—É–≥–∞</label>
      <select id="service" disabled>
        <option value="">–í—Å–µ —É—Å–ª—É–≥–∏</option>
      </select>
    </div>
  </div>
</header>

<main>
  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="stats-grid" id="stats">
    <div class="stat-card">
      <div class="stat-label">–í—Å–µ–≥–æ —É—Å–ª—É–≥</div>
      <div class="stat-value" id="stat-total">-</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">–°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</div>
      <div class="stat-value" id="stat-avg">-</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">–ú–∞–∫—Å–∏–º—É–º</div>
      <div class="stat-value" id="stat-max">-</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">–ú—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤</div>
      <div class="stat-value" id="stat-municipalities">-</div>
    </div>
  </div>

  <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
  <div class="grid-2">
    <div class="chart-container">
      <div class="chart-title">üìà –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º</div>
      <canvas id="chartMonthly"></canvas>
    </div>

    <div class="chart-container">
      <div class="chart-title">üèõÔ∏è –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤</div>
      <canvas id="chartMunicipalities"></canvas>
    </div>
  </div>

  <div class="chart-container">
    <div class="chart-title">üìä –í—Å–µ —É—Å–ª—É–≥–∏ - —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è</div>
    <canvas id="chartServices"></canvas>
  </div>

  <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π -->
  <div class="chart-container">
    <div class="chart-title">üïê –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö</div>
    <div id="updatesTable">
      <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
  </div>
</main>

<script>
const $ = s => document.querySelector(s);
const banner = $('#banner');
function showBanner(msg, isInfo){
  if(!msg){banner.style.display='none'; return;}
  banner.textContent = msg;
  banner.className = isInfo ? 'banner info' : 'banner';
  banner.style.display='block';
}

let charts = {};

// –£—Ç–∏–ª–∏—Ç—ã
function escapeHtml(s){return (s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function formatNum(n){return Number(n||0).toLocaleString('ru-RU')}
function formatDate(d){return new Date(d).toLocaleDateString('ru-RU')}

// –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≥–æ–¥–∞
function fillYears(){
  const now = new Date().getFullYear();
  const sel = $('#year'); sel.innerHTML = '';
  for (let y=now-3; y<=now+1; y++){
    const o = document.createElement('option');
    o.value = o.textContent = y;
    if (y===now) o.selected = true;
    sel.appendChild(o);
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤
async function loadMunicipalities(){
  try{
    const r = await fetch('/api/municipalities');
    if(!r.ok) throw new Error('HTTP '+r.status);
    const rows = await r.json();
    const sel = $('#municipality');
    sel.innerHTML = '<option value="">–í—Å–µ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç—ã</option>' +
      rows.map(x=>`<option value="${x.id}">${escapeHtml(x.name)}</option>`).join('');
  }catch(e){
    console.error('loadMunicipalities:', e);
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
async function loadCategories(){
  try{
    const r = await fetch('/api/service-categories');
    if(!r.ok) throw new Error('HTTP '+r.status);
    const rows = await r.json();
    const sel = $('#cat');
    sel.innerHTML = '<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>' +
      rows.map(x=>`<option value="${escapeHtml(x.category)}">${escapeHtml(x.category)} (${x.cnt})</option>`).join('');
  }catch(e){
    console.error('loadCategories:', e);
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —É—Å–ª—É–≥ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
async function loadServices(cat){
  try{
    const r = await fetch('/api/services' + (cat ? `?category=${encodeURIComponent(cat)}` : ''));
    if(!r.ok) throw new Error('HTTP '+r.status);
    const rows = await r.json();
    const sel = $('#service');
    sel.innerHTML = '<option value="">–í—Å–µ —É—Å–ª—É–≥–∏</option>' +
      rows.map(x=>`<option value="${x.id}">${escapeHtml(x.name)}</option>`).join('');
    sel.disabled = false;
  }catch(e){
    console.error('loadServices:', e);
    $('#service').innerHTML = '<option value="">–í—Å–µ —É—Å–ª—É–≥–∏</option>';
    $('#service').disabled = true;
  }
}

// –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
function updateChart(id, config){
  if(charts[id]) charts[id].destroy();
  charts[id] = new Chart($('#'+id).getContext('2d'), config);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
async function refreshDashboard(){
  const year = $('#year').value;
  const municipalityId = $('#municipality').value;
  const serviceId = $('#service').value;

  showBanner('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...', true);

  try{
    // 1. –ì—Ä–∞—Ñ–∏–∫ –ø–æ –º–µ—Å—è—Ü–∞–º
    if(serviceId){
      const url = municipalityId
        ? `/api/services/${serviceId}/details?year=${year}`
        : `/api/services/${serviceId}/monthly?year=${year}`;
      const r = await fetch(url);
      const data = await r.json();

      if(municipalityId && data.rows){
        const filtered = data.rows.filter(x => x.municipality_id == municipalityId);
        const byMonth = Array.from({length:12}, (_,i)=>{
          const m = i+1;
          const row = filtered.find(x => x.period_month == m);
          return {month:m, total: row ? Number(row.value_numeric) : 0};
        });
        renderMonthlyChart(byMonth);
      } else if(data.byMonth){
        renderMonthlyChart(data.byMonth);
      }
    } else {
      const r = await fetch(`/api/dashboard/data?year=${year}`);
      const data = await r.json();
      renderMonthlyChart(data.byMonth || []);
    }

    // 2. –ì—Ä–∞—Ñ–∏–∫ –ø–æ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–∞–º (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ —É—Å–ª—É–≥–∞)
    if(serviceId){
      const r = await fetch(`/api/services/${serviceId}/details?year=${year}`);
      const data = await r.json();
      renderMunicipalitiesChart(data.rows || []);

      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
      updateStats(data.rows || []);
    } else {
      // –û—á–∏—Å—Ç–∏—Ç—å –µ—Å–ª–∏ —É—Å–ª—É–≥–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞
      if(charts.chartMunicipalities) charts.chartMunicipalities.destroy();
      $('#stat-total').textContent = '-';
      $('#stat-avg').textContent = '-';
      $('#stat-max').textContent = '-';
      $('#stat-municipalities').textContent = '-';
    }

    // 3. –ì—Ä–∞—Ñ–∏–∫ —Å—Ä–µ–¥–Ω–∏—Ö –ø–æ –≤—Å–µ–º —É—Å–ª—É–≥–∞–º
    await renderServicesAverages(year, municipalityId);

    // 4. –¢–∞–±–ª–∏—Ü–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
    await renderUpdatesTable(year, municipalityId, serviceId);

    showBanner('');
  }catch(e){
    console.error(e);
    showBanner('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
  }
}

// –ì—Ä–∞—Ñ–∏–∫ –ø–æ –º–µ—Å—è—Ü–∞–º
function renderMonthlyChart(byMonth){
  const labels = ['–Ø–Ω–≤','–§–µ–≤','–ú–∞—Ä','–ê–ø—Ä','–ú–∞–π','–ò—é–Ω','–ò—é–ª','–ê–≤–≥','–°–µ–Ω','–û–∫—Ç','–ù–æ—è','–î–µ–∫'];
  const data = labels.map((_,i)=>{
    const row = byMonth.find(x=>Number(x.month)===i+1);
    return row ? Number(row.total_value ?? row.total ?? 0) : 0;
  });

  updateChart('chartMonthly', {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
        data,
        borderColor: '#8ab4ff',
        backgroundColor: 'rgba(138,180,255,0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: { legend: {display: false} },
      scales: {
        y: {beginAtZero: true, grid:{color:'#232a36'}, ticks:{color:'#9fb0c9'}},
        x: {grid:{color:'#232a36'}, ticks:{color:'#9fb0c9'}}
      }
    }
  });
}

// –ì—Ä–∞—Ñ–∏–∫ –ø–æ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–∞–º
function renderMunicipalitiesChart(rows){
  const grouped = {};
  rows.forEach(r => {
    if(!grouped[r.name]) grouped[r.name] = 0;
    grouped[r.name] += Number(r.value_numeric || 0);
  });

  const sorted = Object.entries(grouped).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const labels = sorted.map(x=>x[0]);
  const data = sorted.map(x=>x[1]);

  updateChart('chartMunicipalities', {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: '–ò—Ç–æ–≥–æ',
        data,
        backgroundColor: '#6fa3bf',
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      indexAxis: 'y',
      plugins: { legend: {display: false} },
      scales: {
        x: {beginAtZero: true, grid:{color:'#232a36'}, ticks:{color:'#9fb0c9'}},
        y: {grid:{display:false}, ticks:{color:'#9fb0c9'}}
      }
    }
  });
}

// –°—Ä–µ–¥–Ω–∏–µ –ø–æ –≤—Å–µ–º —É—Å–ª—É–≥–∞–º
async function renderServicesAverages(year, municipalityId){
  try{
    const r = await fetch('/api/services');
    const services = await r.json();

    const averages = [];
    for(const svc of services.slice(0,15)){
      const dr = await fetch(`/api/services/${svc.id}/details?year=${year}`);
      const data = await dr.json();
      let rows = data.rows || [];
      if(municipalityId) rows = rows.filter(x => x.municipality_id == municipalityId);

      const sum = rows.reduce((s,x)=>s+Number(x.value_numeric||0), 0);
      const avg = rows.length ? sum/rows.length : 0;
      averages.push({name: svc.name, avg});
    }

    averages.sort((a,b)=>b.avg-a.avg);
    const labels = averages.map(x=>x.name.substring(0,30));
    const data = averages.map(x=>x.avg);

    updateChart('chartServices', {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: '–°—Ä–µ–¥–Ω–µ–µ',
          data,
          backgroundColor: '#6fb36f',
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: { legend: {display: false} },
        scales: {
          y: {beginAtZero: true, grid:{color:'#232a36'}, ticks:{color:'#9fb0c9'}},
          x: {grid:{color:'#232a36'}, ticks:{color:'#9fb0c9', maxRotation:45, minRotation:45}}
        }
      }
    });
  }catch(e){
    console.error('renderServicesAverages:', e);
  }
}

// –¢–∞–±–ª–∏—Ü–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
async function renderUpdatesTable(year, municipalityId, serviceId){
  try{
    // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ indicator_values
    const params = new URLSearchParams();
    params.append('year', year);
    if(municipalityId) params.append('municipality_id', municipalityId);
    if(serviceId) params.append('service_id', serviceId);

    const r = await fetch(`/api/dashboard/recent-updates?${params}`);
    const updates = await r.json();

    if(!updates || updates.length === 0){
      $('#updatesTable').innerHTML = '<div class="empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>';
      return;
    }

    const html = `
      <table>
        <thead>
          <tr>
            <th>–ú—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç</th>
            <th>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å/–£—Å–ª—É–≥–∞</th>
            <th>–ü–µ—Ä–∏–æ–¥</th>
            <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
            <th>–û–±–Ω–æ–≤–ª–µ–Ω–æ</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
          </tr>
        </thead>
        <tbody>
          ${updates.map(u=>`
            <tr>
              <td>${escapeHtml(u.municipality)}</td>
              <td>${escapeHtml(u.item_name)}</td>
              <td>${String(u.period_month).padStart(2,'0')}.${u.period_year}</td>
              <td>${formatNum(u.value)}</td>
              <td>${formatDate(u.updated_at)}</td>
              <td><span class="badge ${u.is_new ? 'new' : 'updated'}">${u.is_new ? '–ù–æ–≤—ã–π' : '–û–±–Ω–æ–≤–ª–µ–Ω'}</span></td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
    $('#updatesTable').innerHTML = html;
  }catch(e){
    console.error('renderUpdatesTable:', e);
    $('#updatesTable').innerHTML = '<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π</div>';
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function updateStats(rows){
  const values = rows.map(r=>Number(r.value_numeric||0));
  const total = values.reduce((s,v)=>s+v, 0);
  const avg = values.length ? total/values.length : 0;
  const max = values.length ? Math.max(...values) : 0;
  const municipalities = new Set(rows.map(r=>r.municipality_id)).size;

  $('#stat-total').textContent = formatNum(total);
  $('#stat-avg').textContent = formatNum(avg.toFixed(1));
  $('#stat-max').textContent = formatNum(max);
  $('#stat-municipalities').textContent = municipalities;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
fillYears();
loadMunicipalities();
loadCategories().then(()=> loadServices($('#cat').value));
refreshDashboard();

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
$('#year').addEventListener('change', refreshDashboard);
$('#municipality').addEventListener('change', refreshDashboard);
$('#cat').addEventListener('change', e=>{
  $('#service').value='';
  loadServices(e.target.value).then(refreshDashboard);
});
$('#service').addEventListener('change', refreshDashboard);
</script>
</body>
</html>
