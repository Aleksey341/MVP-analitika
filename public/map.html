<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ ‚Äî –õ–∏–ø–µ—Ü–∫–∞—è –æ–±–ª–∞—Å—Ç—å</title>

  <link rel="stylesheet" href="/no-badge.css" />
  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <style>
    :root{
      color-scheme: dark light;
      --bg-primary:#0f1115; --bg-secondary:#161a22; --border:#232a36;
      --text-primary:#e8eef7; --text-secondary:#a7b3c6; --muted:#6a7789;
      --accent:#2563eb; --success:#22c55e; --danger:#ef4444;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg-primary);color:var(--text-primary);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    a{color:#8ab4ff;text-decoration:none}
    a:hover{text-decoration:underline}

    header{padding:16px 20px;border-bottom:1px solid var(--border);background:var(--bg-secondary)}
    header .row{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    header h1{margin:0;font-size:20px}
    header .btn{background:var(--accent);color:#fff;padding:10px 14px;border-radius:8px;font-weight:600;text-decoration:none}
    header .btn:hover{opacity:.9}

    .layout{display:grid;grid-template-columns:1.4fr .9fr;gap:16px;max-width:1400px;margin:16px auto;padding:0 16px}
    @media (max-width:1100px){.layout{grid-template-columns:1fr}}
    .card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;overflow:hidden}

    #map{height:72vh;min-height:520px}
    .leaflet-container{background:#0d1117}
    .legend{padding:12px;border-top:1px solid var(--border);font-size:13px;color:var(--text-secondary)}
    .legend .scale{display:flex;gap:4px;margin-top:8px}
    .legend .c{flex:1;height:10px;border-radius:2px}

    .panel{padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .stat{background:var(--bg-primary);border:1px solid var(--border);border-radius:12px;padding:16px}
    .stat .k{font-size:13px;color:var(--text-secondary)}
    .stat .v{font:700 26px/1.2 system-ui}
    .muted{color:var(--muted)}
    .btn-wide{display:inline-block;margin-top:12px;background:var(--accent);color:#fff;padding:10px 14px;border-radius:8px;font-weight:600;text-decoration:none}
    .btn-wide:hover{opacity:.9}

    .hint{font-size:13px;color:var(--text-secondary);margin-top:8px}

    /* —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ –ø–ª–∞—à–µ–∫ */
    .mun-label {
      position: relative;
      background: transparent !important;
      border: 0 !important;
      padding: 0 !important;
      color: #0b1220;
      font-weight: 700;
      font-size: 12px;
      line-height: 1.15;
      white-space: nowrap;
      pointer-events: none;
      text-align: center;
      /* –±–µ–ª—ã–π ¬´–æ—Ä–µ–æ–ª¬ª –≤–æ–∫—Ä—É–≥ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –Ω–∞ –∫–∞—Ä—Ç–µ */
      text-shadow:
        -1px -1px 0 #fff,
         1px -1px 0 #fff,
        -1px  1px 0 #fff,
         1px  1px 0 #fff,
         0    0   3px #fff;
    }
    .mun-label.m--sm { font-size: 11px; }
    .mun-label.m--xs { font-size: 10px; }
    .mun-label.m--xxs { font-size: 9px; }

    /* –≤—Å–ø–ª—ã–≤–∞—é—â–∏–π tooltip –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
    .leaflet-tooltip.hover-label{
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text-primary);
      font-size: 12px;
    }

    /* —Å—Ç–∏–ª—å –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–ª–∏–≥–æ–Ω–∞ */
    path.mun-selected {
      stroke: #111827;
      stroke-width: 3;
      fill-opacity: 0.65;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.28));
    }

    /* —á—Ç–æ–±—ã SVG-—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º—ã —Ä–∞–±–æ—Ç–∞–ª–∏ –≤ Leaflet */
    .leaflet-overlay-pane svg { overflow: visible; }

    /* —É–±–∏—Ä–∞–µ–º –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ —Ñ–æ–∫—É—Å–∞ —É –≤–µ–∫—Ç–æ—Ä–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ */
    .leaflet-container .leaflet-interactive:focus,
    .leaflet-container .leaflet-pane svg path:focus,
    .leaflet-container .leaflet-marker-icon:focus,
    .leaflet-container .leaflet-tile:focus,
    .leaflet-container:focus {
      outline: none !important;
    }

    /* —á—Ç–æ–±—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –Ω–µ –ø–æ—è–≤–ª—è–ª—Å—è –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π highlight */
    .leaflet-container .leaflet-interactive {
      -webkit-tap-highlight-color: transparent;
    }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <div>
        <a href="/">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        <h1>üó∫Ô∏è –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –õ–∏–ø–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏</h1>
        <div class="muted">–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ —Ä–∞–π–æ–Ω—É/–æ–∫—Ä—É–≥—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–∞–Ω–Ω—ã–µ –∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ç—á—ë—Ç—É.</div>
        <div id="period-controls" style="display:flex;gap:8px;align-items:center;margin:10px 0 6px;">
          <label>–ì–æ–¥
            <select id="selYear" style="margin-left:6px;padding:6px 10px;border-radius:8px;"></select>
          </label>
          <label>–ú–µ—Å—è—Ü
            <select id="selMonth" style="margin-left:6px;padding:6px 10px;border-radius:8px;"></select>
          </label>
          <span id="periodLoading" style="display:none;color:#64748b;">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</span>
        </div>
      </div>
      <a href="/dashboard" class="btn">–ö –¥–∞—à–±–æ—Ä–¥—É</a>
    </div>
  </header>

  <div class="layout">
    <div class="card">
      <div id="map"></div>
      <div class="legend">
        –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –æ–∫—Ä–∞—Å–∫–∏ = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –î–¢–ü –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–∏–æ–¥.
        <div class="scale" id="legend-scale"></div>
      </div>
    </div>

    <div class="card">
      <div class="panel">
        <h2 id="p-title" style="margin:0 0 6px 0">–í—ã–±–µ—Ä–∏—Ç–µ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç</h2>
        <div id="p-sub" class="muted">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –Ω–∞–≤–µ–¥–∏—Ç–µ –∫—É—Ä—Å–æ—Ä –Ω–∞ –∫–∞—Ä—Ç—É ‚Äî —É–≤–∏–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ. –ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.</div>

        <div class="grid" style="margin-top:16px">
          <div class="stat">
            <div class="k">–î–¢–ü (–ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–∏–æ–¥)</div>
            <div class="v" id="p-dtp">‚Äî</div>
          </div>
          <div class="stat">
            <div class="k">–ü–æ–≥–∏–±–ª–æ</div>
            <div class="v" id="p-dead">‚Äî</div>
          </div>
          <div class="stat">
            <div class="k">–†–∞–Ω–µ–Ω–æ</div>
            <div class="v" id="p-inj">‚Äî</div>
          </div>
          <div class="stat">
            <div class="k">–ü–µ—à–µ—Ö–æ–¥—ã</div>
            <div class="v" id="p-ped">‚Äî</div>
          </div>
        </div>

        <a id="p-link" href="#" class="btn-wide" style="display:none">–û—Ç–∫—Ä—ã—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á—ë—Ç ‚Üí</a>
        <div class="hint" id="p-hint"></div>
      </div>
    </div>
  </div>

  <!-- Leaflet -->
  <script
    src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"
    crossorigin="">
  </script>
  <!-- Polylabel –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä–æ–∏–¥–∞ –≤–Ω—É—Ç—Ä–∏ –ø–æ–ª–∏–≥–æ–Ω–∞ -->
  <script src="https://unpkg.com/@mapbox/polylabel@1.1.0/polylabel.min.js"></script>

  <script>
  // ========= –£—Ç–∏–ª–∏—Ç—ã =========
  const $ = s => document.querySelector(s);

  // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è (GeoJSON <-> –ë–î)
  function normalizeName(s){
    return String(s || '')
      .toLowerCase()
      .replaceAll('—ë','–µ')
      .replace(/^–≥\.\s*/i,'')
      .replace(/^–≥–æ—Ä–æ–¥—Å–∫–æ–π –æ–∫—Ä—É–≥\s+/i,'')
      .replace(/\s+–º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π\s+–æ–∫—Ä—É–≥$/i,'')
      .replace(/\s+–º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π\s+—Ä–∞–π–æ–Ω$/i,'')
      .replace(/\s+—Ä–∞–π–æ–Ω$/i,'')
      .replace(/\s+/g,' ')
      .trim();
  }

  // –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –¥–ª–∏–Ω–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –¥–ª—è –ø–æ–¥–ø–∏—Å–µ–π
  function shortName(name=''){
    return name
      .replace(/^–≥–æ—Ä–æ–¥—Å–∫–æ–π –æ–∫—Ä—É–≥\s+–õ–∏–ø–µ—Ü–∫$/i, '–õ–∏–ø–µ—Ü–∫')
      .replace(/^–≥–æ—Ä–æ–¥—Å–∫–æ–π –æ–∫—Ä—É–≥\s+–ï–ª–µ—Ü$/i, '–ï–ª–µ—Ü')
      .replace(/^–≥–æ—Ä–æ–¥—Å–∫–æ–π –æ–∫—Ä—É–≥\s+/i, '–≥.–æ. ')
      .replace(/–º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥/gi, '–ú–û')
      .replace(/\s+–º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω/gi, ' —Ä–∞–π–æ–Ω')
      .replace(/\s+—Ä–∞–π–æ–Ω –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è/gi, ' —Ä–∞–π–æ–Ω')
      .trim();
  }

  // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ª–µ–≥–µ–Ω–¥—ã
  function makeLegend(min, max){
    const el = $('#legend-scale');
    el.innerHTML = '';
    const steps = 8;
    for(let i=0;i<steps;i++){
      const t = i/(steps-1);
      const c = choroplethColor(min + t*(max-min), min, max);
      const d = document.createElement('div');
      d.className = 'c';
      d.style.background = c;
      el.appendChild(d);
    }
  }

  // –¶–≤–µ—Ç –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é (–æ—Ç –∑–µ–ª—ë–Ω–æ–≥–æ –∫ –∫—Ä–∞—Å–Ω–æ–º—É)
  function choroplethColor(v, min, max){
    if (max <= min) return '#0ea5e9';
    const t = Math.max(0, Math.min(1, (v - min) / (max - min)));
    // 0 -> –∑–µ–ª—ë–Ω—ã–π, 0.5 -> –∂—ë–ª—Ç—ã–π, 1 -> –∫—Ä–∞—Å–Ω—ã–π
    const r = Math.round(255 * t);
    const g = Math.round(255 * (1 - t));
    const b = 64;
    return `rgb(${r},${g},${b})`;
  }

  // ========= –ö–∞—Ä—Ç–∞ =========
  let map, geoLayer;
  let munNameToId = new Map(); // –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –∏–º—è -> id (–∏–∑ /api/municipalities/all)
  let lastPeriod = null;
  let gibddByMun = new Map(); // –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –∏–º—è -> –∞–≥—Ä–µ–≥–∞—Ç—ã –î–¢–ü (–ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–∏–æ–¥)
  let labelStore = []; // —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ–¥–ø–∏—Å–µ–π: {layer, el, name, marker}
  let selectedLayer = null; // —Ç–µ–∫—É—â–∏–π –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π –ø–æ–ª–∏–≥–æ–Ω

  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∞–º–∏
  const selYear = $('#selYear');
  const selMonth = $('#selMonth');
  const periodLoading = $('#periodLoading');
  let periods = [];
  let currentPeriod = '';
  let lastClickedFeature = null;

  // –ü–∞–ª–∏—Ç—Ä–∞ –¥–ª—è —Ö–æ—Ä–æ–ø–ª–µ—Ç–∞
  const colors = ['#b9fbc0','#7bd389','#3ea35b','#b08968','#e63946','#d90429'];

  // –ö–ª—é—á –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–∞ –∏–∑ feature
  function muniKeyFromFeature(f){
    return normalizeName(f?.properties?.['name:ru'] || f?.properties?.name || '');
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–∏–æ–¥–æ–≤
  async function initPeriods(){
    const r = await fetch('/api/gibdd/periods', {credentials:'include'});
    periods = (await r.json() || [])
      .map(p => p.period)
      .filter(p => /^\d{4}-\d{2}$/.test(p))
      .sort().reverse();

    if (!periods.length) return;

    const latest = periods[0];
    const [y,m] = latest.split('-');
    buildYearOptions(periods);
    selYear.value = y;
    buildMonthOptions(y, periods);
    selMonth.value = m;

    currentPeriod = `${y}-${m}`;
    await loadAndApplyPeriod(currentPeriod);

    selYear.addEventListener('change', onYearChange);
    selMonth.addEventListener('change', onMonthChange);
  }

  function onYearChange(){
    buildMonthOptions(selYear.value, periods);
    const m = selMonth.value;
    currentPeriod = `${selYear.value}-${m}`;
    loadAndApplyPeriod(currentPeriod);
  }

  function onMonthChange(){
    currentPeriod = `${selYear.value}-${selMonth.value}`;
    loadAndApplyPeriod(currentPeriod);
  }

  function buildYearOptions(periods){
    const years = [...new Set(periods.map(p=>p.slice(0,4)))].sort().reverse();
    selYear.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join('');
  }

  function buildMonthOptions(year, periods){
    const months = periods
      .filter(p=>p.startsWith(year))
      .map(p=>p.slice(5,7))
      .sort();
    const names = ['','–Ø–Ω–≤','–§–µ–≤','–ú–∞—Ä','–ê–ø—Ä','–ú–∞–π','–ò—é–Ω','–ò—é–ª','–ê–≤–≥','–°–µ–Ω','–û–∫—Ç','–ù–æ—è','–î–µ–∫'];

    // –î–æ–±–∞–≤–∏–º ¬´–ò—Ç–æ–≥ –∑–∞ –≥–æ–¥¬ª
    selMonth.innerHTML =
      `<option value="">–ò—Ç–æ–≥ –∑–∞ –≥–æ–¥</option>` +
      months.map(mm => `<option value="${mm}">${names[+mm]}</option>`).join('');
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥
  async function loadAndApplyPeriod(periodOrYearMonth){
    try {
      periodLoading.style.display = 'inline';
      const [yy, mm] = periodOrYearMonth.split('-');

      let rows = [];
      if (!mm) {
        // –ò–¢–û–ì –ì–û–î–ê - –∏—Å–ø–æ–ª—å–∑—É–µ–º heatmap
        const heat = await fetch(`/api/gibdd/heatmap?year=${yy}`, {credentials:'include'}).then(r=>r.json());
        rows = heat.map(h => ({
          municipality_name: h.municipality_name,
          dtp_total: (h.months || []).reduce((a,b)=>a + (+b||0), 0),
          dtp_total_dead: 0, // TODO: –µ—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–µ—Ç–∞–ª–∏, –¥–æ–±–∞–≤—å—Ç–µ –≤ API
          dtp_total_injured: 0,
          dtp_pedestrians: 0
        }));
        currentPeriod = yy;
      } else {
        // –ö–û–ù–ö–†–ï–¢–ù–´–ô –ú–ï–°–Ø–¶
        rows = await fetch(`/api/gibdd/data?period=${yy}-${mm}`, {credentials:'include'}).then(r=>r.json());
        currentPeriod = `${yy}-${mm}`;
      }

      gibddByMun.clear();
      for (const row of rows) {
        const key = normalizeName(row.municipality_name || '');
        gibddByMun.set(key, row);
      }

      const totals = rows.map(r => +r.dtp_total || 0);
      const maxVal = Math.max(1, ...totals);
      const minVal = Math.min(...totals.filter(v => v > 0), 0);

      makeLegend(minVal, maxVal);
      repaintChoropleth(minVal, maxVal);

      // –ü–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ–¥–∫—É –ø–æ –æ–±–ª–∞—Å—Ç–∏
      showRegionSummary();

      // –û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –¥–∏–Ω–∞–º–∏–∫–∏
      await renderMonthlyTable();
    } finally {
      periodLoading.style.display = 'none';
    }
  }

  // –ü–µ—Ä–µ–∫—Ä–∞—Å–∫–∞ —Å–ª–æ—è
  function repaintChoropleth(minVal, maxVal){
    if (!geoLayer) return;
    geoLayer.setStyle(feature => {
      const key = muniKeyFromFeature(feature);
      const row = gibddByMun.get(key);
      const dtp = row ? Number(row.dtp_total || 0) : 0;
      const fill = choroplethColor(dtp, minVal, maxVal);
      return {
        color: '#334155', weight: 1.2, fillColor: fill, fillOpacity: 0.75
      };
    });
  }

  // –ü–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ–¥–∫—É –ø–æ –æ–±–ª–∞—Å—Ç–∏
  function showRegionSummary(){
    let dtp = 0, dead = 0, injured = 0, peds = 0;
    for (const row of gibddByMun.values()) {
      dtp     += +row.dtp_total || 0;
      dead    += +row.dtp_total_dead || 0;
      injured += +row.dtp_total_injured || 0;
      peds    += +row.dtp_pedestrians || 0;
    }

    $('#p-title').textContent = '–õ–∏–ø–µ—Ü–∫–∞—è –æ–±–ª–∞—Å—Ç—å';
    $('#p-sub').textContent = `–ü–µ—Ä–∏–æ–¥: ${currentPeriod}`;
    $('#p-dtp').textContent = dtp.toLocaleString('ru-RU');
    $('#p-dead').textContent = dead.toLocaleString('ru-RU');
    $('#p-inj').textContent = injured.toLocaleString('ru-RU');
    $('#p-ped').textContent = peds.toLocaleString('ru-RU');

    $('#p-link').style.display = 'none';
    $('#p-hint').textContent = '';

    lastClickedFeature = null;
  }

  // –ü–æ–∫–∞–∑–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç—É
  function showMunicipalityInfo(feature){
    const displayName = feature.properties['name:ru'] || feature.properties.name;
    const norm = muniKeyFromFeature(feature);
    const row = gibddByMun.get(norm);

    $('#p-title').textContent = displayName;
    $('#p-sub').textContent = `–ü–µ—Ä–∏–æ–¥: ${currentPeriod}`;

    if (row) {
      $('#p-dtp').textContent  = (+row.dtp_total || 0).toLocaleString('ru-RU');
      $('#p-dead').textContent = (+row.dtp_total_dead || 0).toLocaleString('ru-RU');
      $('#p-inj').textContent  = (+row.dtp_total_injured || 0).toLocaleString('ru-RU');
      $('#p-ped').textContent  = (+row.dtp_pedestrians || 0).toLocaleString('ru-RU');
    } else {
      $('#p-dtp').textContent = $('#p-dead').textContent = $('#p-inj').textContent = $('#p-ped').textContent = '‚Äî';
    }

    const id = munNameToId.get(norm);
    const link = $('#p-link');
    if (id){
      link.href = `/dashboard?municipality_id=${id}`;
      link.style.display = 'inline-block';
      $('#p-hint').textContent = '';
    }else{
      link.style.display = 'none';
      $('#p-hint').textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç —Å –ë–î.';
    }

    renderMonthlyTable();
  }

  // –¢–∞–±–ª–∏—Ü–∞ –¥–∏–Ω–∞–º–∏–∫–∏ –ø–æ –º–µ—Å—è—Ü–∞–º
  async function renderMonthlyTable(){
    // –ü–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞ - –¥–æ–±–∞–≤–∏–º HTML –ø–æ–∑–∂–µ
    return;
  }

  async function init(){
    // 1) –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    try{
      const me = await fetch('/api/auth/me', {credentials:'include'});
      if (!me.ok) { /* –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –ø—É–±–ª–∏—á–Ω–æ ‚Äî –º–æ–∂–Ω–æ –Ω–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç—å */ }
    }catch{}

    // 2) –°–ª–æ–≤–∞—Ä—å –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤ –∏–∑ –ë–î
    try{
      const res = await fetch('/api/municipalities/all', {credentials:'include'});
      const rows = await res.json();
      console.log('–ú—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç—ã –∏–∑ –ë–î:', rows.length);
      rows.forEach(r=>{
        const norm = normalizeName(r.name);
        munNameToId.set(norm, r.id);
        console.log(`–ë–î: "${r.name}" -> "${norm}" (id: ${r.id})`);
      });
    }catch(e){ console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤:', e); }

    // 3) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–∏–æ–¥–æ–≤ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    await initPeriods();

    // 4) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
    map = L.map('map', {
      zoomControl: true,
      attributionControl: false,
      minZoom: 6, maxZoom: 12
    }).setView([52.61, 39.6], 8); // —Ü–µ–Ω—Ç—Ä –õ–∏–ø–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18
    }).addTo(map);

    // 5) –ü–æ–¥–≥—Ä—É–∑–∫–∞ GeoJSON
    const gj = await fetch('/geo/lipetsk-municipalities.geojson');
    const geojson = await gj.json();
    console.log('GeoJSON –∑–∞–≥—Ä—É–∂–µ–Ω, districts:', geojson.features.length);

    geoLayer = L.geoJSON(geojson, {
      filter: (feature)=>{
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª–∏–≥–æ–Ω—ã —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏
        const hasName = feature.properties && (feature.properties['name:ru'] || feature.properties.name);
        const isPolygon = feature.geometry && (feature.geometry.type === 'Polygon' || feature.geometry.type === 'MultiPolygon');
        return hasName && isPolygon;
      },
      style: (feature)=>{
        // –°—Ç–∏–ª—å –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–µ–∑ repaintChoropleth
        return {
          color: '#334155', weight: 1.2, fillColor: '#ccc', fillOpacity: 0.75
        };
      },
      onEachFeature: (feature, layer)=>{
        const displayName = feature.properties['name:ru'] || feature.properties.name;

        // –í—Å–ø–ª—ã–≤–∞—é—â–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ —Å –ø–æ–ª–Ω—ã–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
        layer.bindTooltip(displayName, {
          permanent: false,
          sticky: true,
          direction: 'top',
          className: 'hover-label'
        });

        // –ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å—å –≤ —Ü–µ–Ω—Ç—Ä–µ —Ä–∞–π–æ–Ω–∞
        addLabel(feature, layer);

        // –°–æ–±—ã—Ç–∏—è
        layer.on({
          click: (e) => {
            selectFeature(layer);
            lastClickedFeature = feature;
            showMunicipalityInfo(feature);

            // –°–Ω—è—Ç—å —Ñ–æ–∫—É—Å, —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä –Ω–µ —Ä–∏—Å–æ–≤–∞–ª outline
            if (layer._path && typeof layer._path.blur === 'function') {
              layer._path.blur();
            }
            if (e.originalEvent && typeof e.originalEvent.target.blur === 'function') {
              e.originalEvent.target.blur();
            }
          },
          mouseover: () => {
            if (!layer._path?.classList.contains('mun-selected')) {
              layer.setStyle({ weight: 2, color: '#60a5fa' });
              layer.bringToFront();
            }
          },
          mouseout: () => {
            if (!layer._path?.classList.contains('mun-selected')) {
              layer.setStyle({ weight: 1.2, color: '#334155' });
            }
          }
        });
      }
    }).addTo(map);

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑—É–º–∞, —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ –∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –∫–∞—Ä—Ç—ã
    map.on('zoomend resize moveend', refreshLabels);
    refreshLabels(); // –ø–µ—Ä–≤–∏—á–Ω–∞—è –ø–æ–¥–≥–æ–Ω–∫–∞

    // –ö–ª–∏–∫ –ø–æ –ø—É—Å—Ç–æ–π –∫–∞—Ä—Ç–µ ‚Äî —Å–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∏ –ø–æ–∫–∞–∑–∞—Ç—å –æ–±–ª–∞—Å—Ç—å
    map.on('click', e => {
      if (e.originalEvent?.target?.closest('.leaflet-interactive')) return;
      resetSelection();
      showRegionSummary();
    });
  }

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è —Ä–∞–π–æ–Ω–∞
  function addLabel(feature, layer){
    const raw = feature?.properties?.['name:ru'] || feature?.properties?.name || '';
    const name = shortName(raw);
    if (!name) return;

    // –ò—â–µ–º ¬´–≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é¬ª —Ç–æ—á–∫—É ‚Äî polylabel; fallback: —Ü–µ–Ω—Ç—Ä bbox
    let latlng;
    try {
      // polylabel –∂–¥—ë—Ç MultiPolygon —Ñ–æ—Ä–º–∞—Ç
      const coords = feature.geometry.type === 'Polygon'
        ? [feature.geometry.coordinates]
        : feature.geometry.coordinates;
      const p = polylabel(coords, 2); // [lng, lat]
      latlng = L.latLng(p[1], p[0]);
    } catch {
      latlng = layer.getBounds().getCenter();
    }

    // –°–æ–∑–¥–∞—ë–º divIcon —Å –Ω–∞—à–∏–º –∫–ª–∞—Å—Å–æ–º
    const el = document.createElement('div');
    el.className = 'mun-label';
    el.textContent = name;
    el.title = raw; // –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ —Ö–æ–≤–µ—Ä—É

    const marker = L.marker(latlng, {
      icon: L.divIcon({ className: '', html: el, iconSize: null }),
      interactive: false,
      pane: 'markerPane'
    }).addTo(map);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –Ω–∞ –∑—É–º–µ/resize
    labelStore.push({ layer, el, name, marker });
  }

  // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞/—Å–∫—Ä—ã—Ç–∏–µ –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —Ä–∞–π–æ–Ω–æ–≤
  function refreshLabels(){
    const z = map.getZoom();
    labelStore.forEach(({ layer, el, name }) => {
      // –î–æ—Å—Ç—É–ø–Ω–∞—è —à–∏—Ä–∏–Ω–∞ ‚Äî –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ –ø–æ bbox –ø–æ–ª–∏–≥–æ–Ω–∞ –≤ px
      const b = layer.getBounds();
      const ne = map.latLngToLayerPoint(b.getNorthEast());
      const sw = map.latLngToLayerPoint(b.getSouthWest());
      const widthPx = Math.max(0, Math.abs(ne.x - sw.x));

      // –ë–∞–∑–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä –æ—Ç –∑—É–º–∞
      el.classList.remove('m--sm', 'm--xs', 'm--xxs');
      if (z <= 7) el.classList.add('m--xxs');
      else if (z === 8) el.classList.add('m--xs');
      else if (z === 9) el.classList.add('m--sm');

      // –ï—Å–ª–∏ –ø–æ–ª–∏–≥–æ–Ω –æ—á–µ–Ω—å —É–∑–∫–∏–π ‚Äî –ø—Ä—è—á–µ–º –ø–æ–¥–ø–∏—Å—å
      const tooNarrow = widthPx < 45;
      el.style.display = tooNarrow ? 'none' : 'block';
    });
  }

  // –í—ã–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª–∏–≥–æ–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ
  function selectFeature(layer){
    // –°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ
    if (selectedLayer && selectedLayer._path) {
      selectedLayer._path.classList.remove('mun-selected');
    }
    // –ü–æ–¥–Ω—è—Ç—å —Ç–µ–∫—É—â–∏–π —Å–ª–æ–π –Ω–∞–¥ –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏
    layer.bringToFront();

    // –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∞—Å—Å –≤—ã–¥–µ–ª–µ–Ω–∏—è
    if (layer._path) layer._path.classList.add('mun-selected');

    selectedLayer = layer;
  }

  // –°–±—Ä–æ—Å –≤—ã–¥–µ–ª–µ–Ω–∏—è
  function resetSelection(){
    if (selectedLayer && selectedLayer._path) {
      selectedLayer._path.classList.remove('mun-selected');
    }
    selectedLayer = null;
  }

  document.addEventListener('DOMContentLoaded', init);
  </script>
  <script src="/theme.js"></script>
</body>
</html>
