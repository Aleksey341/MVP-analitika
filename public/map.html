<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ - –õ–∏–ø–µ—Ü–∫–∞—è –æ–±–ª–∞—Å—Ç—å</title>
  <link rel="stylesheet" href="/no-badge.css" />
  <style>
    :root {
      --bg-primary: #0f1115;
      --bg-secondary: #1a1d24;
      --bg-tertiary: #232a36;
      --border: #2b3444;
      --text-primary: #e8eef7;
      --text-secondary: #9fb0c9;
      --text-muted: #6a7789;
      --accent-blue: #2563eb;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 20px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1600px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }

    h1 { margin: 0; font-size: 24px; }
    .subtitle { color: var(--text-secondary); font-size: 14px; margin: 4px 0 0 0; }

    main {
      max-width: 1600px;
      margin: 0 auto;
      padding: 24px;
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
    }

    @media (max-width: 1024px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    .map-container {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      position: relative;
    }

    .map-svg {
      width: 100%;
      height: auto;
      max-height: 800px;
    }

    .region {
      fill: var(--bg-tertiary);
      stroke: var(--border);
      stroke-width: 2;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .region:hover {
      fill: var(--accent-blue);
      stroke: var(--accent-blue);
      stroke-width: 3;
      filter: brightness(1.2);
    }

    .region.active {
      fill: var(--success);
      stroke: var(--success);
      stroke-width: 3;
    }

    .region-label {
      font-size: 12px;
      fill: var(--text-primary);
      pointer-events: none;
      text-anchor: middle;
      font-weight: 600;
    }

    .info-panel {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      position: sticky;
      top: 100px;
      max-height: calc(100vh - 120px);
      overflow-y: auto;
    }

    .info-panel h2 {
      margin: 0 0 16px 0;
      font-size: 20px;
      color: var(--text-primary);
    }

    .info-empty {
      text-align: center;
      color: var(--text-muted);
      padding: 40px 20px;
    }

    .info-empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .stat-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .stat-change {
      font-size: 14px;
      font-weight: 600;
      margin-top: 4px;
    }

    .stat-change.positive { color: var(--success); }
    .stat-change.negative { color: var(--danger); }

    .legend {
      display: flex;
      gap: 16px;
      margin-top: 16px;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      font-size: 13px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 4px;
    }

    .btn {
      padding: 10px 20px;
      background: var(--accent-blue);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }

    .btn:hover {
      background: #1d4ed8;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .tooltip {
      position: absolute;
      background: var(--bg-primary);
      border: 2px solid var(--accent-blue);
      border-radius: 8px;
      padding: 12px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 1000;
      font-size: 13px;
      max-width: 200px;
    }

    .tooltip.show {
      opacity: 1;
    }

    .tooltip-title {
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .tooltip-stat {
      color: var(--text-secondary);
      margin: 4px 0;
    }
  </style>
</head>
<body>

<header>
  <div class="header-content">
    <div>
      <h1>üó∫Ô∏è –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –õ–∏–ø–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏</h1>
      <p class="subtitle">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–∞–Ω–Ω—ã—Ö</p>
    </div>
    <a href="/dashboard" class="btn">‚Üê –ö –¥–∞—à–±–æ—Ä–¥—É</a>
  </div>
</header>

<main>
  <div class="map-container">
    <svg class="map-svg" viewBox="0 0 800 600" id="map">
      <!-- SVG –∫–∞—Ä—Ç–∞ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
    </svg>

    <div class="legend">
      <div class="legend-item">
        <div class="legend-color" style="background: var(--bg-tertiary)"></div>
        <span>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: var(--success)"></div>
        <span>–ù–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –î–¢–ü</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: var(--warning)"></div>
        <span>–°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: var(--danger)"></div>
        <span>–í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å</span>
      </div>
    </div>
  </div>

  <div class="info-panel" id="info-panel">
    <div class="info-empty">
      <div class="info-empty-icon">üó∫Ô∏è</div>
      <p>–í—ã–±–µ—Ä–∏—Ç–µ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç –Ω–∞ –∫–∞—Ä—Ç–µ<br>–¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</p>
    </div>
  </div>
</main>

<div class="tooltip" id="tooltip">
  <div class="tooltip-title"></div>
  <div class="tooltip-stat"></div>
</div>

<script>
// ========================================
// MUNICIPALITIES DATA
// ========================================

const municipalities = [
  // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø—Ä–∏–º–µ—Ä–Ω—ã–µ, –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —É—Ç–æ—á–Ω–∏—Ç—å
  { id: 1, name: '–≥. –õ–∏–ø–µ—Ü–∫', x: 400, y: 200, color: '#ef4444' },
  { id: 2, name: '–≥. –ï–ª–µ—Ü', x: 500, y: 450, color: '#f59e0b' },
  { id: 3, name: '–ì—Ä—è–∑–∏–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω', x: 350, y: 280, color: '#10b981' },
  { id: 4, name: '–î–∞–Ω–∫–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω', x: 280, y: 100, color: '#10b981' },
  { id: 5, name: '–î–æ–±—Ä–∏–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω', x: 200, y: 320, color: '#10b981' },
  { id: 6, name: '–î–æ–±—Ä–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω', x: 550, y: 220, color: '#10b981' },
  { id: 7, name: '–î–æ–ª–≥–æ—Ä—É–∫–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω', x: 650, y: 350, color: '#10b981' },
  { id: 8, name: '–ï–ª–µ—Ü–∫–∏–π —Ä–∞–π–æ–Ω', x: 580, y: 480, color: '#f59e0b' },
  { id: 9, name: '–ó–∞–¥–æ–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω', x: 480, y: 320, color: '#10b981' },
  { id: 10, name: '–ò–∑–º–∞–ª–∫–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω', x: 700, y: 480, color: '#10b981' },
  { id: 11, name: '–ö—Ä–∞—Å–Ω–∏–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω', x: 300, y: 480, color: '#10b981' },
  { id: 12, name: '–õ–µ–±–µ–¥—è–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω', x: 320, y: 180, color: '#f59e0b' },
  { id: 13, name: '–õ–µ–≤-–¢–æ–ª—Å—Ç–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω', x: 630, y: 120, color: '#10b981' },
  { id: 14, name: '–õ–∏–ø–µ—Ü–∫–∏–π —Ä–∞–π–æ–Ω', x: 380, y: 140, color: '#f59e0b' },
  { id: 15, name: '–°—Ç–∞–Ω–æ–≤–ª—è–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω', x: 720, y: 220, color: '#10b981' },
  { id: 16, name: '–¢–µ—Ä–±—É–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω', x: 550, y: 100, color: '#10b981' },
  { id: 17, name: '–£—Å–º–∞–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω', x: 200, y: 180, color: '#10b981' },
  { id: 18, name: '–•–ª–µ–≤–µ–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω', x: 440, y: 420, color: '#10b981' }
];

// ========================================
// CREATE SVG MAP
// ========================================

function createMap() {
  const svg = document.getElementById('map');

  municipalities.forEach(mun => {
    // –°–æ–∑–¥–∞—ë–º –∫—Ä—É–≥ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–∞
    const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');

    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    circle.setAttribute('cx', mun.x);
    circle.setAttribute('cy', mun.y);
    circle.setAttribute('r', mun.name.startsWith('–≥.') ? 40 : 30);
    circle.classList.add('region');
    circle.dataset.munId = mun.id;
    circle.dataset.munName = mun.name;

    const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    label.setAttribute('x', mun.x);
    label.setAttribute('y', mun.y + 5);
    label.classList.add('region-label');
    label.textContent = mun.name.replace(' —Ä–∞–π–æ–Ω', '').replace('–≥. ', '');

    group.appendChild(circle);
    group.appendChild(label);

    // –°–æ–±—ã—Ç–∏—è
    circle.addEventListener('click', () => selectMunicipality(mun.id, mun.name));
    circle.addEventListener('mouseenter', (e) => showTooltip(e, mun));
    circle.addEventListener('mouseleave', hideTooltip);

    svg.appendChild(group);
  });
}

// ========================================
// TOOLTIP
// ========================================

const tooltip = document.getElementById('tooltip');

function showTooltip(event, mun) {
  tooltip.querySelector('.tooltip-title').textContent = mun.name;
  tooltip.querySelector('.tooltip-stat').textContent = '–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–∞–Ω–Ω—ã—Ö';

  tooltip.style.left = event.pageX + 15 + 'px';
  tooltip.style.top = event.pageY + 15 + 'px';
  tooltip.classList.add('show');
}

function hideTooltip() {
  tooltip.classList.remove('show');
}

// ========================================
// SELECT MUNICIPALITY
// ========================================

let currentMunId = null;

async function selectMunicipality(munId, munName) {
  // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤—ã–±–æ—Ä
  document.querySelectorAll('.region').forEach(r => r.classList.remove('active'));

  // –í—ã–¥–µ–ª—è–µ–º –Ω–æ–≤—ã–π
  const region = document.querySelector(`[data-mun-id="${munId}"]`);
  if (region) {
    region.classList.add('active');
  }

  currentMunId = munId;

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
  await loadMunicipalityData(munId, munName);
}

// ========================================
// LOAD DATA
// ========================================

async function loadMunicipalityData(munId, munName) {
  const panel = document.getElementById('info-panel');
  panel.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>';

  try {
    const currentYear = new Date().getFullYear();

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ì–ò–ë–î–î
    const gibddResponse = await fetch(`/api/gibdd/heatmap?year=${currentYear}`);
    const gibddData = await gibddResponse.json();

    const munGibdd = gibddData.find(d => d.municipality_id === munId);

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —É—Å–ª—É–≥
    const servicesResponse = await fetch(`/api/services-dashboard/data?year=${currentYear}&municipality_id=${munId}`);
    const servicesData = await servicesResponse.json();

    // –†–µ–Ω–¥–µ—Ä–∏–º –ø–∞–Ω–µ–ª—å
    renderMunicipalityPanel(munName, munGibdd, servicesData);

  } catch (error) {
    console.error('Error loading data:', error);
    panel.innerHTML = `
      <div class="info-empty">
        <div class="info-empty-icon">‚ö†Ô∏è</div>
        <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>
      </div>
    `;
  }
}

// ========================================
// RENDER PANEL
// ========================================

function renderMunicipalityPanel(name, gibddData, servicesData) {
  const panel = document.getElementById('info-panel');

  const totalDTP = gibddData ? gibddData.total : 0;
  const totalServices = servicesData.kpi ? servicesData.kpi.total_services : 0;

  panel.innerHTML = `
    <h2>${name}</h2>

    <div class="stat-card">
      <div class="stat-label">üöó –î–¢–ü –∑–∞ ${new Date().getFullYear()} –≥–æ–¥</div>
      <div class="stat-value">${totalDTP.toLocaleString()}</div>
      ${servicesData.kpi && servicesData.kpi.change_percent ? `
        <div class="stat-change ${parseFloat(servicesData.kpi.change_percent) < 0 ? 'positive' : 'negative'}">
          ${parseFloat(servicesData.kpi.change_percent) > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(servicesData.kpi.change_percent)}%
        </div>
      ` : ''}
    </div>

    <div class="stat-card">
      <div class="stat-label">üìä –£—Å–ª—É–≥ –æ–∫–∞–∑–∞–Ω–æ</div>
      <div class="stat-value">${totalServices.toLocaleString()}</div>
      ${servicesData.kpi && servicesData.kpi.change_percent ? `
        <div class="stat-change ${parseFloat(servicesData.kpi.change_percent) > 0 ? 'positive' : 'negative'}">
          ${parseFloat(servicesData.kpi.change_percent) > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(servicesData.kpi.change_percent)}%
        </div>
      ` : ''}
    </div>

    <div style="margin-top: 24px;">
      <a href="/dashboard?municipality_id=${currentMunId}" class="btn" style="width: 100%; text-align: center;">
        –ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á—ë—Ç ‚Üí
      </a>
    </div>

    <div style="margin-top: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; font-size: 12px; color: var(--text-secondary);">
      <p style="margin: 0;">üí° <strong>–°–æ–≤–µ—Ç:</strong> –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –¥—Ä—É–≥–æ–π –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π</p>
    </div>
  `;
}

// ========================================
// INIT
// ========================================

document.addEventListener('DOMContentLoaded', () => {
  createMap();

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –õ–∏–ø–µ—Ü–∫
  setTimeout(() => {
    selectMunicipality(1, '–≥. –õ–∏–ø–µ—Ü–∫');
  }, 500);
});
</script>

</body>
</html>
