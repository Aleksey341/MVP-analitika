<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ ‚Äî –õ–∏–ø–µ—Ü–∫–∞—è –æ–±–ª–∞—Å—Ç—å</title>

  <link rel="stylesheet" href="/no-badge.css" />
  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <style>
    :root{
      color-scheme: dark light;
      --bg-primary:#0f1115; --bg-secondary:#161a22; --border:#232a36;
      --text-primary:#e8eef7; --text-secondary:#a7b3c6; --muted:#6a7789;
      --accent:#2563eb; --success:#22c55e; --danger:#ef4444;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg-primary);color:var(--text-primary);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    a{color:#8ab4ff;text-decoration:none}
    a:hover{text-decoration:underline}

    header{padding:16px 20px;border-bottom:1px solid var(--border);background:var(--bg-secondary)}
    header .row{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    header h1{margin:0;font-size:20px}
    header .btn{background:var(--accent);color:#fff;padding:10px 14px;border-radius:8px;font-weight:600;text-decoration:none}
    header .btn:hover{opacity:.9}

    .layout{display:grid;grid-template-columns:1.4fr .9fr;gap:16px;max-width:1400px;margin:16px auto;padding:0 16px}
    @media (max-width:1100px){.layout{grid-template-columns:1fr}}
    .card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;overflow:hidden}

    #map{height:72vh;min-height:520px}
    .leaflet-container{background:#0d1117}
    .legend{padding:12px;border-top:1px solid var(--border);font-size:13px;color:var(--text-secondary)}
    .legend .scale{display:flex;gap:4px;margin-top:8px}
    .legend .c{flex:1;height:10px;border-radius:2px}

    .panel{padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .stat{background:var(--bg-primary);border:1px solid var(--border);border-radius:12px;padding:16px}
    .stat .k{font-size:13px;color:var(--text-secondary)}
    .stat .v{font:700 26px/1.2 system-ui}
    .muted{color:var(--muted)}
    .btn-wide{display:inline-block;margin-top:12px;background:var(--accent);color:#fff;padding:10px 14px;border-radius:8px;font-weight:600;text-decoration:none}
    .btn-wide:hover{opacity:.9}

    .hint{font-size:13px;color:var(--text-secondary);margin-top:8px}

    /* –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∏ –≤ —Ü–µ–Ω—Ç—Ä–µ —Ä–∞–π–æ–Ω–∞ */
    .leaflet-tooltip.mun-label{
      background: rgba(0,0,0,.55);
      border: none;
      color: #fff;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      pointer-events: none;
    }
    /* –≤—Å–ø–ª—ã–≤–∞—é—â–∏–π tooltip –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
    .leaflet-tooltip.hover-label{
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text-primary);
      font-size: 12px;
    }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <div>
        <a href="/">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        <h1>üó∫Ô∏è –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –õ–∏–ø–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏</h1>
        <div class="muted">–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ —Ä–∞–π–æ–Ω—É/–æ–∫—Ä—É–≥—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–∞–Ω–Ω—ã–µ –∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ç—á—ë—Ç—É.</div>
      </div>
      <a href="/dashboard" class="btn">–ö –¥–∞—à–±–æ—Ä–¥—É</a>
    </div>
  </header>

  <div class="layout">
    <div class="card">
      <div id="map"></div>
      <div class="legend">
        –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –æ–∫—Ä–∞—Å–∫–∏ = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –î–¢–ü –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–∏–æ–¥.
        <div class="scale" id="legend-scale"></div>
      </div>
    </div>

    <div class="card">
      <div class="panel">
        <h2 id="p-title" style="margin:0 0 6px 0">–í—ã–±–µ—Ä–∏—Ç–µ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç</h2>
        <div id="p-sub" class="muted">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –Ω–∞–≤–µ–¥–∏—Ç–µ –∫—É—Ä—Å–æ—Ä –Ω–∞ –∫–∞—Ä—Ç—É ‚Äî —É–≤–∏–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ. –ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.</div>

        <div class="grid" style="margin-top:16px">
          <div class="stat">
            <div class="k">–î–¢–ü (–ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–∏–æ–¥)</div>
            <div class="v" id="p-dtp">‚Äî</div>
          </div>
          <div class="stat">
            <div class="k">–ü–æ–≥–∏–±–ª–æ</div>
            <div class="v" id="p-dead">‚Äî</div>
          </div>
          <div class="stat">
            <div class="k">–†–∞–Ω–µ–Ω–æ</div>
            <div class="v" id="p-inj">‚Äî</div>
          </div>
          <div class="stat">
            <div class="k">–ü–µ—à–µ—Ö–æ–¥—ã</div>
            <div class="v" id="p-ped">‚Äî</div>
          </div>
        </div>

        <a id="p-link" href="#" class="btn-wide" style="display:none">–û—Ç–∫—Ä—ã—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á—ë—Ç ‚Üí</a>
        <div class="hint" id="p-hint"></div>
      </div>
    </div>
  </div>

  <!-- Leaflet -->
  <script
    src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"
    crossorigin="">
  </script>

  <script>
  // ========= –£—Ç–∏–ª–∏—Ç—ã =========
  const $ = s => document.querySelector(s);

  // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è (GeoJSON <-> –ë–î)
  function normalizeName(s){
    return String(s || '')
      .toLowerCase()
      .replaceAll('—ë','–µ')
      .replace(/^–≥\.\s*/i,'')
      .replace(/^–≥–æ—Ä–æ–¥—Å–∫–æ–π –æ–∫—Ä—É–≥\s+/i,'')
      .replace(/\s+–º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π\s+–æ–∫—Ä—É–≥$/i,'')
      .replace(/\s+–º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π\s+—Ä–∞–π–æ–Ω$/i,'')
      .replace(/\s+—Ä–∞–π–æ–Ω$/i,'')
      .replace(/\s+/g,' ')
      .trim();
  }

  // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ª–µ–≥–µ–Ω–¥—ã
  function makeLegend(min, max){
    const el = $('#legend-scale');
    el.innerHTML = '';
    const steps = 8;
    for(let i=0;i<steps;i++){
      const t = i/(steps-1);
      const c = choroplethColor(min + t*(max-min), min, max);
      const d = document.createElement('div');
      d.className = 'c';
      d.style.background = c;
      el.appendChild(d);
    }
  }

  // –¶–≤–µ—Ç –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é (–æ—Ç –∑–µ–ª—ë–Ω–æ–≥–æ –∫ –∫—Ä–∞—Å–Ω–æ–º—É)
  function choroplethColor(v, min, max){
    if (max <= min) return '#0ea5e9';
    const t = Math.max(0, Math.min(1, (v - min) / (max - min)));
    // 0 -> –∑–µ–ª—ë–Ω—ã–π, 0.5 -> –∂—ë–ª—Ç—ã–π, 1 -> –∫—Ä–∞—Å–Ω—ã–π
    const r = Math.round(255 * t);
    const g = Math.round(255 * (1 - t));
    const b = 64;
    return `rgb(${r},${g},${b})`;
  }

  // ========= –ö–∞—Ä—Ç–∞ =========
  let map, geoLayer;
  let munNameToId = new Map(); // –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –∏–º—è -> id (–∏–∑ /api/municipalities/all)
  let lastPeriod = null;
  let gibddByMun = new Map(); // –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –∏–º—è -> –∞–≥—Ä–µ–≥–∞—Ç—ã –î–¢–ü (–ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–∏–æ–¥)
  let labelItems = []; // —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–µ–π

  async function init(){
    // 1) –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    try{
      const me = await fetch('/api/auth/me', {credentials:'include'});
      if (!me.ok) { /* –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –ø—É–±–ª–∏—á–Ω–æ ‚Äî –º–æ–∂–Ω–æ –Ω–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç—å */ }
    }catch{}

    // 2) –°–ª–æ–≤–∞—Ä—å –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤ –∏–∑ –ë–î
    try{
      const res = await fetch('/api/municipalities/all', {credentials:'include'});
      const rows = await res.json();
      console.log('–ú—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç—ã –∏–∑ –ë–î:', rows.length);
      rows.forEach(r=>{
        const norm = normalizeName(r.name);
        munNameToId.set(norm, r.id);
        console.log(`–ë–î: "${r.name}" -> "${norm}" (id: ${r.id})`);
      });
    }catch(e){ console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤:', e); }

    // 3) –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–∏–æ–¥ –î–¢–ü + –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–µ—Ä–∏–æ–¥
    try{
      const per = await fetch('/api/gibdd/periods', {credentials:'include'});
      const periods = per.ok ? await per.json() : [];
      lastPeriod = periods?.[0]?.period || null;

      if (lastPeriod){
        const d = await fetch(`/api/gibdd/data?period=${encodeURIComponent(lastPeriod)}`, {credentials:'include'});
        const rows = d.ok ? await d.json() : [];
        // –°–∫–ª–∞–¥–∏—Ä—É–µ–º –∫–∞–∫ name(norm) -> row
        rows.forEach(r=>{
          gibddByMun.set(normalizeName(r.municipality_name), r);
        });
      }
    }catch(e){ console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ì–ò–ë–î–î:', e); }

    // 4) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
    map = L.map('map', {
      zoomControl: true,
      attributionControl: false,
      minZoom: 6, maxZoom: 12
    }).setView([52.61, 39.6], 8); // —Ü–µ–Ω—Ç—Ä –õ–∏–ø–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18
    }).addTo(map);

    // –ü–∞–Ω–µ–ª—å –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–µ–π (–ø–æ–≤–µ—Ä—Ö –ø–æ–ª–∏–≥–æ–Ω–æ–≤)
    const labelPane = map.createPane('labels');
    labelPane.style.zIndex = 650;
    labelPane.style.pointerEvents = 'none';

    // 5) –ü–æ–¥–≥—Ä—É–∑–∫–∞ GeoJSON
    const gj = await fetch('/geo/lipetsk-municipalities.geojson');
    const geojson = await gj.json();
    console.log('GeoJSON –∑–∞–≥—Ä—É–∂–µ–Ω, districts:', geojson.features.length);

    // –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ –î–¢–ü –¥–ª—è —Ä–∞—Å–∫—Ä–∞—Å–∫–∏
    let values = [];
    geojson.features.forEach(f=>{
      const gName = f.properties['name:ru'] || f.properties.name;
      const norm = normalizeName(gName);
      const r = gibddByMun.get(norm);
      console.log(`GeoJSON: "${gName}" -> "${norm}" -> ${r ? r.dtp_total + ' –î–¢–ü' : '–ù–ï–¢ –î–ê–ù–ù–´–•'}`);
      if (r) values.push(Number(r.dtp_total || 0));
    });
    const min = values.length ? Math.min(...values) : 0;
    const max = values.length ? Math.max(...values) : 1;
    console.log('–î–∏–∞–ø–∞–∑–æ–Ω –î–¢–ü:', min, '-', max);
    makeLegend(min, max);

    geoLayer = L.geoJSON(geojson, {
      filter: (feature)=>{
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª–∏–≥–æ–Ω—ã —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏
        const hasName = feature.properties && (feature.properties['name:ru'] || feature.properties.name);
        const isPolygon = feature.geometry && (feature.geometry.type === 'Polygon' || feature.geometry.type === 'MultiPolygon');
        return hasName && isPolygon;
      },
      style: (feature)=>{
        const gName = feature.properties['name:ru'] || feature.properties.name;
        const r = gibddByMun.get(normalizeName(gName));
        const dtp = r ? Number(r.dtp_total || 0) : 0;
        const fill = choroplethColor(dtp, min, max);
        return {
          color: '#334155', weight: 1.2, fillColor: fill, fillOpacity: 0.75
        };
      },
      onEachFeature: (feature, layer)=>{
        const displayName = feature.properties['name:ru'] || feature.properties.name;

        // –í—Å–ø–ª—ã–≤–∞—é—â–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
        layer.bindTooltip(displayName, {
          permanent: false,
          sticky: true,
          direction: 'top',
          className: 'hover-label'
        });

        // –ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å—å –≤ —Ü–µ–Ω—Ç—Ä–µ —Ä–∞–π–æ–Ω–∞
        addFeatureLabel(layer, displayName);

        layer.on('click', ()=>{
          selectMunicipality(displayName);
        });
        layer.on('mouseover', ()=> layer.setStyle({weight:2, color:'#60a5fa'}));
        layer.on('mouseout',  ()=> layer.setStyle({weight:1.2, color:'#334155'}));
      }
    }).addTo(map);

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∏ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏/–º–∞—Å—à—Ç–∞–±–µ
    map.on('zoomend moveend', refreshLabels);
    refreshLabels();

    // –ê–≤—Ç–æ–≤—ã–±–æ—Ä –õ–∏–ø–µ—Ü–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    setTimeout(()=>selectMunicipality('–≥–æ—Ä–æ–¥—Å–∫–æ–π –æ–∫—Ä—É–≥ –õ–∏–ø–µ—Ü–∫'), 400);
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π –ø–æ–¥–ø–∏—Å–∏
  function addFeatureLabel(layer, name){
    const center = layer.getBounds().getCenter();
    const t = L.tooltip({
      pane: 'labels',
      permanent: true,
      direction: 'center',
      className: 'mun-label',
      opacity: 0.95
    })
      .setContent(name)
      .setLatLng(center)
      .addTo(map);

    labelItems.push({ tooltip: t, layer });
  }

  // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∏ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏–Ω–∞—è —Å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∞
  function refreshLabels(){
    const show = map.getZoom() >= 8;  // –ø–æ—Ä–æ–≥ –º–æ–∂–Ω–æ –ø–æ–¥–æ–±—Ä–∞—Ç—å (7‚Äì10)
    labelItems.forEach(({ tooltip, layer }) => {
      if (show) {
        // –¥–µ—Ä–∂–∏–º –ø–æ–¥–ø–∏—Å—å –ø–æ —Ü–µ–Ω—Ç—Ä—É –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏/–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏
        tooltip.setLatLng(layer.getBounds().getCenter());
        if (!map.hasLayer(tooltip)) map.addLayer(tooltip);
      } else {
        if (map.hasLayer(tooltip)) map.removeLayer(tooltip);
      }
    });
  }

  function selectMunicipality(displayName){
    const norm = normalizeName(displayName);
    const row = gibddByMun.get(norm);

    $('#p-title').textContent = displayName;
    $('#p-sub').textContent   = lastPeriod ? `–ü–µ—Ä–∏–æ–¥: ${lastPeriod}` : '';

    $('#p-dtp').textContent  = row ? (row.dtp_total ?? '‚Äî') : '‚Äî';
    $('#p-dead').textContent = row ? (row.dtp_total_dead ?? '‚Äî') : '‚Äî';
    $('#p-inj').textContent  = row ? (row.dtp_total_injured ?? '‚Äî') : '‚Äî';
    $('#p-ped').textContent  = row ? (row.dtp_pedestrians ?? '‚Äî') : '‚Äî';

    // –°—Å—ã–ª–∫–∞ –Ω–∞ –¥–∞—à–±–æ—Ä–¥
    const id = munNameToId.get(norm);
    const link = $('#p-link');
    if (id){
      link.href = `/dashboard?municipality_id=${id}`;
      link.style.display = 'inline-block';
      $('#p-hint').textContent = '';
    }else{
      link.style.display = 'none';
      $('#p-hint').textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç —Å –ë–î (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏—è).';
    }
  }

  document.addEventListener('DOMContentLoaded', init);
  </script>
  <script src="/theme.js"></script>
</body>
</html>
