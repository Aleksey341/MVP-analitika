<!doctype html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–û—Ç—á—ë—Ç–Ω–æ—Å—Ç—å ‚Äî –≥–ª–∞–≤–Ω–∞—è</title>
  <link rel="stylesheet" href="/no-badge.css"/>

  <style>
    /* ======= –¢–µ–º–∞ –∏ —Ç–æ–∫–µ–Ω—ã ======= */
    :root{
      color-scheme: dark light;
      --bg:#0f1115; --bg-2:#161a22; --text:#e8eef7; --muted:#a7b3c6; --muted-2:#6a7789;
      --border:#232a36; --accent:#2563eb; --accent-2:#8ab4ff;
      --card-shadow: 0 8px 24px rgba(37,99,235,.18);
    }
    :root[data-theme="light"]{
      --bg:#ffffff; --bg-2:#f8fafc; --text:#0f172a; --muted:#475569; --muted-2:#64748b;
      --border:#e2e8f0; --accent:#2563eb; --accent-2:#1d4ed8;
      --card-shadow: 0 10px 24px rgba(2,8,23,.08);
    }

    /* ======= –ë–∞–∑–æ–≤–∞—è —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ ======= */
    *{box-sizing:border-box}
    body{
      margin:0;
      font: 14px/1.45 system-ui,-apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    a{color:var(--accent-2); text-decoration:none}
    a:hover{text-decoration:underline}

    .container{max-width:960px; margin:auto; padding:24px}

    /* ======= –®–∞–ø–∫–∞ ======= */
    .app-header{position:sticky; top:0; z-index:10; background:var(--bg); border-bottom:1px solid var(--border)}
    .toolbar{
      margin:12px auto; padding:0 16px; max-width:960px;
      display:grid; grid-auto-flow:column; grid-auto-columns:1fr; gap:12px; align-items:center;
    }
    .user-link{
      color:var(--accent-2); font-weight:700; text-decoration:none;
      display:inline-flex; align-items:center; justify-content:flex-start;
      height:40px; border-radius:10px; border:1px solid transparent; padding:0 4px;
    }
    .user-link:hover{text-decoration:underline}

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      height:40px; width:200px; /* –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è —à–∏—Ä–∏–Ω–∞ */
      padding:0 16px; border-radius:10px;
      background:var(--bg-2); border:1px solid var(--border); color:var(--text);
      font-weight:600; cursor:pointer; user-select:none;
      transition:background .15s ease, transform .02s ease;
    }
    .btn:hover{background:color-mix(in oklab, var(--bg-2) 80%, var(--accent) 20%)}
    .btn:active{transform:translateY(1px)}
    .btn:focus-visible{outline:2px solid var(--accent); outline-offset:2px}
    .icon{font-size:16px; line-height:1}

    @media (max-width:560px){
      .toolbar{grid-auto-flow:row; grid-auto-rows:1fr}
      .btn{width:100%}
    }

    /* ======= –ö–∞—Ä—Ç–æ—á–∫–∏ ======= */
    .cards{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:16px; margin-top:16px
    }
    .card{
      background:var(--bg-2); border:1px solid var(--border); border-radius:12px;
      padding:20px; position:relative; overflow:hidden; cursor:pointer;
      transition:transform .25s ease, border-color .25s ease, box-shadow .25s ease;
    }
    .card::before{
      content:""; position:absolute; inset:0 0 auto 0; height:4px;
      background:linear-gradient(90deg,#1b6fff,#8ab4ff); transform:scaleX(0);
      transition:transform .25s ease; transform-origin:left center;
    }
    .card:hover{ transform:translateY(-4px); border-color:var(--accent); box-shadow:var(--card-shadow) }
    .card:hover::before{ transform:scaleX(1) }
    .card-icon{ font-size:2.25rem; margin-bottom:10px; display:inline-block; opacity:.9; transition:transform .25s ease }
    .card:hover .card-icon{ transform:scale(1.08) }
    .card h3{ margin:0 0 8px; font-size:1.08rem }
    .card p{ margin:0 0 14px; font-size:.92rem; color:var(--muted) }
    .card-link{ color:var(--accent-2); font-weight:600; display:inline-flex; align-items:center; gap:4px; transition:gap .25s ease }
    .card:hover .card-link{ gap:8px }

    .muted{color:var(--muted)}
    footer{opacity:.75; padding:24px; text-align:center}

    /* ======= –ú–æ–¥–∞–ª–∫–∞ –ª–æ–≥–∏–Ω–∞ ======= */
    .modal-overlay{
      display:none; position:fixed; inset:0; background:rgba(0,0,0,.85);
      z-index:1000; align-items:center; justify-content:center; backdrop-filter:blur(4px);
    }
    .modal-overlay.show{ display:flex; animation:fadeIn .2s ease }
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }

    .modal{
      background:var(--bg-2); border:1px solid var(--border); border-radius:12px;
      padding:32px; min-width:400px; max-width:92vw; animation:drop .25s ease;
    }
    @keyframes drop{ from{transform:translateY(-16px); opacity:.5} to{transform:none; opacity:1} }

    .modal h2{ margin:0 0 18px }
    .ctl{ display:flex; flex-direction:column; gap:6px; margin-bottom:14px }
    label{ font-size:13px; font-weight:600; color:var(--muted) }
    select, input[type="password"], input[type="text"]{
      background:var(--bg); border:1px solid var(--border); border-radius:8px;
      color:var(--text); padding:12px; width:100%;
    }
    select:focus, input[type="password"]:focus, input[type="text"]:focus{ outline:none; border-color:var(--accent) }
    .password-wrapper{ position:relative }
    .password-wrapper input{ padding-right:40px }
    .toggle-password{
      position:absolute; right:12px; top:50%; transform:translateY(-50%);
      color:var(--muted); cursor:pointer; user-select:none;
    }
    .toggle-password:hover{ color:var(--accent-2) }
    .btn-primary{
      display:inline-flex; align-items:center; justify-content:center;
      width:100%; height:44px; border-radius:10px; border:0;
      background:linear-gradient(135deg,#1b6fff 0%,#1554d1 100%); color:#fff; font-weight:700; cursor:pointer;
    }
    .btn-primary:hover{ opacity:.92 }
    .modal-error{ color:#ff6b6b; font-size:14px; margin-top:10px; display:none }
    .modal-error.show{ display:block }
    .hidden{ display:none !important }
  </style>
</head>

<body>
  <!-- ======= –®–ê–ü–ö–ê (—É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π —à–∏—Ä–∏–Ω—ã) ======= -->
  <header class="app-header" role="banner">
    <div class="toolbar" role="group" aria-label="–ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π">
      <a class="user-link" id="user-link" href="/profile">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</a>

      <button id="themeBtn" class="btn" type="button" aria-pressed="false" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
        <span class="icon" aria-hidden="true">üåû</span>
        <span class="label">–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞</span>
      </button>

      <button id="btn-logout" class="btn" type="button">–í—ã–π—Ç–∏</button>
    </div>
  </header>

  <!-- ======= –ú–û–î–ê–õ–ö–ê –í–•–û–î–ê ======= -->
  <div class="modal-overlay" id="modal-login" aria-modal="true" role="dialog" aria-labelledby="login-title">
    <div class="modal">
      <h2 id="login-title">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>

      <div class="ctl">
        <label for="login-municipality">–ú—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç</label>
        <select id="login-municipality" autocomplete="off">
          <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
        </select>
      </div>

      <div class="ctl">
        <label for="login-password">–ü–∞—Ä–æ–ª—å</label>
        <div class="password-wrapper">
          <input type="password" id="login-password" autocomplete="current-password"/>
          <span class="toggle-password" id="toggle-password" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">üëÅÔ∏è</span>
        </div>
      </div>

      <div class="modal-error" id="login-error"></div>
      <button id="btn-modal-login" class="btn-primary">–í–æ–π—Ç–∏</button>

      <div style="text-align:center; margin-top:14px">
        <a href="/change-password.html" style="color:var(--accent-2); font-size:14px">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</a>
      </div>
    </div>
  </div>

  <!-- ======= –ö–û–ù–¢–ï–ù–¢ ======= -->
  <main id="main-content" class="container hidden">
    <h1 style="margin:0 0 6px">–°–∏—Å—Ç–µ–º–∞ –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏</h1>
    <p class="muted" style="margin:0 0 12px">–ë—ã—Å—Ç—Ä—ã–µ —Å—Å—ã–ª–∫–∏:</p>

    <div class="cards" id="cards-container"><!-- –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ --></div>
  </main>

  <footer>
    <span class="muted">¬© –ê–ù–û ¬´–û–±–ª–∞—Å—Ç—å –ë—É–¥—É—â–µ–≥–æ¬ª</span>
  </footer>

  <script>
    const $ = (s) => document.querySelector(s);
    let currentUser = null;

    /* ======= –¢–µ–º–∞ (–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å) ======= */
    (function setupTheme(){
      const root = document.documentElement;
      const btn  = $('#themeBtn');
      const saved = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const current = saved || (prefersDark ? 'dark' : 'dark'); // —Å—Ç–∞—Ä—Ç—É–µ–º –≤ —Ç—ë–º–Ω–æ–π –∫–∞–∫ —Ä–∞–Ω—å—à–µ
      applyTheme(current);

      btn.addEventListener('click', () => {
        const next = root.dataset.theme === 'dark' ? 'light' : 'dark';
        applyTheme(next);
        localStorage.setItem('theme', next);
      });

      function applyTheme(theme){
        root.dataset.theme = theme;
        const isDark = theme === 'dark';
        // –∫–Ω–æ–ø–∫–∞ –≤—Å–µ–≥–¥–∞ 200px ‚Äî —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç/–∏–∫–æ–Ω–∫–∞ –º–µ–Ω—è—é—Ç—Å—è
        btn.setAttribute('aria-pressed', String(isDark));
        btn.querySelector('.icon').textContent  = isDark ? 'üåô' : 'üåû';
        btn.querySelector('.label').textContent = isDark ? '–¢—ë–º–Ω–∞—è —Ç–µ–º–∞' : '–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';
      }
    })();

    /* ======= API: —Å—Ç–∞—Ç—É—Å —Å–µ—Å—Å–∏–∏ ======= */
    async function checkAuth(){
      try{
        const r = await fetch('/api/auth/me',{credentials:'include'});
        if(!r.ok) return false;
        const data = await r.json();
        currentUser = data.user || data;

        if(currentUser?.password_reset_required){
          location.href = '/change-password.html?required=true';
          return false;
        }
        return true;
      }catch(e){
        console.error('checkAuth:', e);
        return false;
      }
    }

    /* ======= –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–∞ –ú–£–ü–æ–≤ –≤ –º–æ–¥–∞–ª–∫–µ ======= */
    async function loadMunicipalities(){
      try{
        const r = await fetch('/api/municipalities/all');
        if(!r.ok) throw new Error('load municipalities failed');
        const rows = await r.json();
        const sel = $('#login-municipality');
        sel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç ‚Äî</option>'
                      + '<option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>'
                      + '<option value="governor">–ì—É–±–µ—Ä–Ω–∞—Ç–æ—Ä –õ–∏–ø–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏</option>';
        rows.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.id; opt.textContent = m.name; sel.appendChild(opt);
        });
      }catch(e){
        console.error('loadMunicipalities:', e);
        $('#login-municipality').innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
      }
    }

    /* ======= Login / Logout ======= */
    async function login(municipality_id, password){
      try{
        const r = await fetch('/api/auth/login',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body:JSON.stringify({municipality_id,password})
        });

        if(!r.ok){
          const err = await r.json().catch(()=>({}));
          throw new Error(err.message || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
        }

        const data = await r.json();
        currentUser = data.user || data;

        if(currentUser.password_reset_required){
          location.href = '/change-password.html?required=true';
          return;
        }

        $('#modal-login').classList.remove('show');
        updateUI();
      }catch(e){
        const el = $('#login-error');
        el.textContent = e.message || '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
        el.classList.add('show');
      }
    }

    async function logout(){
      try{ await fetch('/api/auth/logout',{method:'POST',credentials:'include'}); }
      finally{ location.reload(); }
    }

    /* ======= UI ======= */
    function updateUI(){
      $('#main-content').classList.remove('hidden');

      // –ò–º—è –≤ –ª–µ–≤–æ–π —á–∞—Å—Ç–∏ —à–∞–ø–∫–∏
      const userName =
        currentUser?.role === 'governor' ? '–ì—É–±–µ—Ä–Ω–∞—Ç–æ—Ä –õ–∏–ø–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏' :
        (currentUser?.municipality_name || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä');

      $('#user-link').textContent = userName;
      $('#user-link').href = '/profile';

      // –ö–∞—Ä—Ç–æ—á–∫–∏
      const cardsContainer = $('#cards-container');
      cardsContainer.innerHTML = '';

      const operator = [
        {title:'–§–æ—Ä–º–∞ 1-–ì–ú–£', desc:'–í–Ω–µ—Å–µ–Ω–∏–µ –µ–∂–µ–º–µ—Å—è—á–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π.', href:'/form', icon:'üìù'},
        {title:'–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ì–ò–ë–î–î', desc:'–î–¢–ü –∏ —Å–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.', href:'/gibdd', icon:'üöó'},
        {title:'–§–∏–Ω–∞–Ω—Å—ã –ú—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç—ã', desc:'–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏.', href:'/finance', icon:'üí∞'},
      ];
      const adminOnly = {title:'–û–±—â–∏–π –¥–∞—à–±–æ—Ä–¥', desc:'–ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.', href:'/dashboard', icon:'üìä'};

      let list = [];
      if(currentUser?.role === 'admin') list = [...operator, adminOnly];
      else if(currentUser?.role === 'governor') list = [adminOnly];
      else list = operator;

      list.forEach(c=>{
        const el = document.createElement('a');
        el.href = c.href; el.className='card';
        el.innerHTML = `
          <div class="card-icon" aria-hidden="true">${c.icon}</div>
          <h3>${c.title}</h3>
          <p>${c.desc}</p>
          <span class="card-link">–û—Ç–∫—Ä—ã—Ç—å ‚Üí</span>
        `;
        cardsContainer.appendChild(el);
      });
    }

    /* ======= –°–ª—É—à–∞—Ç–µ–ª–∏ ======= */
    $('#btn-modal-login').addEventListener('click', async ()=>{
      const m = $('#login-municipality').value.trim();
      const p = $('#login-password').value.trim();
      if(!m || !p){
        const el = $('#login-error');
        el.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç –∏ –≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å';
        el.classList.add('show');
        return;
      }
      await login(m,p);
    });

    $('#login-password').addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ e.preventDefault(); $('#btn-modal-login').click(); }
    });

    $('#toggle-password').addEventListener('click', ()=>{
      const i = $('#login-password');
      const t = $('#toggle-password');
      const isPwd = i.type === 'password';
      i.type = isPwd ? 'text' : 'password';
      t.textContent = isPwd ? 'üôà' : 'üëÅÔ∏è';
    });

    $('#btn-logout').addEventListener('click', logout);

    /* ======= –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ======= */
    (async function init(){
      const ok = await checkAuth();
      if(!ok){
        await loadMunicipalities();
        $('#login-password').value = '';
        $('#login-error').classList.remove('show');
        $('#modal-login').classList.add('show');
        setTimeout(()=>$('#login-municipality')?.focus(), 60);
      }else{
        updateUI();
      }
    })();
  </script>
</body>
</html>
