<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —É—Å–ª—É–≥–∞–º</title>
  <link rel="stylesheet" href="/no-badge.css" />
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <header>
      <div class="user-header">
        <h1>–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —É—Å–ª—É–≥–∞–º</h1>
        <div style="display:flex;gap:12px;align-items:center">
          <div class="user-info">
            <strong id="user-name">‚Äî</strong>
          </div>
          <button id="themeToggle" class="btn-logout">üåô –¢–µ–º–Ω–∞—è —Ç–µ–º–∞</button>
          <button class="btn-logout" onclick="location.href='/'">–ù–∞–∑–∞–¥</button>
        </div>
      </div>
    </header>

    <main>
      <div class="alert alert-info">
        <strong>‚ÑπÔ∏è –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong>
        <ol style="margin: 8px 0 0 16px; padding: 0;">
          <li>–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ (–≥–æ–¥ –∏ –º–µ—Å—è—Ü)</li>
          <li>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –æ–∫–∞–∑–∞–Ω–Ω—ã–º —É—Å–ª—É–≥–∞–º</li>
          <li>–ù–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"</li>
        </ol>
      </div>

      <!-- Filters -->
      <div class="filters" style="margin-top: 24px;">
        <div class="ctl">
          <label for="year">–ì–æ–¥</label>
          <select id="year">
            <option value="2023">2023</option>
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
          </select>
        </div>

        <div class="ctl">
          <label for="month">–ú–µ—Å—è—Ü</label>
          <select id="month">
            <option value="1">–Ø–Ω–≤–∞—Ä—å</option>
            <option value="2">–§–µ–≤—Ä–∞–ª—å</option>
            <option value="3">–ú–∞—Ä—Ç</option>
            <option value="4">–ê–ø—Ä–µ–ª—å</option>
            <option value="5">–ú–∞–π</option>
            <option value="6">–ò—é–Ω—å</option>
            <option value="7">–ò—é–ª—å</option>
            <option value="8" selected>–ê–≤–≥—É—Å—Ç</option>
            <option value="9">–°–µ–Ω—Ç—è–±—Ä—å</option>
            <option value="10">–û–∫—Ç—è–±—Ä—å</option>
            <option value="11">–ù–æ—è–±—Ä—å</option>
            <option value="12">–î–µ–∫–∞–±—Ä—å</option>
          </select>
        </div>
      </div>

      <!-- Services table -->
      <div style="margin-top: 32px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h2 style="margin: 0;">–£—Å–ª—É–≥–∏</h2>
          <button id="btn-save" class="btn btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        </div>

        <div id="loading" class="alert alert-info">
          –ó–∞–≥—Ä—É–∑–∫–∞ —É—Å–ª—É–≥...
        </div>

        <div id="error" class="alert alert-error" style="display: none;"></div>

        <div id="success" class="alert alert-success" style="display: none;">
          ‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
        </div>

        <div id="services-table-container" style="display: none;">
          <table class="data-table">
            <thead>
              <tr>
                <th style="width: 50%;">–£—Å–ª—É–≥–∞</th>
                <th style="width: 20%;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                <th style="width: 30%;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–∫–∞–∑–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥</th>
              </tr>
            </thead>
            <tbody id="services-tbody">
              <!-- Rows will be generated dynamically -->
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script>
    const $ = (s) => document.querySelector(s);
    let currentUser = null;
    let servicesData = [];

    // Check auth
    async function checkAuth() {
      try {
        const r = await fetch('/api/auth/me', { credentials: 'include' });
        if (r.ok) {
          const data = await r.json();
          currentUser = data.user || data;

          if (currentUser.password_reset_required) {
            window.location.href = '/change-password.html?required=true';
            return false;
          }

          $('#user-name').textContent = currentUser.municipality_name || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
          return true;
        } else {
          window.location.href = '/';
          return false;
        }
      } catch (e) {
        console.error('checkAuth:', e);
        window.location.href = '/';
        return false;
      }
    }

    // Load services catalog
    async function loadServices() {
      try {
        $('#loading').style.display = 'block';
        $('#error').style.display = 'none';
        $('#services-table-container').style.display = 'none';

        const r = await fetch('/api/services-catalog', { credentials: 'include' });
        if (!r.ok) throw new Error('Failed to load services');

        servicesData = await r.json();

        if (servicesData.length === 0) {
          $('#loading').innerHTML = '‚ö†Ô∏è –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —É—Å–ª—É–≥ –ø—É—Å—Ç. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.';
          return;
        }

        // Load existing values
        await loadExistingValues();

        renderServicesTable();
        $('#loading').style.display = 'none';
        $('#services-table-container').style.display = 'block';
      } catch (e) {
        console.error('loadServices:', e);
        $('#loading').style.display = 'none';
        $('#error').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —É—Å–ª—É–≥: ' + e.message;
        $('#error').style.display = 'block';
      }
    }

    // Load existing values for selected period
    async function loadExistingValues() {
      try {
        const year = $('#year').value;
        const month = $('#month').value;
        const municipalityId = currentUser.municipality_id;

        if (!municipalityId) return; // Admin - no existing values

        const r = await fetch(
          `/api/service-values?year=${year}&month=${month}&municipality_id=${municipalityId}`,
          { credentials: 'include' }
        );

        if (!r.ok) return; // No existing values

        const values = await r.json();

        // Update servicesData with existing values
        values.forEach(v => {
          const service = servicesData.find(s => s.id === v.service_id);
          if (service) {
            service.value = v.value_numeric;
          }
        });
      } catch (e) {
        console.error('loadExistingValues:', e);
      }
    }

    // Render services table
    function renderServicesTable() {
      const tbody = $('#services-tbody');
      tbody.innerHTML = '';

      servicesData.forEach((service, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${service.name}</td>
          <td><span class="badge">${service.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}</span></td>
          <td>
            <input
              type="number"
              class="input-value"
              id="service-${service.id}"
              data-service-id="${service.id}"
              value="${service.value || ''}"
              min="0"
              step="1"
              placeholder="0"
            />
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Save data
    async function saveData() {
      try {
        $('#success').style.display = 'none';
        $('#error').style.display = 'none';

        const year = parseInt($('#year').value);
        const month = parseInt($('#month').value);
        const municipalityId = currentUser.municipality_id;

        if (!municipalityId) {
          $('#error').textContent = '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–µ –º–æ–∂–µ—Ç –≤–Ω–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ';
          $('#error').style.display = 'block';
          return;
        }

        // Collect values
        const values = [];
        document.querySelectorAll('.input-value').forEach(input => {
          const serviceId = parseInt(input.dataset.serviceId);
          const value = parseFloat(input.value) || 0;

          values.push({
            service_id: serviceId,
            value_numeric: value
          });
        });

        const payload = {
          municipality_id: municipalityId,
          period_year: year,
          period_month: month,
          values: values
        };

        console.log('Saving services data:', payload);

        const r = await fetch('/api/service-values/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });

        if (!r.ok) {
          const err = await r.json();
          throw new Error(err.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        }

        const result = await r.json();
        $('#success').textContent = `‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${result.saved} –∑–∞–ø–∏—Å–µ–π`;
        $('#success').style.display = 'block';

        // Scroll to success message
        $('#success').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } catch (e) {
        console.error('saveData:', e);
        $('#error').textContent = '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + e.message;
        $('#error').style.display = 'block';
        $('#error').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }

    // Event listeners
    $('#btn-save').addEventListener('click', saveData);
    $('#year').addEventListener('change', loadServices);
    $('#month').addEventListener('change', loadServices);

    // Initialize
    (async function init() {
      const isAuth = await checkAuth();
      if (isAuth) {
        loadServices();
      }
    })();
  </script>
  <script src="/theme.js"></script>
</body>
</html>
