<!doctype html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–ì–ò–ë–î–î ‚Äî –î–¢–ü</title>
  <link rel="stylesheet" href="/no-badge.css"/>

  <style>
    :root{
      color-scheme: dark light;
      --bg:#0a0d12; --bg-2:#12161c; --bg-3:#1a1d24;
      --text:#e8eef7; --muted:#9fb0c9; --muted-2:#6a7789;
      --border:#2b3444; --accent:#2563eb; --accent-2:#8ab4ff;
    }
    :root[data-theme="light"]{
      --bg:#ffffff; --bg-2:#f8fafc; --bg-3:#eef2f7;
      --text:#0f172a; --muted:#475569; --muted-2:#64748b;
      --border:#e2e8f0; --accent:#2563eb; --accent-2:#1d4ed8;
    }
    *{box-sizing:border-box}
    body{margin:0; font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; background:var(--bg); color:var(--text)}

    /* Header (—É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å –≥–ª–∞–≤–Ω–æ–π) */
    .app-header{position:sticky; top:0; z-index:10; background:var(--bg-2); border-bottom:1px solid var(--border)}
    .toolbar{
      margin:12px auto; padding:12px 16px; max-width:1400px;
      display:grid; grid-template-columns:1fr 200px 200px; gap:12px; align-items:center;
    }
    .user-link{
      color:var(--accent-2); font-weight:700; text-decoration:none; height:40px;
      display:flex; align-items:center; padding:0 4px;
    }
    .user-link:hover{text-decoration:underline}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      height:40px; width:200px; padding:0 16px; border-radius:10px;
      background:var(--bg-3); border:1px solid var(--border); color:var(--text);
      font-weight:600; cursor:pointer; transition:background .15s ease, transform .02s ease;
    }
    .btn:hover{background:color-mix(in oklab, var(--bg-3) 80%, var(--accent) 20%)}
    .btn:active{transform:translateY(1px)}
    .btn:focus-visible{outline:2px solid var(--accent); outline-offset:2px}
    .icon{font-size:16px}

    @media (max-width:720px){
      .toolbar{grid-template-columns:1fr; grid-auto-rows:1fr}
      .btn{width:100%}
    }

    /* Page intro */
    .page-head{max-width:1400px; margin:0 auto; padding:0 16px 12px}
    .title{margin:0 0 4px; font-size:26px}
    .subtitle{margin:0; color:var(--muted); font-size:14px}
    .back{display:inline-block; margin:0 0 6px; color:var(--accent-2); text-decoration:none}
    .back:hover{text-decoration:underline}

    /* Upload (admin only) */
    .section{max-width:1400px; margin:16px auto; padding:0 16px}
    .upload{background:var(--bg-2); border:1px solid var(--border); border-radius:12px; padding:20px}
    .upload h2{margin:0 0 8px}
    .drop{
      background:var(--bg); border:2px dashed var(--border); border-radius:12px; padding:28px; text-align:center;
      transition:border-color .2s ease, background .2s ease;
    }
    .drop.dragover{border-color:var(--accent); background:var(--bg-3)}
    .upload input[type=file]{display:none}
    .upload .pick{background:linear-gradient(135deg,#1b6fff,#1554d1); color:#fff; border:0; border-radius:10px; height:44px; padding:0 18px; font-weight:700; cursor:pointer}
    .note{color:var(--muted); margin-top:10px; font-size:13px}
    .result{margin-top:12px; display:none; padding:10px 12px; border-radius:10px; font-size:14px}
    .result.ok{display:block; background:#12381a; color:#83d089; border:1px solid #1f5b2d}
    .result.err{display:block; background:#3b1220; color:#ffa0b0; border:1px solid #6e1f37}

    /* Filters */
    .filters{max-width:1400px; margin:16px auto; padding:0 16px}
    .filter-box{
      background:var(--bg-2); border:1px solid var(--border); border-radius:12px; padding:16px;
      display:flex; gap:12px; flex-wrap:wrap; align-items:end;
    }
    .fg{display:flex; flex-direction:column; gap:6px; min-width:200px}
    label{font-size:13px; font-weight:600; color:var(--muted)}
    select{
      background:var(--bg); border:1px solid var(--border); border-radius:8px; color:var(--text);
      height:40px; padding:0 10px;
    }
    select:focus{outline:none; border-color:var(--accent)}
    .btn-ghost{height:40px; padding:0 16px; border-radius:10px; background:var(--bg-3); border:1px solid var(--border); color:var(--text); cursor:pointer}
    .btn-ghost:hover{background:color-mix(in oklab, var(--bg-3) 80%, var(--accent) 20%)}

    /* Table */
    .table-wrap{max-width:1400px; margin:16px auto; padding:0 16px}
    .table{
      background:var(--bg-2); border:1px solid var(--border); border-radius:12px; overflow:auto; max-height:620px;
    }
    table{width:100%; border-collapse:collapse}
    th{
      position:sticky; top:0; z-index:1; background:var(--bg-3); color:var(--muted); font-size:12px; text-transform:uppercase;
      letter-spacing:.5px; text-align:left; padding:12px; box-shadow:0 2px 4px rgba(0,0,0,.2);
    }
    td{padding:12px; border-top:1px solid var(--border)}
    tr:hover{background:var(--bg-3)}
    .center{text-align:center; color:var(--muted-2); padding:36px}

    .totals{background:var(--bg-3); font-weight:700; border-bottom:2px solid var(--border)}
  </style>
</head>

<body>
  <!-- –®–ê–ü–ö–ê -->
  <header class="app-header" role="banner">
    <div class="toolbar" role="group" aria-label="–ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π">
      <a class="user-link" id="user-link" href="/">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>

      <button id="themeBtn" class="btn" type="button" aria-pressed="false" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
        <span class="icon" aria-hidden="true">üåô</span>
        <span class="label">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</span>
      </button>

      <button id="btn-logout" class="btn" type="button">–í—ã–π—Ç–∏</button>
    </div>
  </header>

  <!-- –¢–ò–¢–£–õ -->
  <div class="page-head">
    <h1 class="title">üöó –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ì–ò–ë–î–î ‚Äî –î–¢–ü</h1>
    <p class="subtitle">–î–∞–Ω–Ω—ã–µ –ø–æ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–∞–º –õ–∏–ø–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏</p>
  </div>

  <!-- UPLOAD (ADMIN) -->
  <section class="section">
    <div id="upload" class="upload" hidden>
      <h2>üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ì–ò–ë–î–î</h2>
      <p class="note">–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel-—Ñ–∞–π–ª —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –î–¢–ü (–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω –ì–ò–ë–î–î).</p>

      <div id="drop" class="drop">
        <input id="file" type="file" accept=".xlsx,.xls"/>
        <p class="note">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É</p>
        <button id="pick" class="pick">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
        <p id="fname" class="note" style="margin-top:8px"></p>
      </div>

      <div id="uresult" class="result"></div>
    </div>
  </section>

  <!-- –§–ò–õ–¨–¢–†–´ -->
  <section class="filters">
    <div class="filter-box">
      <div class="fg">
        <label for="period">–ü–µ—Ä–∏–æ–¥</label>
        <select id="period"><option>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</option></select>
      </div>
      <button id="refresh" class="btn-ghost" type="button">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
  </section>

  <!-- –¢–ê–ë–õ–ò–¶–ê -->
  <section class="table-wrap">
    <div class="table">
      <div id="data" class="center">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö‚Ä¶</div>
    </div>
  </section>

  <script>
    const $ = s => document.querySelector(s);
    let currentUser = null;

    /* ===== –¢–ï–ú–ê ===== */
    (function setupTheme(){
      const root = document.documentElement;
      const btn  = $('#themeBtn');
      const saved = localStorage.getItem('theme');
      const prefersDark = matchMedia('(prefers-color-scheme: dark)').matches;
      apply(saved || (prefersDark ? 'dark' : 'dark'));
      btn.addEventListener('click', ()=>{
        const next = root.dataset.theme === 'dark' ? 'light' : 'dark';
        apply(next); localStorage.setItem('theme', next);
      });
      function apply(theme){
        root.dataset.theme = theme;
        const isDark = theme === 'dark';
        btn.setAttribute('aria-pressed', String(isDark));
        btn.querySelector('.icon').textContent  = isDark ? 'üåô' : 'üåû';
        btn.querySelector('.label').textContent = isDark ? '–¢—ë–º–Ω–∞—è —Ç–µ–º–∞' : '–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';
      }
    })();

    /* ===== AUTH ===== */
    async function checkAuth(){
      try{
        const r = await fetch('/api/auth/me',{credentials:'include'});
        if(!r.ok){ location.href = '/'; return false; }
        const data = await r.json();
        currentUser = data.user || data;
        if(currentUser?.password_reset_required){
          location.href = '/change-password.html?required=true';
          return false;
        }
        // user name in header left (link stays to home)
        $('#user-link').textContent = (currentUser.role === 'governor')
          ? '–ì—É–±–µ—Ä–Ω–∞—Ç–æ—Ä ‚Äî –Ω–∞ –≥–ª–∞–≤–Ω—É—é'
          : (currentUser.municipality_name || '–ù–∞ –≥–ª–∞–≤–Ω—É—é');

        // show upload only for admin
        if(currentUser.role === 'admin') $('#upload').hidden = false;

        return true;
      }catch(e){
        console.error(e); location.href='/'; return false;
      }
    }

    /* ===== PERIODS ===== */
    async function loadPeriods(){
      try{
        const r = await fetch('/api/gibdd/periods',{credentials:'include'});
        if(!r.ok) throw new Error('failed');
        const rows = await r.json();
        const sel = $('#period');
        sel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ ‚Äî</option>';
        rows.forEach(p=>{
          const o = document.createElement('option');
          o.value = p.period; o.textContent = p.period_name; sel.appendChild(o);
        });
        if(rows.length){ sel.value = rows[0].period; await loadData(); }
      }catch(e){
        console.error(e);
        $('#period').innerHTML = '<option value="">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</option>';
      }
    }

    /* ===== DATA ===== */
    async function loadData(){
      const period = $('#period').value;
      if(!period){ $('#data').className='center'; $('#data').textContent='–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥'; return; }
      try{
        $('#data').className='center'; $('#data').textContent='–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö‚Ä¶';
        const r = await fetch(`/api/gibdd/data?period=${encodeURIComponent(period)}`,{credentials:'include'});
        if(!r.ok) throw new Error('load error');
        const rows = await r.json();
        renderTable(rows);
      }catch(e){
        console.error(e);
        $('#data').className='center'; $('#data').textContent='–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
      }
    }

    function renderTable(rows){
      if(!rows?.length){ $('#data').className='center'; $('#data').textContent='–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥'; return; }

      const tot = {dtp_total:0, dtp_total_dead:0, dtp_total_injured:0, dtp_pedestrians:0, dtp_children_16:0, dtp_children_18:0, dtp_in_settlements:0, dtp_outside_settlements:0};
      rows.forEach(r=>{
        tot.dtp_total              += +r.dtp_total              || 0;
        tot.dtp_total_dead         += +r.dtp_total_dead         || 0;
        tot.dtp_total_injured      += +r.dtp_total_injured      || 0;
        tot.dtp_pedestrians        += +r.dtp_pedestrians        || 0;
        tot.dtp_children_16        += +r.dtp_children_16        || 0;
        tot.dtp_children_18        += +r.dtp_children_18        || 0;
        tot.dtp_in_settlements     += +r.dtp_in_settlements     || 0;
        tot.dtp_outside_settlements+= +r.dtp_outside_settlements|| 0;
      });

      const esc = s => (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

      const html = `
        <table>
          <thead>
            <tr>
              <th>–ú—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç</th>
              <th>–î–¢–ü</th>
              <th>–ü–æ–≥–∏–±–ª–æ</th>
              <th>–†–∞–Ω–µ–Ω–æ</th>
              <th>–ü–µ—à–µ—Ö–æ–¥—ã</th>
              <th>–î–µ—Ç–∏ (&lt;16)</th>
              <th>–î–µ—Ç–∏ (&lt;18)</th>
              <th>–í –Ω–∞—Å–µ–ª—ë–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–∞—Ö</th>
              <th>–í–Ω–µ –Ω–∞—Å–µ–ª—ë–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤</th>
            </tr>
          </thead>
          <tbody>
            <tr class="totals">
              <td><strong>–õ–∏–ø–µ—Ü–∫–∞—è –æ–±–ª–∞—Å—Ç—å</strong></td>
              <td>${tot.dtp_total}</td>
              <td>${tot.dtp_total_dead}</td>
              <td>${tot.dtp_total_injured}</td>
              <td>${tot.dtp_pedestrians}</td>
              <td>${tot.dtp_children_16}</td>
              <td>${tot.dtp_children_18}</td>
              <td>${tot.dtp_in_settlements}</td>
              <td>${tot.dtp_outside_settlements}</td>
            </tr>
            ${rows.map(r=>`
              <tr>
                <td><strong>${esc(r.municipality_name)}</strong></td>
                <td>${r.dtp_total ?? '-'}</td>
                <td>${r.dtp_total_dead ?? '-'}</td>
                <td>${r.dtp_total_injured ?? '-'}</td>
                <td>${r.dtp_pedestrians ?? '-'}</td>
                <td>${r.dtp_children_16 ?? '-'}</td>
                <td>${r.dtp_children_18 ?? '-'}</td>
                <td>${r.dtp_in_settlements ?? '-'}</td>
                <td>${r.dtp_outside_settlements ?? '-'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>`;
      $('#data').className=''; $('#data').innerHTML = html;
    }

    /* ===== UPLOAD (admin) ===== */
    const pick = $('#pick'), file = $('#file'), drop = $('#drop'), fname = $('#fname'), uresult = $('#uresult');

    pick?.addEventListener('click', ()=> file.click());
    file?.addEventListener('change', e => { const f=e.target.files[0]; if(f){ fname.textContent=`–í—ã–±—Ä–∞–Ω: ${f.name}`; upload(f); } });

    drop?.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('dragover'); });
    drop?.addEventListener('dragleave', ()=> drop.classList.remove('dragover'));
    drop?.addEventListener('drop', e=>{
      e.preventDefault(); drop.classList.remove('dragover');
      const f = e.dataTransfer.files[0]; if(f){ fname.textContent=`–í—ã–±—Ä–∞–Ω: ${f.name}`; upload(f); }
    });

    async function upload(f){
      try{
        pick.disabled = true; pick.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶'; uresult.className='result'; uresult.style.display='none';

        const fd = new FormData(); fd.append('file', f);
        const resp = await fetch('/api/gibdd/upload',{method:'POST',credentials:'include',body:fd});
        const out  = await resp.json().catch(()=>({}));

        if(resp.ok){
          uresult.className='result ok'; uresult.style.display='block';
          uresult.innerHTML = `‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ<br>–ü–µ—Ä–∏–æ–¥: ${out.period}<br>–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${out.imported}${out.errors?.length?`<br>‚ö†Ô∏è –û—à–∏–±–∫–∏: ${out.errors.length}`:''}${out.skipped?.length?`<br>–ü—Ä–æ–ø—É—â–µ–Ω–æ: ${out.skipped.length}`:''}`;
          file.value=''; fname.textContent='';
          await loadPeriods();
        }else{
          throw new Error(out.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
        }
      }catch(e){
        uresult.className='result err'; uresult.style.display='block'; uresult.textContent = `‚ùå ${e.message}`;
      }finally{
        pick.disabled = false; pick.textContent = '–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª';
      }
    }

    /* ===== EVENTS ===== */
    $('#period').addEventListener('change', loadData);
    $('#refresh').addEventListener('click', loadData);
    $('#btn-logout').addEventListener('click', async()=>{ try{await fetch('/api/auth/logout',{method:'POST',credentials:'include'})}finally{location.href='/'}});

    /* ===== INIT ===== */
    (async function init(){
      if(!(await checkAuth())) return;
      await loadPeriods();
    })();
  </script>
</body>
</html>
