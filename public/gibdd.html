<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ì–ò–ë–î–î - –î–¢–ü</title>
  <style>
    :root {
      color-scheme: dark light;
      --bg-primary: #0a0d12;
      --bg-secondary: #12161c;
      --bg-tertiary: #1a1d24;
      --border-primary: #2b3444;
      --text-primary: #e8eef7;
      --text-secondary: #9fb0c9;
      --text-muted: #6a7789;
      --accent-blue: #5a8fff;
      --accent-blue-light: #8ab4ff;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-primary);
      padding: 24px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1400px;
      margin: auto;
    }

    h1 {
      margin: 0 0 8px 0;
      font-size: 28px;
      color: var(--text-primary);
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 14px;
      margin: 0;
    }

    main {
      max-width: 1400px;
      margin: auto;
      padding: 24px;
    }

    a {
      color: var(--accent-blue-light);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    /* Upload Section (Admin Only) */
    .upload-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 32px;
    }

    .upload-section h2 {
      margin-top: 0;
      color: var(--text-primary);
      font-size: 20px;
    }

    .upload-box {
      border: 2px dashed var(--border-primary);
      border-radius: 12px;
      padding: 32px;
      text-align: center;
      background: var(--bg-primary);
      transition: all 0.3s;
    }

    .upload-box.dragover {
      border-color: var(--accent-blue);
      background: var(--bg-tertiary);
    }

    .upload-box input[type="file"] {
      display: none;
    }

    .upload-btn {
      background: linear-gradient(135deg, #1b6fff 0%, #1554d1 100%);
      color: #fff;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .upload-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(27, 111, 255, 0.4);
    }

    .upload-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .upload-result {
      margin-top: 16px;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
    }

    .upload-result.success {
      background: #1a3a1a;
      color: #6fb36f;
      border: 1px solid #2a5a2a;
    }

    .upload-result.error {
      background: #2a1620;
      color: #ff8a8a;
      border: 1px solid #6a1b2a;
    }

    /* Filters */
    .filters {
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: flex-end;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 200px;
    }

    label {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    select {
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      color: var(--text-primary);
      padding: 10px 12px;
      font-size: 14px;
    }

    select:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    button.secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-primary);
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }

    button.secondary:hover {
      background: var(--border-primary);
    }

    /* Table */
    .table-container {
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 24px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      font-weight: 600;
      padding: 12px;
      text-align: left;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    td {
      padding: 12px;
      border-top: 1px solid var(--border-primary);
      color: var(--text-primary);
    }

    tr:hover {
      background: var(--bg-tertiary);
    }

    .loading,
    .empty {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .hidden {
      display: none !important;
    }

    /* User info */
    .user-info {
      margin-top: 12px;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      font-size: 14px;
    }

    .user-info strong {
      color: var(--accent-blue-light);
    }
  </style>
</head>
<body>
<header>
  <div class="header-content">
    <a href="/">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    <h1>üöó –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ì–ò–ë–î–î - –î–¢–ü</h1>
    <p class="subtitle">–î–∞–Ω–Ω—ã–µ –æ –¥–æ—Ä–æ–∂–Ω–æ-—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö –ø—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏—è—Ö –ø–æ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–∞–º –õ–∏–ø–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏</p>
    <div id="user-info" class="user-info hidden">
      <strong id="user-name"></strong> (<span id="user-role"></span>)
    </div>
  </div>
</header>

<main>
  <!-- Upload Section (Admin Only) -->
  <div id="upload-section" class="upload-section hidden">
    <h2>üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ì–ò–ë–î–î</h2>
    <p style="color:var(--text-secondary);margin-bottom:16px">
      –ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel —Ñ–∞–π–ª —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –î–¢–ü. –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω—É –ì–ò–ë–î–î.
    </p>

    <div class="upload-box" id="upload-box">
      <input type="file" id="gibdd-file" accept=".xlsx,.xls" />
      <p style="color:var(--text-secondary);margin-bottom:16px">üìÑ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É</p>
      <button class="upload-btn" id="upload-btn">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
      <p id="file-name" style="color:var(--accent-blue-light);margin-top:12px;font-size:13px"></p>
    </div>

    <div id="upload-result" class="upload-result"></div>
  </div>

  <!-- Filters -->
  <div class="filters">
    <div class="filter-group">
      <label for="period">–ü–µ—Ä–∏–æ–¥</label>
      <select id="period">
        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
      </select>
    </div>

    <div class="filter-group">
      <button class="secondary" id="btn-refresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
  </div>

  <!-- Data Table -->
  <div class="table-container">
    <div id="data-container">
      <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    </div>
  </div>
</main>

<script>
const $ = (s) => document.querySelector(s);
let currentUser = null;

/* ===== Auth Check ===== */
async function checkAuth() {
  try {
    const r = await fetch('/api/auth/me', { credentials: 'include' });
    if (r.ok) {
      const data = await r.json();
      currentUser = data.user || data;

      // Check password reset
      if (currentUser.password_reset_required) {
        window.location.href = '/change-password.html?required=true';
        return false;
      }

      updateUI();
      return true;
    } else {
      window.location.href = '/';
      return false;
    }
  } catch (e) {
    console.error('checkAuth:', e);
    window.location.href = '/';
    return false;
  }
}

function updateUI() {
  $('#user-name').textContent = currentUser.municipality_name || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
  $('#user-role').textContent = currentUser.role;
  $('#user-info').classList.remove('hidden');

  // Show upload section only for admin
  if (currentUser.role === 'admin') {
    $('#upload-section').classList.remove('hidden');
  }
}

/* ===== Load Periods ===== */
async function loadPeriods() {
  try {
    const r = await fetch('/api/gibdd/periods', { credentials: 'include' });
    if (!r.ok) throw new Error('Failed to load');

    const rows = await r.json();
    const sel = $('#period');
    sel.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥</option>';

    rows.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.period;
      opt.textContent = p.period_name;
      sel.appendChild(opt);
    });

    // Select first period if available
    if (rows.length > 0) {
      sel.value = rows[0].period;
      loadData();
    }
  } catch (e) {
    console.error('loadPeriods:', e);
    $('#period').innerHTML = '<option value="">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</option>';
  }
}

/* ===== Load Data ===== */
async function loadData() {
  const period = $('#period').value;

  if (!period) {
    $('#data-container').innerHTML = '<div class="empty">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥</div>';
    return;
  }

  try {
    $('#data-container').innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>';

    const r = await fetch(`/api/gibdd/data?period=${period}`, { credentials: 'include' });
    if (!r.ok) throw new Error('Failed to load');

    const rows = await r.json();
    renderTable(rows);

  } catch (e) {
    console.error('loadData:', e);
    $('#data-container').innerHTML = '<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
  }
}

/* ===== Render Table ===== */
function renderTable(rows) {
  if (rows.length === 0) {
    $('#data-container').innerHTML = '<div class="empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>';
    return;
  }

  // Calculate totals for Lipetsk Oblast
  const totals = {
    dtp_total: 0,
    dtp_total_dead: 0,
    dtp_total_injured: 0,
    dtp_pedestrians: 0,
    dtp_children_16: 0,
    dtp_children_18: 0,
    dtp_in_settlements: 0,
    dtp_outside_settlements: 0
  };

  rows.forEach(row => {
    totals.dtp_total += Number(row.dtp_total || 0);
    totals.dtp_total_dead += Number(row.dtp_total_dead || 0);
    totals.dtp_total_injured += Number(row.dtp_total_injured || 0);
    totals.dtp_pedestrians += Number(row.dtp_pedestrians || 0);
    totals.dtp_children_16 += Number(row.dtp_children_16 || 0);
    totals.dtp_children_18 += Number(row.dtp_children_18 || 0);
    totals.dtp_in_settlements += Number(row.dtp_in_settlements || 0);
    totals.dtp_outside_settlements += Number(row.dtp_outside_settlements || 0);
  });

  const html = `
    <table>
      <thead>
        <tr>
          <th>–ú—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç</th>
          <th>–î–¢–ü</th>
          <th>–ü–æ–≥–∏–±–ª–æ</th>
          <th>–†–∞–Ω–µ–Ω–æ</th>
          <th>–ü–µ—à–µ—Ö–æ–¥—ã</th>
          <th>–î–µ—Ç–∏ (&lt;16)</th>
          <th>–î–µ—Ç–∏ (&lt;18)</th>
          <th>–í –Ω–∞—Å. –ø—É–Ω–∫—Ç–∞—Ö</th>
          <th>–í–Ω–µ –Ω–∞—Å. –ø—É–Ω–∫—Ç–æ–≤</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(row => `
          <tr>
            <td><strong>${escapeHtml(row.municipality_name)}</strong></td>
            <td>${row.dtp_total || 0}</td>
            <td>${row.dtp_total_dead || 0}</td>
            <td>${row.dtp_total_injured || 0}</td>
            <td>${row.dtp_pedestrians || 0}</td>
            <td>${row.dtp_children_16 || 0}</td>
            <td>${row.dtp_children_18 || 0}</td>
            <td>${row.dtp_in_settlements || 0}</td>
            <td>${row.dtp_outside_settlements || 0}</td>
          </tr>
        `).join('')}
        <tr style="background: var(--bg-tertiary); font-weight: bold; border-top: 2px solid var(--border-primary);">
          <td><strong>–õ–∏–ø–µ—Ü–∫–∞—è –æ–±–ª–∞—Å—Ç—å</strong></td>
          <td>${totals.dtp_total}</td>
          <td>${totals.dtp_total_dead}</td>
          <td>${totals.dtp_total_injured}</td>
          <td>${totals.dtp_pedestrians}</td>
          <td>${totals.dtp_children_16}</td>
          <td>${totals.dtp_children_18}</td>
          <td>${totals.dtp_in_settlements}</td>
          <td>${totals.dtp_outside_settlements}</td>
        </tr>
      </tbody>
    </table>
  `;

  $('#data-container').innerHTML = html;
}

function escapeHtml(str) {
  return (str || '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
}

/* ===== Upload (Admin Only) ===== */
const uploadBox = $('#upload-box');
const uploadBtn = $('#upload-btn');
const fileInput = $('#gibdd-file');
const fileName = $('#file-name');
const uploadResult = $('#upload-result');

uploadBtn.addEventListener('click', () => {
  fileInput.click();
});

fileInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  fileName.textContent = `–í—ã–±—Ä–∞–Ω: ${file.name}`;
  await uploadFile(file);
});

uploadBox.addEventListener('dragover', (e) => {
  e.preventDefault();
  uploadBox.classList.add('dragover');
});

uploadBox.addEventListener('dragleave', () => {
  uploadBox.classList.remove('dragover');
});

uploadBox.addEventListener('drop', async (e) => {
  e.preventDefault();
  uploadBox.classList.remove('dragover');

  const file = e.dataTransfer.files[0];
  if (!file) return;

  fileName.textContent = `–í—ã–±—Ä–∞–Ω: ${file.name}`;
  await uploadFile(file);
});

async function uploadFile(file) {
  try {
    uploadBtn.disabled = true;
    uploadBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    uploadResult.style.display = 'none';

    const formData = new FormData();
    formData.append('file', file);

    const response = await fetch('/api/gibdd/upload', {
      method: 'POST',
      credentials: 'include',
      body: formData
    });

    const result = await response.json();

    if (response.ok) {
      uploadResult.className = 'upload-result success';
      uploadResult.style.display = 'block';
      uploadResult.innerHTML = `
        ‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!<br>
        –ü–µ—Ä–∏–æ–¥: ${result.period}<br>
        –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${result.imported}<br>
        ${result.errors.length > 0 ? `‚ö†Ô∏è –û—à–∏–±–æ–∫: ${result.errors.length}` : ''}
        ${result.skipped.length > 0 ? `<br>–ü—Ä–æ–ø—É—â–µ–Ω–æ: ${result.skipped.length}` : ''}
      `;

      fileInput.value = '';
      fileName.textContent = '';

      // Reload periods and data
      await loadPeriods();

    } else {
      throw new Error(result.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
    }

  } catch (error) {
    console.error('Upload error:', error);
    uploadResult.className = 'upload-result error';
    uploadResult.style.display = 'block';
    uploadResult.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
  } finally {
    uploadBtn.disabled = false;
    uploadBtn.textContent = '–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª';
  }
}

/* ===== Event Listeners ===== */
$('#period').addEventListener('change', loadData);
$('#btn-refresh').addEventListener('click', loadData);

/* ===== Init ===== */
(async function init() {
  const isAuth = await checkAuth();
  if (!isAuth) return;

  await loadPeriods();
})();
</script>
</body>
</html>
