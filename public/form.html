<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Форма 1-ГМУ</title>
  <style>
    :root{
      color-scheme: dark light;
      --bg-primary: #0a0d12;
      --bg-secondary: #12161c;
      --bg-tertiary: #1a1d24;
      --border-primary: #2b3444;
      --border-secondary: #232a36;
      --accent-blue: #5a8fff;
      --accent-blue-light: #8ab4ff;
      --text-primary: #e8eef7;
      --text-secondary: #9fb0c9;
      --text-muted: #6a7789;

      /* динамический отступ для липкого thead */
      --sticky-top: 0px;
    }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:var(--bg-primary);
      color:var(--text-primary);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    header{
      position:sticky;
      top:0;
      z-index:100;
      background:linear-gradient(180deg, #0f1115 0%, #0d0f13 100%);
      border-bottom:1px solid #232a36;
      padding:24px;
      max-width:1100px;
      margin:auto;
      box-shadow:0 4px 20px rgba(0,0,0,0.4), 0 8px 40px rgba(0,0,0,0.2);
    }

    h1{
      background:linear-gradient(135deg, #8ab4ff 0%, #5a8fff 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      font-size:28px;
      font-weight:700;
      margin:8px 0 16px 0;
      letter-spacing:-0.5px;
      filter:drop-shadow(0 2px 4px rgba(90,143,255,0.3));
    }

    main{max-width:1100px;margin:auto;padding:24px}
    a{color:#8ab4ff;text-decoration:none;transition:color .2s}
    a:hover{color:#a8c8ff;text-decoration:underline}

    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .ctl{display:flex;flex-direction:column;gap:6px;position:relative}

    label{
      font-size:13px;font-weight:500;color:var(--text-secondary);
      letter-spacing:.3px;display:flex;align-items:center;gap:6px;transition:color .2s ease;
    }
    label::before{
      content:'';display:inline-block;width:4px;height:4px;background:var(--accent-blue);
      border-radius:50%;animation:pulse 2s ease-in-out infinite;
    }
    @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(.85)}}
    .ctl:focus-within label{color:var(--accent-blue-light)}
    .ctl:focus-within label::before{animation:none;box-shadow:0 0 6px var(--accent-blue)}

    select,input[type="number"],input[type="month"]{
      background:#12161c;border:1px solid #2b3444;border-radius:10px;color:#e8eef7;
      padding:12px 14px;min-width:220px;transition:all .3s ease;
      box-shadow:0 2px 8px rgba(0,0,0,.2), inset 0 1px 2px rgba(0,0,0,.1);
    }
    select:focus,input[type="number"]:focus,input[type="month"]:focus{
      outline:none;border-color:#5a8fff;
      box-shadow:0 0 0 3px rgba(90,143,255,.15), 0 6px 16px rgba(0,0,0,.4), 0 0 20px rgba(90,143,255,.1);
      background:#151a22;transform:translateY(-1px);
    }
    select:hover,input[type="number"]:hover,input[type="month"]:hover{
      border-color:#3a5488;box-shadow:0 4px 12px rgba(0,0,0,.25), inset 0 1px 2px rgba(0,0,0,.1);
    }

    button{
      background:linear-gradient(135deg,#1b6fff 0%,#1554d1 100%);border:0;color:#fff;padding:12px 20px;
      border-radius:10px;cursor:pointer;font-weight:600;transition:all .3s ease;position:relative;overflow:hidden;
      box-shadow:0 4px 12px rgba(27,111,255,.3), 0 2px 6px rgba(0,0,0,.2), inset 0 1px 0 rgba(255,255,255,.1);
    }
    button::before{
      content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);transition:left .5s;
    }
    button:hover::before{left:100%}
    button:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(27,111,255,.45), 0 4px 10px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.15)}
    button:active{transform:translateY(-1px);box-shadow:0 2px 8px rgba(27,111,255,.35), 0 1px 4px rgba(0,0,0,.2)}
    button.secondary{background:linear-gradient(135deg,#1e2430 0%,#161b24 100%);box-shadow:0 4px 12px rgba(0,0,0,.3), 0 2px 6px rgba(0,0,0,.2), inset 0 1px 0 rgba(255,255,255,.05)}
    button.secondary:hover{transform:translateY(-3px);box-shadow:0 8px 18px rgba(0,0,0,.45), 0 4px 8px rgba(0,0,0,.3)}
    button.secondary:active{transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,.35)}
    button:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none}
    button:disabled:hover{transform:none}

    .banner{
      background:linear-gradient(135deg,#2a1620 0%,#1f1218 100%);border:1px solid #6a1b2a;color:#ffd6de;border-radius:10px;
      padding:14px 16px;margin:12px 0;display:none;animation:slideDown .3s ease;box-shadow:0 4px 12px rgba(0,0,0,.3);
    }
    .banner.success{background:linear-gradient(135deg,#1a2a20 0%,#141f18 100%);border-color:#2a6a3a;color:#d6ffd6}
    @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}

    table{
      width:100%;border-collapse:collapse;margin-top:16px;background:#12161c;border-radius:12px;overflow:hidden;
      box-shadow:0 4px 16px rgba(0,0,0,.3), 0 8px 32px rgba(0,0,0,.2), 0 1px 0 rgba(255,255,255,.05);
    }

    /* Липкий ВЕСЬ thead, а не th */
    thead{
      position:sticky;
      top:var(--sticky-top);
      z-index:60;
    }
    table thead th{
      position:relative; /* не sticky у ячеек */
      background:linear-gradient(180deg,#1a1f28 0%, #151a22 100%);
      color:#a7b3c6;font-weight:600;border-bottom:2px solid #2a3544;padding:14px 12px;
      text-transform:uppercase;font-size:12px;letter-spacing:.8px;
    }

    tbody tr{transition:background .2s ease, box-shadow .2s ease;}
    tbody tr:nth-child(even){background:#0f1318}
    tbody tr:hover{
      background:#1a2230;
      box-shadow:0 2px 8px rgba(90,143,255,.1), 0 4px 16px rgba(90,143,255,.05);
      /* без transform! */
    }

    td{border-bottom:1px solid #1a1f28;padding:12px;text-align:left}

    td input[type="number"]{
      min-width:120px;padding:8px 12px;background:#0a0d12;border:1px solid #2b3444;border-radius:8px;color:#e8eef7;
      transition:all .3s ease;box-shadow:inset 0 1px 2px rgba(0,0,0,.15);
    }
    td input[type="number"]:focus{
      outline:none;border-color:#5a8fff;box-shadow:0 0 0 3px rgba(90,143,255,.2), 0 4px 12px rgba(90,143,255,.15), 0 0 16px rgba(90,143,255,.1);
      background:#12161c;transform:translateY(-1px);
    }
    td input[type="number"]:hover{border-color:#3a5488;box-shadow:0 2px 8px rgba(0,0,0,.2), inset 0 1px 2px rgba(0,0,0,.15)}

    tfoot td{border:0;padding-top:16px}
    tbody.disabled{opacity:.4;pointer-events:none}

    ::-webkit-scrollbar{width:10px;height:10px}
    ::-webkit-scrollbar-track{background:var(--bg-primary)}
    ::-webkit-scrollbar-thumb{background:var(--border-primary);border-radius:5px;transition:background .2s}
    ::-webkit-scrollbar-thumb:hover{background:var(--accent-blue)}

    @keyframes successPulse{0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}
    .success-animation{animation:successPulse .5s ease-out}

    @keyframes spin{to{transform:rotate(360deg)}}
    .btn-loading{position:relative;pointer-events:none}
    .btn-loading::after{
      content:'';position:absolute;width:16px;height:16px;top:50%;left:50%;margin:-8px 0 0 -8px;border:2px solid rgba(255,255,255,.3);
      border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;
    }

    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    main{animation:fadeIn .5s ease-out}

    .auth-block{
      display:flex;align-items:center;gap:12px;margin-top:12px;padding:12px;background:rgba(26,29,36,.6);
      border-radius:8px;border:1px solid #2b3444;
    }
    .user-info{display:flex;align-items:center;gap:8px;flex:1}
    .user-email{color:var(--accent-blue-light);font-weight:600;font-size:14px}
    .user-role{background:rgba(90,143,255,.2);color:var(--accent-blue-light);padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600;text-transform:uppercase}
    .auth-block button{padding:8px 16px;font-size:14px}

    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1000;animation:fadeIn .2s ease}
    .modal-overlay.show{display:flex;align-items:center;justify-content:center}
    .modal{background:var(--bg-secondary);border:1px solid var(--border-primary);border-radius:12px;padding:32px;min-width:400px;max-width:90%;
      box-shadow:0 20px 60px rgba(0,0,0,.6);animation:slideDown .3s ease}
    .modal h2{margin:0 0 24px 0;color:var(--text-primary);font-size:24px}
    .modal .ctl{margin-bottom:16px}
    .modal input[type="email"],.modal input[type="password"]{
      width:100%;box-sizing:border-box;background:#0a0d12;border:1px solid #2b3444;border-radius:8px;color:#e8eef7;padding:12px 14px;transition:all .3s ease;
    }
    .modal input[type="email"]:focus,.modal input[type="password"]:focus{outline:none;border-color:#5a8fff;box-shadow:0 0 0 3px rgba(90,143,255,.15);background:#12161c}
    .modal-buttons{display:flex;gap:12px;margin-top:24px}
    .modal-buttons button{flex:1}
    .modal-error{color:#ff6b6b;font-size:14px;margin-top:12px;display:none}
    .modal-error.show{display:block}
  </style>
</head>
<body>
<header id="page-header">
  <a href="/" aria-label="На главную">← На главную</a>
  <h1>Форма 1-ГМУ (месячная периодичность)</h1>

  <div class="auth-block" id="auth-block">
    <div class="user-info" id="user-info" style="display:none">
      <span class="user-email" id="user-email"></span>
      <span class="user-role" id="user-role"></span>
      <a href="/admin" id="admin-link" style="display:none">Админ-панель</a>
    </div>
    <button id="btn-login" style="display:none">Войти</button>
    <button id="btn-logout" class="secondary" style="display:none">Выйти</button>
  </div>

  <div id="banner" class="banner"></div>

  <div class="row" style="margin-top:8px">
    <div class="ctl">
      <label for="period">Отчётный месяц</label>
      <input id="period" type="month" />
    </div>

    <div class="ctl">
      <label for="municipality">Муниципалитет</label>
      <select id="municipality"><option value="">Загрузка…</option></select>
    </div>

    <div class="ctl">
      <label for="service-category">Категория услуг</label>
      <select id="service-category"><option value="">Загрузка…</option></select>
    </div>

    <div class="ctl">
      <label for="service">Услуга</label>
      <select id="service" disabled><option value="">— выберите категорию —</option></select>
    </div>

    <div class="ctl" style="margin-left:auto;gap:8px">
      <label>&nbsp;</label>
      <div class="row">
        <button id="btn-save" disabled>Сохранить отчёт</button>
        <button id="btn-export" class="secondary" disabled>Скачать Excel</button>
        <button id="btn-import" class="secondary">Импорт из Excel</button>
        <button id="btn-clear" class="secondary" disabled>Очистить форму</button>
      </div>
    </div>
  </div>
</header>

<main>
  <input type="file" id="file-import" accept=".xlsx,.xls" style="display:none" />
  <table id="tbl">
    <thead>
      <tr>
        <th style="width:56px">№</th>
        <th>Показатель</th>
        <th style="width:120px">Ед.</th>
        <th style="width:160px">Значение</th>
      </tr>
    </thead>
    <tbody id="tbody" class="disabled">
      <tr><td colspan="4" style="text-align:center;color:#a7b3c6">Выберите услугу для заполнения показателей</td></tr>
    </tbody>
    <tfoot>
      <tr><td colspan="4" class="muted" style="color:#8aa1c0">Навигация: Enter/↓ — вниз, ↑ — вверх.</td></tr>
    </tfoot>
  </table>
</main>

<div class="modal-overlay" id="modal-login">
  <div class="modal">
    <h2>Авторизация</h2>
    <div class="ctl">
      <label for="login-municipality">Муниципалитет</label>
      <select id="login-municipality"><option value="">Загрузка...</option></select>
    </div>
    <div class="ctl">
      <label for="login-password">Пароль</label>
      <input type="password" id="login-password" />
    </div>
    <div class="modal-error" id="login-error"></div>
    <div class="modal-buttons">
      <button id="btn-modal-login">Войти</button>
      <button class="secondary" id="btn-modal-cancel">Отмена</button>
    </div>
  </div>
</div>

<script>
/* ===== helpers ===== */
const $ = (s)=>document.querySelector(s);
const banner = $('#banner');

/* ===== ДИНАМИЧЕСКИЙ ОТСТУП ДЛЯ ЛИПКИ ===== */
const rootEl = document.documentElement;
const headerEl = document.getElementById('page-header');

function updateStickyTop(){
  const h = headerEl ? Math.ceil(headerEl.getBoundingClientRect().height) : 0;
  rootEl.style.setProperty('--sticky-top', `${h}px`);
  console.debug('[sticky] --sticky-top =', getComputedStyle(rootEl).getPropertyValue('--sticky-top'));
}

window.addEventListener('load', updateStickyTop);
window.addEventListener('resize', updateStickyTop);
if ('fonts' in document) document.fonts.ready.then(updateStickyTop);
if ('ResizeObserver' in window && headerEl){
  new ResizeObserver(updateStickyTop).observe(headerEl);
}

/* баннер меняет высоту хедера — пересчитаем */
function showBanner(msg, isSuccess){
  if(!msg){banner.style.display='none'; updateStickyTop(); return;}
  banner.textContent = msg;
  banner.className = isSuccess ? 'banner success' : 'banner';
  banner.style.display='block';
  requestAnimationFrame(updateStickyTop);
}

/* ===== state ===== */
let indicators = [];
let currentUser = null;
let pendingRequest = null;

/* ===== auth ===== */
async function checkAuth(){
  try{
    const r = await fetch('/api/auth/me', {credentials: 'include'});
    if(r.ok){ currentUser = await r.json(); updateAuthUI(); return true; }
    currentUser = null; updateAuthUI(); return false;
  }catch(e){ console.error('checkAuth:', e); currentUser=null; updateAuthUI(); return false; }
}

function updateAuthUI(){
  const btnLogin = $('#btn-login');
  const btnLogout = $('#btn-logout');
  const userInfo = $('#user-info');
  const userEmail = $('#user-email');
  const userRole = $('#user-role');
  const adminLink = $('#admin-link');

  if(currentUser){
    btnLogin.style.display='none'; btnLogout.style.display='block'; userInfo.style.display='flex';
    userEmail.textContent = currentUser.municipality_name ? currentUser.municipality_name : 'Администратор';
    userRole.textContent = currentUser.role;
    adminLink.style.display = currentUser.role === 'admin' ? 'inline' : 'none';
  }else{
    btnLogin.style.display='block'; btnLogout.style.display='none'; userInfo.style.display='none';
  }
  requestAnimationFrame(updateStickyTop);
}

async function showLoginModal(){
  $('#modal-login').classList.add('show');
  $('#login-password').value='';
  $('#login-error').classList.remove('show');
  $('#login-error').textContent='';
  await loadLoginMunicipalities();
  setTimeout(()=>$('#login-municipality').focus(),100);
  requestAnimationFrame(updateStickyTop);
}

async function loadLoginMunicipalities(){
  try{
    const r = await fetch('/api/municipalities/all');
    if(!r.ok) throw new Error('Failed municipalities');
    const rows = await r.json();
    const sel = $('#login-municipality');
    sel.innerHTML = '<option value="">-- Выберите муниципалитет --</option><option value="admin">Администратор</option>';
    rows.forEach(row=>{
      const opt=document.createElement('option');opt.value=row.id;opt.textContent=row.name;sel.appendChild(opt);
    });
  }catch(e){
    console.error('loadLoginMunicipalities:', e);
    $('#login-municipality').innerHTML = '<option value="">Ошибка загрузки</option>';
  }
}

function hideLoginModal(){ $('#modal-login').classList.remove('show'); }

async function login(municipalityId, password){
  try{
    const r = await fetch('/api/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({municipality_id:municipalityId,password})});
    if(r.ok){
      const data = await r.json();
      currentUser = data.user; updateAuthUI(); hideLoginModal();
      showBanner('Успешная авторизация!', true); setTimeout(()=>showBanner(''),2000);
      await loadMunicipalities(); loadServiceCategories(); loadIndicators();
      if(pendingRequest){ const cb=pendingRequest; pendingRequest=null; cb(); }
      return true;
    }else{
      const error = await r.json().catch(()=>({error:'Ошибка авторизации'}));
      $('#login-error').textContent = error.error || 'Неверный муниципалитет или пароль';
      $('#login-error').classList.add('show'); return false;
    }
  }catch(e){
    console.error('login:', e);
    $('#login-error').textContent='Ошибка соединения с сервером';
    $('#login-error').classList.add('show'); return false;
  }
}

async function logout(){
  try{
    await fetch('/api/auth/logout',{method:'POST',credentials:'include'});
    currentUser=null; updateAuthUI(); showBanner('Вы вышли из системы', true); setTimeout(()=>showBanner(''),2000);
    await loadMunicipalities();
  }catch(e){ console.error('logout:', e); }
}

async function authFetch(url, options={}){
  const r = await fetch(url,{...options,credentials:'include'});
  if(r.status===401){ showLoginModal(); throw new Error('UNAUTHORIZED'); }
  return r;
}

/* ===== data ===== */
async function loadMunicipalities(){
  try{
    const r = await authFetch('/api/my/municipalities'); if(!r.ok) throw new Error('HTTP '+r.status);
    const rows = await r.json(); const sel = $('#municipality');
    if(rows.length===0){ sel.innerHTML='<option value="">Нет доступных муниципалитетов</option>'; sel.disabled=true; }
    else if(rows.length===1){ sel.innerHTML = `<option value="${rows[0].id}">${escapeHtml(rows[0].name)}</option>`; sel.value=rows[0].id; sel.disabled=true; }
    else { sel.innerHTML = '<option value="">— выберите —</option>' + rows.map(x=>`<option value="${x.id}">${escapeHtml(x.name)}</option>`).join(''); sel.disabled=false; }
  }catch(e){ if(e.message==='UNAUTHORIZED') return; console.error('loadMunicipalities:', e); showBanner('Ошибка загрузки муниципалитетов'); }
}

async function loadServiceCategories(){
  try{
    const r = await fetch('/api/service-categories'); if(!r.ok) throw new Error('HTTP '+r.status);
    const rows = await r.json(); const sel = $('#service-category');
    if(rows.length===0){ sel.innerHTML='<option value="">Категории не найдены</option>'; return; }
    sel.innerHTML = '<option value="">— выберите —</option>' + rows.map(x=>`<option value="${escapeHtml(x.category)}">${escapeHtml(x.category)} (${x.cnt})</option>`).join('');
  }catch(e){ console.error('loadServiceCategories:', e); }
}

async function loadServices(category){
  const sel = $('#service');
  try{
    if(!category){ sel.innerHTML='<option value="">— выберите категорию —</option>'; sel.disabled=true; updateTableState(); return; }
    const r = await fetch(`/api/services?category=${encodeURIComponent(category)}`); if(!r.ok) throw new Error('HTTP '+r.status);
    const rows = await r.json();
    sel.innerHTML = '<option value="">— выберите услугу —</option>' + rows.map(x=>`<option value="${x.id}">${escapeHtml(x.name)}</option>`).join('');
    sel.disabled=false; updateTableState();
  }catch(e){
    console.error('loadServices:', e); sel.innerHTML='<option value="">Ошибка загрузки услуг</option>'; sel.disabled=true; updateTableState();
  }
}

async function loadIndicators(){
  try{
    const r = await fetch('/api/indicators/form_1_gmu'); if(!r.ok) throw new Error('HTTP '+r.status);
    indicators = await r.json();
    if(indicators.length===0){
      $('#tbody').innerHTML='<tr><td colspan="4" style="text-align:center;color:#a7b3c6">Показатели не найдены. Выполните: npm run db:init</td></tr>';
      return;
    }
    renderTable(indicators);
  }catch(e){
    console.error('loadIndicators:', e);
    showBanner('Ошибка загрузки показателей');
    $('#tbody').innerHTML='<tr><td colspan="4" style="text-align:center;color:#a7b3c6">Не удалось получить показатели.</td></tr>';
  }
}

function renderTable(list){
  const tbody = $('#tbody');
  if(!Array.isArray(list)||list.length===0){
    tbody.innerHTML='<tr><td colspan="4" style="text-align:center;color:#a7b3c6">Показатели не найдены.</td></tr>';
    tbody.classList.add('disabled'); return;
  }
  tbody.innerHTML = list.map((x,i)=>`
    <tr data-id="${x.id}">
      <td>${i+1}</td>
      <td>${escapeHtml(x.name||'')}</td>
      <td>${escapeHtml(x.unit||'')}</td>
      <td><input type="number" step="any" inputmode="decimal" style="width:140px" class="value-input" data-indicator-id="${x.id}" /></td>
    </tr>`).join('');

  const inputs = tbody.querySelectorAll('input');
  inputs.forEach((inp, idx)=>{
    let t=null;
    inp.addEventListener('keydown', e=>{
      if(e.key==='Enter'){ e.preventDefault(); const next=inputs[idx+1]; if(next) next.focus(); }
    });
    inp.addEventListener('input', e=>{
      clearTimeout(t);
      const digits = e.target.value.replace(/[^\d]/g,'');
      if(digits.length>=2){
        t=setTimeout(()=>{ const next=inputs[idx+1]; if(next) next.focus(); },3000);
      }
    });
    inp.addEventListener('blur', ()=>clearTimeout(t));
  });
}

function updateTableState(){
  const tbody = $('#tbody');
  const serviceId = $('#service').value;
  const btnSave = $('#btn-save');
  const btnExport = $('#btn-export');
  const btnClear = $('#btn-clear');
  if(serviceId){ tbody.classList.remove('disabled'); btnSave.disabled=false; btnExport.disabled=false; btnClear.disabled=false; }
  else { tbody.classList.add('disabled'); btnSave.disabled=true; btnExport.disabled=true; btnClear.disabled=true; }
}

function escapeHtml(s){ return (s??'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ===== save/export/import/clear ===== */
async function saveReport(){
  if(!currentUser){ pendingRequest=saveReport; showLoginModal(); return; }
  const period=$('#period').value, municipalityId=$('#municipality').value;
  if(!period){ alert('Выберите отчётный месяц'); return; }
  if(!municipalityId){ alert('Выберите муниципалитет'); return; }
  const [year,month]=period.split('-').map(Number);
  const values=[]; document.querySelectorAll('.value-input').forEach(inp=>{ const id=Number(inp.dataset.indicatorId); const v=inp.value?Number(inp.value):null; if(id){ values.push({indicator_id:id,value:v}); } });
  if(values.length===0){ alert('Заполните хотя бы одно значение'); return; }
  const payload={municipality_id:Number(municipalityId),period_year:year,period_month:month,values};
  try{
    showBanner('Сохранение...');
    const r=await authFetch('/api/reports/save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const result=await r.json();
    if(!r.ok){ showBanner((result.detail?`${result.error}: ${result.detail}`:result.error)||'Ошибка сохранения'); return; }
    showBanner(result.message||'Отчёт сохранён!', true); setTimeout(()=>showBanner(''),3000);
  }catch(e){ if(e.message==='UNAUTHORIZED'){ pendingRequest=saveReport; return; } console.error('saveReport:', e); showBanner('Ошибка сохранения отчёта: '+e.message); }
}

async function exportToExcel(){
  if(!currentUser){ pendingRequest=exportToExcel; showLoginModal(); return; }
  const period=$('#period').value, municipalityId=$('#municipality').value;
  if(!period){ alert('Выберите отчётный месяц'); return; }
  if(!municipalityId){ alert('Выберите муниципалитет'); return; }
  const [year,month]=period.split('-').map(Number);
  try{
    showBanner('Формирование Excel...');
    const r=await authFetch('/api/reports/export',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({municipality_id:Number(municipalityId),period_year:year,period_month:month})});
    if(!r.ok){ const error=await r.json().catch(()=>({error:`HTTP ${r.status} ${r.statusText}`})); showBanner(error.error||'Ошибка экспорта'); return; }
    const blob=await r.blob(); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`Report_${year}_${String(month).padStart(2,'0')}.xlsx`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    showBanner('Excel файл загружен!', true); setTimeout(()=>showBanner(''),3000);
  }catch(e){ if(e.message==='UNAUTHORIZED'){ pendingRequest=exportToExcel; return; } console.error('exportToExcel:', e); showBanner('Ошибка экспорта в Excel'); }
}

/* Нормализация/схожесть для угадывания услуги */
function normalizeString(s){return (s||"").toLowerCase().replace(/[._\-–—]/g," ").replace(/[^a-zа-яё0-9\s]/gi," ").replace(/\s+/g," ").trim();}
function calculateSimilarity(a,b){const A=new Set(normalizeString(a).split(" ").filter(Boolean)); const B=new Set(normalizeString(b).split(" ").filter(Boolean)); if(!A.size||!B.size) return 0; let i=0; for(const t of A) if(B.has(t)) i++; const u=A.size+B.size-i; return i/u;}

async function fetchAllServices(){
  try{
    const catsRes = await authFetch('/api/service-categories'); if(!catsRes.ok) throw new Error('cats');
    const cats = await catsRes.json(); const all=[];
    for(const c of cats){ const res=await authFetch('/api/services?category='+encodeURIComponent(c.category||'')); if(res.ok){ all.push(...await res.json()); } }
    return all;
  }catch(e){ if(e.message==='UNAUTHORIZED') throw e; console.error('fetchAllServices:', e); throw new Error('Не удалось загрузить список услуг'); }
}

async function guessServiceByFilename(filename){
  const services = await fetchAllServices();
  let best=null,score=0;
  for(const s of services){ const sc=calculateSimilarity(filename, s.name||''); if(sc>score){ score=sc; best=s; } }
  if(best && score>=0.35){
    if(!confirm(`Определена услуга:\n\n${best.name}\n\nПродолжить импорт?`)) return null;
    return best;
  }
  alert('Не удалось однозначно определить услугу по имени файла.\nВыберите услугу вручную и повторите импорт.');
  return null;
}

async function uploadImportFile({file,municipalityId,year,month,service}){
  const fd=new FormData(); fd.append('file',file); fd.append('municipality_id',String(municipalityId)); fd.append('period_year',String(year)); fd.append('period_month',String(month));
  if(service?.id) fd.append('service_id',String(service.id)); if(service?.name) fd.append('service_name',service.name);
  const res=await authFetch('/api/import/service-values',{method:'POST',body:fd});
  let data=null; try{data=await res.json();}catch{}
  if(!res.ok) throw new Error(data?.error||data?.message||`Ошибка импорта (HTTP ${res.status})`);
  return data;
}

async function importFromExcel(){
  const period=$('#period').value, municipalityId=$('#municipality').value;
  if(!period||!municipalityId){ alert('Сначала выберите отчётный месяц и муниципалитет.'); return; }
  $('#file-import').click();
}

async function handleFileImport(e){
  const file=e.target.files?.[0]; e.target.value=''; if(!file) return;
  const period=$('#period').value; const municipalityId=Number($('#municipality').value||0);
  const [year,month]=period.split('-').map(Number);
  try{
    showBanner('Определение услуги по имени файла…');
    const service=await guessServiceByFilename(file.name); if(!service){ showBanner('Импорт отменён'); return; }
    showBanner('Загрузка файла и импорт…'); $('#btn-import').disabled=true;
    const result=await uploadImportFile({file,municipalityId,year,month,service});
    showBanner(result?.message||'Импорт завершён успешно!', true); setTimeout(()=>showBanner(''),3000);
    const currentServiceId=$('#service').value; if(currentServiceId && String(service.id)===currentServiceId){ /* при необходимости обновить значения */ }
  }catch(err){
    if(err.message==='UNAUTHORIZED'){ pendingRequest=()=>handleFileImport(e); return; }
    console.error('handleFileImport:', err); showBanner('Ошибка импорта: '+err.message);
  }finally{ $('#btn-import').disabled=false; }
}

function clearForm(){ if(!confirm('Очистить все введённые данные?')) return; document.querySelectorAll('.value-input').forEach(inp=>inp.value=''); }

/* ===== events ===== */
$('#service-category').addEventListener('change', e=>loadServices(e.target.value));
$('#service').addEventListener('change', updateTableState);
$('#btn-save').addEventListener('click', saveReport);
$('#btn-export').addEventListener('click', exportToExcel);
$('#btn-import').addEventListener('click', importFromExcel);
$('#file-import').addEventListener('change', handleFileImport);
$('#btn-clear').addEventListener('click', clearForm);

$('#btn-login').addEventListener('click', showLoginModal);
$('#btn-logout').addEventListener('click', logout);
$('#btn-modal-login').addEventListener('click', async ()=>{
  const municipalityId=$('#login-municipality').value;
  const password=$('#login-password').value;
  if(!municipalityId||!password){ $('#login-error').textContent='Выберите муниципалитет и введите пароль'; $('#login-error').classList.add('show'); return; }
  await login(municipalityId, password);
});
$('#btn-modal-cancel').addEventListener('click', hideLoginModal);

$('#login-municipality').addEventListener('keypress', e=>{ if(e.key==='Enter'){ e.preventDefault(); $('#login-password').focus(); } });
$('#login-password').addEventListener('keypress', e=>{ if(e.key==='Enter'){ e.preventDefault(); $('#btn-modal-login').click(); } });

/* ===== init ===== */
(async function init(){
  const now=new Date();
  $('#period').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  updateStickyTop();

  const isAuth = await checkAuth();
  if(!isAuth){ showLoginModal(); return; }

  await loadMunicipalities();
  loadServiceCategories();
  loadIndicators();
})();
</script>
</body>
</html>
