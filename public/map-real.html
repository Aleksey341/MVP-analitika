<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ ‚Äî –õ–∏–ø–µ—Ü–∫–∞—è –æ–±–ª–∞—Å—Ç—å</title>
  <link rel="stylesheet" href="/no-badge.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      color-scheme: dark light;
      --bg: #0f1115; --panel:#161a22; --border:#232a36;
      --text:#e8eef7; --muted:#a7b3c6;
      --blue:#2563eb; --blue-2:#60a5fa; --green:#10b981; --yellow:#f59e0b; --red:#ef4444;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    header,main{max-width:1200px;margin:auto;padding:16px}
    a{color:var(--blue-2);text-decoration:none}
    a:hover{text-decoration:underline}

    .layout{display:grid;grid-template-columns:1.6fr 1fr;gap:16px}
    #map{height:70vh;min-height:520px;border:1px solid var(--border);border-radius:10px;overflow:hidden}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:16px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#0f172a}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 14px;border-radius:8px;border:1px solid var(--border);background:#0b1220;color:var(--text);cursor:pointer}
    .btn:hover{border-color:var(--blue);background:#0d1426}
    .muted{color:var(--muted)}
    .big{font-size:28px;font-weight:700}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .kpi > div{background:#0b1220;border:1px solid var(--border);border-radius:10px;padding:12px}
    .kpi .v{font-size:22px;font-weight:700}
    .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .lg{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px}
    .c{width:10px;height:10px;border-radius:2px;display:inline-block}
    .leaflet-container{background:#0a0e16}
  </style>
</head>
<body>
<header class="row" style="justify-content:space-between">
  <div>
    <a href="/">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    <h1 style="margin:8px 0 0 0">üó∫Ô∏è –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –õ–∏–ø–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏</h1>
    <div class="muted">–ö–ª–∏–∫ –ø–æ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç—É ‚Äî –æ—Ç–∫—Ä–æ—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –∏ –∫–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥–µ—Ç–∞–ª—å–Ω–æ–º—É –æ—Ç—á—ë—Ç—É</div>
  </div>
  <a class="btn" href="/dashboard">üìä –ö –¥–∞—à–±–æ—Ä–¥—É</a>
</header>

<main class="layout">
  <div id="map"></div>

  <aside class="panel" id="info">
    <div class="row" style="justify-content:space-between">
      <div class="pill" id="period-pill">–ü–µ—Ä–∏–æ–¥: <span id="period-text">‚Äî</span></div>
      <button class="btn" id="open-dashboard" disabled>–ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á—ë—Ç ‚Üí</button>
    </div>

    <h2 id="mun-title" style="margin:14px 0 6px">–í—ã–±–µ—Ä–∏—Ç–µ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç</h2>
    <div class="muted" id="mun-sub">–ù–∞–≤–µ–¥–∏—Ç–µ –∫—É—Ä—Å–æ—Ä –Ω–∞ —Ä–∞–π–æ–Ω, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø–æ–¥—Å–≤–µ—Ç–∫—É; –Ω–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏.</div>

    <div style="height:12px"></div>
    <div class="kpi">
      <div>
        <div class="muted">–î–¢–ü (–≥–æ–¥)</div>
        <div class="v" id="kpi-dtp">‚Äî</div>
      </div>
      <div>
        <div class="muted">–£—Å–ª—É–≥ –æ–∫–∞–∑–∞–Ω–æ (–≥–æ–¥)</div>
        <div class="v" id="kpi-services">‚Äî</div>
      </div>
    </div>

    <div class="legend">
      <span class="lg"><i class="c" style="background:#0ea5e9"></i> –æ–±—ã—á–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞</span>
      <span class="lg"><i class="c" style="background:#f59e0b"></i> –ø–æ–≤—ã—à–µ–Ω–Ω–∞—è</span>
      <span class="lg"><i class="c" style="background:#ef4444"></i> –≤—ã—Å–æ–∫–∞—è</span>
    </div>
  </aside>
</main>

<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const $ = sel => document.querySelector(sel);

// ====== —Å–µ—Ä–≤–∏—Å—ã –∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ ID ======
let muniIndexByName = new Map();  // name(normalized) ‚Üí {id,name}
async function buildMunicipalityIndex() {
  const res = await fetch('/api/municipalities/all');
  const rows = await res.json();
  const norm = s => String(s).trim().toLowerCase()
                   .replace('—Ä–∞–π–æ–Ω','').replace('–º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥','')
                   .replace('–º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω','').replace(/\s+/g,' ').trim();
  rows.forEach(r => muniIndexByName.set(norm(r.name), { id:r.id, name:r.name }));
}

// ====== –∫–∞—Ä—Ç–∞ ======
let map, geoLayer, selectedFeature = null;

function areaFillByValue(v){
  // –ø—Ä–æ—Å—Ç–∞—è ¬´—Ç–µ–ø–ª–æ–≤–∞—è¬ª —à–∫–∞–ª–∞
  if (v >= 50) return '#ef4444';
  if (v >= 20) return '#f59e0b';
  return '#0ea5e9';
}

async function initMap(){
  map = L.map('map', {
    zoomControl: true,
    minZoom: 6, maxZoom: 12,
    attributionControl: false,
    preferCanvas:false
  });

  // –ë–µ–∑ –ø–æ–¥–ª–æ–∂–∫–∏ ‚Äî —Ç–æ–ª—å–∫–æ –Ω–∞—à–∏ –ø–æ–ª–∏–≥–æ–Ω—ã
  const geo = await fetch('/geo/lipetsk-municipalities.geojson').then(r=>r.json());

  // –ü–æ–¥–≥–æ–Ω—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã
  geoLayer = L.geoJSON(geo, {
    style: f => ({
      color: '#1f2937', weight: 1,
      fillColor: '#0ea5e9', fillOpacity: 0.25
    }),
    onEachFeature: (feature, layer) => {
      const name = feature.properties?.name || feature.properties?.NAME || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
      layer.bindTooltip(name, {sticky:true, direction:'center', opacity:0.85});

      layer.on('mouseover', () => layer.setStyle({weight:2, fillOpacity:0.45}));
      layer.on('mouseout',  () => {
        if (selectedFeature !== layer) layer.setStyle({weight:1, fillOpacity:0.25});
      });
      layer.on('click',     () => onSelectMunicipality(feature, layer));
    }
  }).addTo(map);

  map.fitBounds(geoLayer.getBounds(), { padding:[20,20] });
}

async function onSelectMunicipality(feature, layer){
  // –≤–∏–∑—É–∞–ª—å–Ω–∞—è —Ñ–∏–∫—Å–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞
  if (selectedFeature) selectedFeature.setStyle({weight:1, fillOpacity:0.25});
  selectedFeature = layer;
  layer.setStyle({weight:2, fillOpacity:0.6});

  const rawName = feature.properties?.name || feature.properties?.NAME || '';
  const norm = rawName.trim().toLowerCase()
    .replace('—Ä–∞–π–æ–Ω','').replace('–º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥','')
    .replace('–º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω','').replace(/\s+/g,' ').trim();

  const match = muniIndexByName.get(norm);
  const muniId = match?.id ?? null;
  const muniTitle = match?.name ?? rawName;

  $('#mun-title').textContent = muniTitle || '–ú—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç';
  $('#mun-sub').textContent = '–ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ‚Ä¶';
  $('#open-dashboard').disabled = !muniId;
  $('#open-dashboard').onclick = () => {
    if (muniId) window.location.href = `/dashboard?municipality_id=${muniId}`;
  };

  // –ø–µ—Ä–∏–æ–¥
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth()+1;
  $('#period-text').textContent = `${String(month).padStart(2,'0')}.${year}`;

  // –ü—Ä–∏–º–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ KPI:
  // 1) –î–¢–ü ‚Äî —Ç–≤–æ–π —Ä–æ—É—Ç –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ç–∞ (–ø–æ–∫–∞–∂–∏ –≥–æ–¥–æ–≤—É—é —Å—É–º–º—É –ø–æ muniId)
  //    –ï—Å–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ä–æ—É—Ç–∞ –Ω–µ—Ç, –º–æ–∂–Ω–æ –≤–∑—è—Ç—å /api/gibdd/periods + /api/gibdd/data?period=YYYY-MM
  //    –ù–∏–∂–µ ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–æ–∫ —Å –Ω—É–ª—è–º–∏, —á—Ç–æ–±—ã —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Å–µ–≥–¥–∞ –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–ª–∞—Å—å.
  let dtpTotal = 0;
  try {
    // –ø—Ä–∏–º–µ—Ä (–ø–æ–¥—Å—Ç—Ä–æ–π –ø–æ–¥ —Å–≤–æ–π —Ä–µ–∞–ª—å–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç):
    // const r = await fetch(`/api/gibdd/aggregate?year=${year}&municipality_id=${muniId}`);
    // const agg = await r.json(); dtpTotal = Number(agg.total)||0;
  } catch(e) {}

  // 2) –£—Å–ª—É–≥–∏ ‚Äî –µ—Å–ª–∏ –µ—Å—Ç—å /api/services/:id/monthly –∏ —Ç.–ø.
  let servicesTotal = 0;
  try {
    // –ø—Ä–∏–º–µ—Ä (–ø–æ–¥—Å—Ç—Ä–æ–π –ø–æ–¥ —Å–≤–æ–π —Ä–µ–∞–ª—å–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç):
    // const r2 = await fetch(`/api/services-dashboard/aggregate?year=${year}&municipality_id=${muniId}`);
    // const agg2 = await r2.json(); servicesTotal = Number(agg2.total)||0;
  } catch(e) {}

  // –æ—Ç—Ä–∏—Å—É–µ–º KPI
  $('#kpi-dtp').textContent = dtpTotal ? dtpTotal.toLocaleString('ru-RU') : '0';
  $('#kpi-services').textContent = servicesTotal ? servicesTotal.toLocaleString('ru-RU') : '0';

  // –ø–µ—Ä–µ–∫—Ä–∞—Å–∏–º —Ä–∞–π–æ–Ω ¬´–ø–æ –Ω–∞–≥—Ä—É–∑–∫–µ¬ª (–ø–æ –î–¢–ü)
  const fill = areaFillByValue(dtpTotal);
  layer.setStyle({ fillColor: fill });

  $('#mun-sub').textContent = '–ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á—ë—Ç¬ª, —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –∫ –¥–µ—Ç–∞–ª—è–º';
}

// ===== boot =====
(async function(){
  await buildMunicipalityIndex();
  await initMap();
})();
</script>
</body>
</html>
