<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ - –õ–∏–ø–µ—Ü–∫–∞—è –æ–±–ª–∞—Å—Ç—å</title>
  <link rel="stylesheet" href="/no-badge.css" />
  <style>
    :root {
      --bg-primary: #0f1115;
      --bg-secondary: #1a1d24;
      --bg-tertiary: #232a36;
      --border: #2b3444;
      --text-primary: #e8eef7;
      --text-secondary: #9fb0c9;
      --text-muted: #6a7789;
      --accent-blue: #2563eb;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 20px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1600px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }

    h1 { margin: 0; font-size: 24px; }
    .subtitle { color: var(--text-secondary); font-size: 14px; margin: 4px 0 0 0; }

    main {
      max-width: 1600px;
      margin: 0 auto;
      padding: 24px;
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
    }

    @media (max-width: 1024px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    .map-container {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      position: relative;
    }

    .map-wrapper {
      position: relative;
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      min-height: 600px;
    }

    .map-image {
      width: 100%;
      height: auto;
      min-height: 600px;
      display: block;
      border-radius: 8px;
      filter: brightness(1.1) contrast(1.05);
      object-fit: contain;
      background: var(--bg-tertiary);
    }

    .map-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .region-overlay {
      position: absolute;
      background: rgba(37, 99, 235, 0.1);
      border: 2px solid rgba(37, 99, 235, 0.3);
      cursor: pointer;
      pointer-events: all;
      transition: all 0.3s ease;
    }

    .region-overlay:hover {
      background: rgba(37, 99, 235, 0.3);
      border: 2px solid var(--accent-blue);
      z-index: 10;
    }

    .region-overlay.active {
      background: rgba(16, 185, 129, 0.4);
      border: 3px solid var(--success);
      z-index: 11;
    }

    .info-panel {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      position: sticky;
      top: 100px;
      max-height: calc(100vh - 120px);
      overflow-y: auto;
    }

    .info-panel h2 {
      margin: 0 0 16px 0;
      font-size: 20px;
      color: var(--text-primary);
    }

    .info-empty {
      text-align: center;
      color: var(--text-muted);
      padding: 40px 20px;
    }

    .info-empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .stat-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .stat-change {
      font-size: 14px;
      font-weight: 600;
      margin-top: 4px;
    }

    .stat-change.positive { color: var(--success); }
    .stat-change.negative { color: var(--danger); }

    .btn {
      padding: 10px 20px;
      background: var(--accent-blue);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }

    .btn:hover {
      background: #1d4ed8;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .tooltip {
      position: absolute;
      background: var(--bg-primary);
      border: 2px solid var(--accent-blue);
      border-radius: 8px;
      padding: 12px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 1000;
      font-size: 13px;
      max-width: 200px;
      white-space: nowrap;
    }

    .tooltip.show {
      opacity: 1;
    }

    .tooltip-title {
      font-weight: 700;
      margin-bottom: 4px;
      color: var(--text-primary);
    }

    .instructions {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
      font-size: 13px;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>

<header>
  <div class="header-content">
    <div>
      <h1>üó∫Ô∏è –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –õ–∏–ø–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏</h1>
      <p class="subtitle">–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —Ä–µ–≥–∏–æ–Ω –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–∞–∑–≤–∞–Ω–∏—è, –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö</p>
    </div>
    <a href="/dashboard" class="btn">‚Üê –ö –¥–∞—à–±–æ—Ä–¥—É</a>
  </div>
</header>

<main>
  <div class="map-container">
    <div class="instructions">
      üí° <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong> –ù–∞–≤–µ–¥–∏—Ç–µ –∫—É—Ä—Å–æ—Ä –Ω–∞ –ª—é–±–æ–π —Ä–µ–≥–∏–æ–Ω –Ω–∞ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –µ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏–µ. –ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.
    </div>

    <div class="map-wrapper" id="map-wrapper">
      <!-- –†–µ–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ –õ–∏–ø–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏ -->
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/94/Lipetsk_Oblast_administrative_map.svg/800px-Lipetsk_Oblast_administrative_map.svg.png"
           alt="–ö–∞—Ä—Ç–∞ –õ–∏–ø–µ—Ü–∫–æ–π –æ–±–ª–∞—Å—Ç–∏"
           class="map-image"
           id="map-image"
           crossorigin="anonymous"
           onerror="this.onerror=null; this.src='https://upload.wikimedia.org/wikipedia/commons/9/94/Lipetsk_Oblast_administrative_map.svg';" />

      <!-- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏ (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö) -->
      <div class="map-overlay" id="map-overlay">
        <!-- –†–µ–≥–∏–æ–Ω—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
      </div>
    </div>
  </div>

  <div class="info-panel" id="info-panel">
    <div class="info-empty">
      <div class="info-empty-icon">üó∫Ô∏è</div>
      <p>–í—ã–±–µ—Ä–∏—Ç–µ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç –Ω–∞ –∫–∞—Ä—Ç–µ<br>–¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</p>
    </div>
  </div>
</main>

<div class="tooltip" id="tooltip">
  <div class="tooltip-title"></div>
</div>

<script>
// ========================================
// MUNICIPALITIES WITH COORDINATES
// –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ä–µ–≥–∏–æ–Ω–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ (–≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)
// ========================================

const municipalities = [
  // –°–µ–≤–µ—Ä
  { id: 4, name: '–î–∞–Ω–∫–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω', left: 25, top: 5, width: 18, height: 15 },
  { id: 17, name: '–£—Å–º–∞–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω', left: 5, top: 18, width: 15, height: 20 },
  { id: 12, name: '–õ–µ–±–µ–¥—è–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω', left: 22, top: 22, width: 16, height: 18 },
  { id: 16, name: '–¢–µ—Ä–±—É–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω', left: 44, top: 8, width: 16, height: 18 },
  { id: 20, name: '–ß–∞–ø–ª—ã–≥–∏–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω', left: 45, top: 2, width: 18, height: 15 },
  { id: 13, name: '–õ–µ–≤-–¢–æ–ª—Å—Ç–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω', left: 64, top: 10, width: 18, height: 16 },

  // –¶–µ–Ω—Ç—Ä
  { id: 14, name: '–õ–∏–ø–µ—Ü–∫–∏–π —Ä–∞–π–æ–Ω', left: 38, top: 28, width: 18, height: 18 },
  { id: 1, name: '–≥. –õ–∏–ø–µ—Ü–∫', left: 44, top: 35, width: 8, height: 8 },
  { id: 5, name: '–î–æ–±—Ä–∏–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω', left: 18, top: 38, width: 16, height: 18 },
  { id: 9, name: '–ó–∞–¥–æ–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω', left: 50, top: 30, width: 16, height: 20 },
  { id: 6, name: '–î–æ–±—Ä–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω', left: 68, top: 28, width: 16, height: 20 },
  { id: 15, name: '–°—Ç–∞–Ω–æ–≤–ª—è–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω', left: 85, top: 32, width: 14, height: 18 },

  // –Æ–≥
  { id: 3, name: '–ì—Ä—è–∑–∏–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω', left: 32, top: 48, width: 16, height: 16 },
  { id: 11, name: '–ö—Ä–∞—Å–Ω–∏–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω', left: 20, top: 58, width: 16, height: 18 },
  { id: 19, name: '–í–æ–ª–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω', left: 8, top: 70, width: 14, height: 18 },
  { id: 18, name: '–•–ª–µ–≤–µ–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω', left: 48, top: 52, width: 16, height: 18 },
  { id: 8, name: '–ï–ª–µ—Ü–∫–∏–π —Ä–∞–π–æ–Ω', left: 50, top: 68, width: 18, height: 20 },
  { id: 2, name: '–≥. –ï–ª–µ—Ü', left: 54, top: 74, width: 8, height: 8 },
  { id: 7, name: '–î–æ–ª–≥–æ—Ä—É–∫–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω', left: 70, top: 52, width: 16, height: 22 },
  { id: 10, name: '–ò–∑–º–∞–ª–∫–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω', left: 70, top: 76, width: 16, height: 18 }
];

// ========================================
// CREATE INTERACTIVE REGIONS
// ========================================

function createInteractiveMap() {
  const overlay = document.getElementById('map-overlay');
  const mapImage = document.getElementById('map-image');

  municipalities.forEach(mun => {
    const region = document.createElement('div');
    region.className = 'region-overlay';
    region.dataset.munId = mun.id;
    region.dataset.munName = mun.name;

    region.style.left = mun.left + '%';
    region.style.top = mun.top + '%';
    region.style.width = mun.width + '%';
    region.style.height = mun.height + '%';

    region.addEventListener('click', () => selectMunicipality(mun.id, mun.name));
    region.addEventListener('mouseenter', (e) => showTooltip(e, mun));
    region.addEventListener('mouseleave', hideTooltip);

    overlay.appendChild(region);
  });
}

// ========================================
// TOOLTIP
// ========================================

const tooltip = document.getElementById('tooltip');

function showTooltip(event, mun) {
  tooltip.querySelector('.tooltip-title').textContent = mun.name;

  const rect = event.target.getBoundingClientRect();
  tooltip.style.left = rect.left + rect.width / 2 + 'px';
  tooltip.style.top = rect.top - 40 + 'px';
  tooltip.classList.add('show');
}

function hideTooltip() {
  tooltip.classList.remove('show');
}

// ========================================
// SELECT MUNICIPALITY
// ========================================

let currentMunId = null;

async function selectMunicipality(munId, munName) {
  // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤—ã–±–æ—Ä
  document.querySelectorAll('.region-overlay').forEach(r => r.classList.remove('active'));

  // –í—ã–¥–µ–ª—è–µ–º –Ω–æ–≤—ã–π
  const region = document.querySelector(`[data-mun-id="${munId}"]`);
  if (region) {
    region.classList.add('active');
  }

  currentMunId = munId;

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
  await loadMunicipalityData(munId, munName);
}

// ========================================
// LOAD DATA
// ========================================

async function loadMunicipalityData(munId, munName) {
  const panel = document.getElementById('info-panel');
  panel.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>';

  try {
    const currentYear = new Date().getFullYear();

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ì–ò–ë–î–î
    const gibddResponse = await fetch(`/api/gibdd/heatmap?year=${currentYear}`);
    const gibddData = await gibddResponse.json();

    const munGibdd = gibddData.find(d => d.municipality_id === munId);

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —É—Å–ª—É–≥
    const servicesResponse = await fetch(`/api/services-dashboard/data?year=${currentYear}&municipality_id=${munId}`);
    const servicesData = await servicesResponse.json();

    // –†–µ–Ω–¥–µ—Ä–∏–º –ø–∞–Ω–µ–ª—å
    renderMunicipalityPanel(munName, munGibdd, servicesData);

  } catch (error) {
    console.error('Error loading data:', error);
    panel.innerHTML = `
      <div class="info-empty">
        <div class="info-empty-icon">‚ö†Ô∏è</div>
        <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>
      </div>
    `;
  }
}

// ========================================
// RENDER PANEL
// ========================================

function renderMunicipalityPanel(name, gibddData, servicesData) {
  const panel = document.getElementById('info-panel');

  const totalDTP = gibddData ? gibddData.total : 0;
  const totalServices = servicesData.kpi ? servicesData.kpi.total_services : 0;

  panel.innerHTML = `
    <h2>${name}</h2>

    <div class="stat-card">
      <div class="stat-label">üöó –î–¢–ü –∑–∞ ${new Date().getFullYear()} –≥–æ–¥</div>
      <div class="stat-value">${totalDTP.toLocaleString()}</div>
      ${servicesData.kpi && servicesData.kpi.change_percent ? `
        <div class="stat-change ${parseFloat(servicesData.kpi.change_percent) < 0 ? 'positive' : 'negative'}">
          ${parseFloat(servicesData.kpi.change_percent) > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(servicesData.kpi.change_percent)}%
        </div>
      ` : ''}
    </div>

    <div class="stat-card">
      <div class="stat-label">üìä –£—Å–ª—É–≥ –æ–∫–∞–∑–∞–Ω–æ</div>
      <div class="stat-value">${totalServices.toLocaleString()}</div>
      ${servicesData.kpi && servicesData.kpi.change_percent ? `
        <div class="stat-change ${parseFloat(servicesData.kpi.change_percent) > 0 ? 'positive' : 'negative'}">
          ${parseFloat(servicesData.kpi.change_percent) > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(servicesData.kpi.change_percent)}%
        </div>
      ` : ''}
    </div>

    <div style="margin-top: 24px;">
      <a href="/dashboard?municipality_id=${currentMunId}" class="btn" style="width: 100%; text-align: center;">
        üìà –ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á—ë—Ç ‚Üí
      </a>
    </div>

    <div style="margin-top: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; font-size: 12px; color: var(--text-secondary);">
      <p style="margin: 0;">üí° <strong>–°–æ–≤–µ—Ç:</strong> –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –¥—Ä—É–≥–æ–π —Ä–µ–≥–∏–æ–Ω –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π</p>
    </div>
  `;
}

// ========================================
// INIT
// ========================================

document.addEventListener('DOMContentLoaded', () => {
  const mapImage = document.getElementById('map-image');

  // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  if (mapImage.complete) {
    console.log('–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, —Ä–∞–∑–º–µ—Ä—ã:', mapImage.naturalWidth, 'x', mapImage.naturalHeight);
    createInteractiveMap();
  } else {
    mapImage.addEventListener('load', () => {
      console.log('–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, —Ä–∞–∑–º–µ—Ä—ã:', mapImage.naturalWidth, 'x', mapImage.naturalHeight);
      createInteractiveMap();
    });

    mapImage.addEventListener('error', (e) => {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã:', e);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
    });
  }

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –õ–∏–ø–µ—Ü–∫ —á–µ—Ä–µ–∑ 1000–º—Å
  setTimeout(() => {
    selectMunicipality(1, '–≥. –õ–∏–ø–µ—Ü–∫');
  }, 1000);
});
</script>

</body>
</html>
