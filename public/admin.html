<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Админ-панель</title>
  <style>
    :root {
      color-scheme: dark light;
      --bg-primary: #0a0d12;
      --bg-secondary: #12161c;
      --bg-tertiary: #1a1d24;
      --border-primary: #2b3444;
      --border-secondary: #232a36;
      --accent-blue: #5a8fff;
      --accent-blue-light: #8ab4ff;
      --text-primary: #e8eef7;
      --text-secondary: #9fb0c9;
      --text-muted: #6a7789;
    }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:var(--bg-primary);
      color:var(--text-primary);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Header with enhanced gradient shadow */
    header{
      position:sticky;
      top:0;
      z-index:100;
      background:linear-gradient(180deg, #0f1115 0%, #0d0f13 100%);
      border-bottom:1px solid #232a36;
      padding:24px;
      max-width:1400px;
      margin:auto;
      box-shadow:0 4px 20px rgba(0,0,0,0.4), 0 8px 40px rgba(0,0,0,0.2);
    }

    /* Title with gradient and text shadow */
    h1{
      background:linear-gradient(135deg, #8ab4ff 0%, #5a8fff 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      font-size:28px;
      font-weight:700;
      margin:8px 0 16px 0;
      letter-spacing:-0.5px;
      filter:drop-shadow(0 2px 4px rgba(90,143,255,0.3));
    }

    h2{
      color:var(--text-primary);
      font-size:20px;
      font-weight:600;
      margin:32px 0 16px 0;
      letter-spacing:-0.3px;
    }

    main{max-width:1400px;margin:auto;padding:24px}
    a{color:#8ab4ff;text-decoration:none;transition:color 0.2s}
    a:hover{color:#a8c8ff;text-decoration:underline}

    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .ctl{display:flex;flex-direction:column;gap:6px;position:relative;flex:1;min-width:200px}

    /* Labels with animated pulse icons */
    label{
      font-size:13px;
      font-weight:500;
      color:var(--text-secondary);
      letter-spacing:0.3px;
      display:flex;
      align-items:center;
      gap:6px;
      transition:color 0.2s ease;
    }
    label::before{
      content:'';
      display:inline-block;
      width:4px;
      height:4px;
      background:var(--accent-blue);
      border-radius:50%;
      animation:pulse 2s ease-in-out infinite;
    }
    @keyframes pulse{
      0%, 100%{opacity:1; transform:scale(1)}
      50%{opacity:0.6; transform:scale(0.85)}
    }
    .ctl:focus-within label{
      color:var(--accent-blue-light);
    }
    .ctl:focus-within label::before{
      animation:none;
      box-shadow:0 0 6px var(--accent-blue);
    }

    /* Inputs with enhanced focus states and depth */
    select,input[type="text"],input[type="email"],input[type="password"]{
      background:#12161c;
      border:1px solid #2b3444;
      border-radius:10px;
      color:#e8eef7;
      padding:12px 14px;
      width:100%;
      box-sizing:border-box;
      transition:all 0.3s ease;
      box-shadow:0 2px 8px rgba(0,0,0,0.2), inset 0 1px 2px rgba(0,0,0,0.1);
    }
    select:focus,input[type="text"]:focus,input[type="email"]:focus,input[type="password"]:focus{
      outline:none;
      border-color:#5a8fff;
      box-shadow:0 0 0 3px rgba(90,143,255,0.15), 0 6px 16px rgba(0,0,0,0.4), 0 0 20px rgba(90,143,255,0.1);
      background:#151a22;
      transform:translateY(-1px);
    }
    select:hover,input[type="text"]:hover,input[type="email"]:hover,input[type="password"]:hover{
      border-color:#3a5488;
      box-shadow:0 4px 12px rgba(0,0,0,0.25), inset 0 1px 2px rgba(0,0,0,0.1);
    }

    /* Multiple select */
    select[multiple]{
      min-height:120px;
    }

    /* Checkbox */
    .checkbox-wrapper{
      display:flex;
      align-items:center;
      gap:8px;
      margin-top:8px;
    }
    input[type="checkbox"]{
      width:18px;
      height:18px;
      cursor:pointer;
      accent-color:var(--accent-blue);
    }
    .checkbox-wrapper label{
      margin:0;
    }
    .checkbox-wrapper label::before{
      display:none;
    }

    /* Enhanced gradient buttons with multi-layered shadows */
    button{
      background:linear-gradient(135deg, #1b6fff 0%, #1554d1 100%);
      border:0;
      color:#fff;
      padding:12px 20px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      transition:all 0.3s ease;
      box-shadow:0 4px 12px rgba(27,111,255,0.3), 0 2px 6px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.1);
      position:relative;
      overflow:hidden;
    }
    button::before{
      content:'';
      position:absolute;
      top:0;
      left:-100%;
      width:100%;
      height:100%;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition:left 0.5s;
    }
    button:hover::before{
      left:100%;
    }
    button:hover{
      transform:translateY(-3px);
      box-shadow:0 8px 20px rgba(27,111,255,0.45), 0 4px 10px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.15);
    }
    button:active{
      transform:translateY(-1px);
      box-shadow:0 2px 8px rgba(27,111,255,0.35), 0 1px 4px rgba(0,0,0,0.2);
    }

    button.secondary{
      background:linear-gradient(135deg, #1e2430 0%, #161b24 100%);
      box-shadow:0 4px 12px rgba(0,0,0,0.3), 0 2px 6px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.05);
    }
    button.secondary:hover{
      transform:translateY(-3px);
      box-shadow:0 8px 18px rgba(0,0,0,0.45), 0 4px 8px rgba(0,0,0,0.3);
    }
    button.secondary:active{
      transform:translateY(-1px);
      box-shadow:0 2px 8px rgba(0,0,0,0.35);
    }

    button.danger{
      background:linear-gradient(135deg, #ff4b4b 0%, #d13131 100%);
      box-shadow:0 4px 12px rgba(255,75,75,0.3), 0 2px 6px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.1);
    }
    button.danger:hover{
      transform:translateY(-3px);
      box-shadow:0 8px 20px rgba(255,75,75,0.45), 0 4px 10px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.15);
    }

    button.small{
      padding:6px 12px;
      font-size:13px;
    }

    button:disabled{
      opacity:0.4;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
    }
    button:disabled:hover{
      transform:none;
    }

    /* Banner with animations */
    .banner{
      background:linear-gradient(135deg, #2a1620 0%, #1f1218 100%);
      border:1px solid #6a1b2a;
      color:#ffd6de;
      border-radius:10px;
      padding:14px 16px;
      margin:12px 0;
      display:none;
      animation:slideDown 0.3s ease;
      box-shadow:0 4px 12px rgba(0,0,0,0.3);
    }
    .banner.success{
      background:linear-gradient(135deg, #1a2a20 0%, #141f18 100%);
      border-color:#2a6a3a;
      color:#d6ffd6;
    }
    @keyframes slideDown{
      from{opacity:0;transform:translateY(-10px)}
      to{opacity:1;transform:translateY(0)}
    }

    /* Table with enhanced depth and elevation */
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:16px;
      background:#12161c;
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 4px 16px rgba(0,0,0,0.3), 0 8px 32px rgba(0,0,0,0.2), 0 1px 0 rgba(255,255,255,0.05);
    }

    th{
      background:linear-gradient(180deg, #1a1f28 0%, #151a22 100%);
      color:#a7b3c6;
      font-weight:600;
      border-bottom:2px solid #2a3544;
      padding:14px 12px;
      text-transform:uppercase;
      font-size:12px;
      letter-spacing:0.8px;
      text-align:left;
    }

    tbody tr{
      transition:all 0.2s ease;
    }
    tbody tr:nth-child(even){
      background:#0f1318;
    }
    tbody tr:hover{
      background:#1a2230;
      transform:scale(1.002);
      box-shadow:0 2px 8px rgba(90,143,255,0.1), 0 4px 16px rgba(90,143,255,0.05);
    }

    td{
      border-bottom:1px solid #1a1f28;
      padding:12px;
      text-align:left;
    }

    .actions-cell{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    /* Auth block in header */
    .auth-block{
      display:flex;
      align-items:center;
      gap:12px;
      margin-top:12px;
      padding:12px;
      background:rgba(26,29,36,0.6);
      border-radius:8px;
      border:1px solid #2b3444;
    }
    .user-info{
      display:flex;
      align-items:center;
      gap:8px;
      flex:1;
    }
    .user-email{
      color:var(--accent-blue-light);
      font-weight:600;
      font-size:14px;
    }
    .user-role{
      background:rgba(90,143,255,0.2);
      color:var(--accent-blue-light);
      padding:4px 10px;
      border-radius:6px;
      font-size:12px;
      font-weight:600;
      text-transform:uppercase;
    }
    .auth-block button{
      padding:8px 16px;
      font-size:14px;
    }

    /* Modal */
    .modal-overlay{
      display:none;
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,0.85);
      z-index:1000;
      animation:fadeIn 0.2s ease;
    }
    .modal-overlay.show{
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .modal{
      background:var(--bg-secondary);
      border:1px solid var(--border-primary);
      border-radius:12px;
      padding:32px;
      min-width:500px;
      max-width:90%;
      max-height:90vh;
      overflow-y:auto;
      box-shadow:0 20px 60px rgba(0,0,0,0.6);
      animation:slideDown 0.3s ease;
    }
    .modal h2{
      margin:0 0 24px 0;
      color:var(--text-primary);
      font-size:24px;
    }
    .modal .ctl{
      margin-bottom:16px;
    }
    .modal-buttons{
      display:flex;
      gap:12px;
      margin-top:24px;
    }
    .modal-buttons button{
      flex:1;
    }
    .modal-error{
      color:#ff6b6b;
      font-size:14px;
      margin-top:12px;
      display:none;
    }
    .modal-error.show{
      display:block;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar{width:10px;height:10px}
    ::-webkit-scrollbar-track{background:var(--bg-primary)}
    ::-webkit-scrollbar-thumb{
      background:var(--border-primary);
      border-radius:5px;
      transition:background 0.2s;
    }
    ::-webkit-scrollbar-thumb:hover{background:var(--accent-blue)}

    /* Fade in animation for page load */
    @keyframes fadeIn{
      from{opacity:0; transform:translateY(20px)}
      to{opacity:1; transform:translateY(0)}
    }
    main{
      animation:fadeIn 0.5s ease-out;
    }

    /* Create user section */
    .create-user-section{
      background:var(--bg-secondary);
      border:1px solid var(--border-primary);
      border-radius:12px;
      padding:24px;
      margin-bottom:32px;
      box-shadow:0 4px 16px rgba(0,0,0,0.3);
    }

    /* Loading state */
    .loading{
      text-align:center;
      padding:40px;
      color:var(--text-secondary);
    }
  </style>
</head>
<body>
<header>
  <a href="/form" aria-label="На форму">← На форму</a>
  <h1>Админ-панель</h1>

  <!-- Auth Block -->
  <div class="auth-block" id="auth-block">
    <div class="user-info" id="user-info">
      <span class="user-email" id="user-email"></span>
      <span class="user-role" id="user-role"></span>
    </div>
    <button id="btn-logout" class="secondary">Выйти</button>
  </div>

  <div id="banner" class="banner"></div>
</header>

<main>
  <!-- Create User Section -->
  <div class="create-user-section">
    <h2>Создать пользователя</h2>
    <div class="row">
      <div class="ctl">
        <label for="create-email">Email</label>
        <input type="email" id="create-email" placeholder="user@example.com" />
      </div>
      <div class="ctl">
        <label for="create-password">Пароль</label>
        <input type="password" id="create-password" placeholder="Минимум 6 символов" />
      </div>
      <div class="ctl">
        <label for="create-role">Роль</label>
        <select id="create-role">
          <option value="operator">Operator</option>
          <option value="admin">Admin</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:16px">
      <div class="ctl">
        <label for="create-municipalities">Муниципалитеты</label>
        <select id="create-municipalities" multiple>
          <option value="">Загрузка...</option>
        </select>
      </div>
    </div>
    <div class="checkbox-wrapper">
      <input type="checkbox" id="create-active" checked />
      <label for="create-active">Активен</label>
    </div>
    <div style="margin-top:16px">
      <button id="btn-create-user">Создать пользователя</button>
    </div>
  </div>

  <!-- Users Table -->
  <h2>Пользователи</h2>
  <div id="users-table-container">
    <div class="loading">Загрузка пользователей...</div>
  </div>
</main>

<!-- Edit User Modal -->
<div class="modal-overlay" id="modal-edit-user">
  <div class="modal">
    <h2>Редактировать пользователя</h2>
    <div class="ctl">
      <label for="edit-email">Email</label>
      <input type="email" id="edit-email" />
    </div>
    <div class="ctl">
      <label for="edit-role">Роль</label>
      <select id="edit-role">
        <option value="operator">Operator</option>
        <option value="admin">Admin</option>
      </select>
    </div>
    <div class="ctl">
      <label for="edit-municipalities">Муниципалитеты</label>
      <select id="edit-municipalities" multiple>
        <option value="">Загрузка...</option>
      </select>
    </div>
    <div class="checkbox-wrapper">
      <input type="checkbox" id="edit-active" />
      <label for="edit-active">Активен</label>
    </div>
    <div class="modal-error" id="edit-error"></div>
    <div class="modal-buttons">
      <button id="btn-save-edit">Сохранить</button>
      <button class="secondary" id="btn-cancel-edit">Отмена</button>
    </div>
  </div>
</div>

<!-- Change Password Modal -->
<div class="modal-overlay" id="modal-change-password">
  <div class="modal">
    <h2>Сменить пароль</h2>
    <div class="ctl">
      <label for="new-password">Новый пароль</label>
      <input type="password" id="new-password" placeholder="Минимум 6 символов" />
    </div>
    <div class="modal-error" id="password-error"></div>
    <div class="modal-buttons">
      <button id="btn-save-password">Сохранить</button>
      <button class="secondary" id="btn-cancel-password">Отмена</button>
    </div>
  </div>
</div>

<script>
/* ===== helpers ===== */
const $ = (s)=>document.querySelector(s);
const banner = $('#banner');
function showBanner(msg, isSuccess){
  if(!msg){banner.style.display='none'; return;}
  banner.textContent = msg;
  banner.className = isSuccess ? 'banner success' : 'banner';
  banner.style.display='block';
}

function escapeHtml(s){
  return (s??'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* ===== state ===== */
let currentUser = null;
let editingUserId = null;
let changingPasswordUserId = null;
let allMunicipalities = [];

/* ===== auth check ===== */
async function checkAuth(){
  try{
    const r = await fetch('/api/auth/me', {credentials: 'include'});
    if(r.ok){
      currentUser = await r.json();
      updateAuthUI();

      // Check if user is admin
      if(currentUser.role !== 'admin'){
        window.location.href = '/form';
        return false;
      }
      return true;
    } else {
      window.location.href = '/form';
      return false;
    }
  }catch(e){
    console.error('checkAuth:', e);
    window.location.href = '/form';
    return false;
  }
}

function updateAuthUI(){
  const userEmail = $('#user-email');
  const userRole = $('#user-role');

  if(currentUser){
    userEmail.textContent = currentUser.email;
    userRole.textContent = currentUser.role;
  }
}

async function logout(){
  try{
    await fetch('/api/auth/logout', {
      method: 'POST',
      credentials: 'include'
    });
    window.location.href = '/form';
  }catch(e){
    console.error('logout:', e);
  }
}

/* ===== fetch wrapper with 401 handling ===== */
async function authFetch(url, options = {}){
  const r = await fetch(url, {...options, credentials: 'include'});

  if(r.status === 401){
    window.location.href = '/form';
    throw new Error('UNAUTHORIZED');
  }

  return r;
}

/* ===== load municipalities ===== */
async function loadMunicipalities(){
  try{
    const r = await authFetch('/api/municipalities');
    if(!r.ok) throw new Error('HTTP '+r.status);
    allMunicipalities = await r.json();

    // Update create form
    const createSelect = $('#create-municipalities');
    createSelect.innerHTML = allMunicipalities
      .map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`)
      .join('');

  }catch(e){
    if(e.message === 'UNAUTHORIZED') return;
    console.error('loadMunicipalities:', e);
    showBanner('Ошибка загрузки муниципалитетов');
  }
}

/* ===== load users ===== */
async function loadUsers(){
  try{
    const r = await authFetch('/api/admin/users');
    if(!r.ok) throw new Error('HTTP '+r.status);
    const users = await r.json();

    renderUsersTable(users);
  }catch(e){
    if(e.message === 'UNAUTHORIZED') return;
    console.error('loadUsers:', e);
    showBanner('Ошибка загрузки пользователей');
    $('#users-table-container').innerHTML = '<div class="loading">Ошибка загрузки пользователей</div>';
  }
}

function renderUsersTable(users){
  const container = $('#users-table-container');

  if(users.length === 0){
    container.innerHTML = '<div class="loading">Пользователи не найдены</div>';
    return;
  }

  const tableHTML = `
    <table>
      <thead>
        <tr>
          <th style="width:60px">ID</th>
          <th>Email</th>
          <th style="width:100px">Роль</th>
          <th style="width:80px">Активен</th>
          <th style="width:150px">Создан</th>
          <th style="width:300px">Действия</th>
        </tr>
      </thead>
      <tbody>
        ${users.map(u => `
          <tr>
            <td>${u.id}</td>
            <td>${escapeHtml(u.email)}</td>
            <td>${escapeHtml(u.role)}</td>
            <td>${u.is_active ? 'Да' : 'Нет'}</td>
            <td>${formatDate(u.created_at)}</td>
            <td>
              <div class="actions-cell">
                <button class="small secondary" onclick="editUser(${u.id})">Редактировать</button>
                <button class="small secondary" onclick="changePassword(${u.id})">Сменить пароль</button>
                <button class="small danger" onclick="deleteUser(${u.id}, '${escapeHtml(u.email)}')">Удалить</button>
              </div>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;

  container.innerHTML = tableHTML;
}

function formatDate(dateStr){
  if(!dateStr) return '';
  const d = new Date(dateStr);
  return d.toLocaleDateString('ru-RU', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });
}

/* ===== create user ===== */
async function createUser(){
  const email = $('#create-email').value.trim();
  const password = $('#create-password').value;
  const role = $('#create-role').value;
  const isActive = $('#create-active').checked;
  const municipalityIds = Array.from($('#create-municipalities').selectedOptions).map(o => Number(o.value));

  if(!email){
    showBanner('Введите email');
    return;
  }
  if(!password || password.length < 6){
    showBanner('Пароль должен содержать минимум 6 символов');
    return;
  }

  try{
    showBanner('Создание пользователя...');
    const r = await authFetch('/api/admin/users', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        email,
        password,
        role,
        is_active: isActive,
        municipality_ids: municipalityIds
      })
    });

    const result = await r.json();

    if(!r.ok){
      showBanner(result.error || 'Ошибка создания пользователя');
      return;
    }

    showBanner('Пользователь создан успешно!', true);
    setTimeout(() => showBanner(''), 3000);

    // Clear form
    $('#create-email').value = '';
    $('#create-password').value = '';
    $('#create-role').value = 'operator';
    $('#create-active').checked = true;
    $('#create-municipalities').selectedIndex = -1;

    // Reload users
    loadUsers();
  }catch(e){
    if(e.message === 'UNAUTHORIZED') return;
    console.error('createUser:', e);
    showBanner('Ошибка создания пользователя: ' + e.message);
  }
}

/* ===== edit user ===== */
async function editUser(userId){
  editingUserId = userId;

  try{
    // Load user data
    const r = await authFetch(`/api/admin/users/${userId}`);
    if(!r.ok) throw new Error('HTTP '+r.status);
    const user = await r.json();

    // Load user municipalities
    const mR = await authFetch(`/api/admin/users/${userId}/municipalities`);
    if(!mR.ok) throw new Error('HTTP '+mR.status);
    const userMunicipalities = await mR.json();

    // Fill form
    $('#edit-email').value = user.email;
    $('#edit-role').value = user.role;
    $('#edit-active').checked = user.is_active;

    // Populate municipalities select
    const editSelect = $('#edit-municipalities');
    editSelect.innerHTML = allMunicipalities
      .map(m => `<option value="${m.id}">${escapeHtml(m.name)}</option>`)
      .join('');

    // Select user's municipalities
    const userMunIds = userMunicipalities.map(m => m.id);
    Array.from(editSelect.options).forEach(opt => {
      if(userMunIds.includes(Number(opt.value))){
        opt.selected = true;
      }
    });

    // Show modal
    $('#edit-error').classList.remove('show');
    $('#edit-error').textContent = '';
    $('#modal-edit-user').classList.add('show');

  }catch(e){
    if(e.message === 'UNAUTHORIZED') return;
    console.error('editUser:', e);
    showBanner('Ошибка загрузки данных пользователя');
  }
}

async function saveEditUser(){
  const email = $('#edit-email').value.trim();
  const role = $('#edit-role').value;
  const isActive = $('#edit-active').checked;
  const municipalityIds = Array.from($('#edit-municipalities').selectedOptions).map(o => Number(o.value));

  if(!email){
    $('#edit-error').textContent = 'Введите email';
    $('#edit-error').classList.add('show');
    return;
  }

  try{
    const r = await authFetch(`/api/admin/users/${editingUserId}`, {
      method: 'PATCH',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        email,
        role,
        is_active: isActive,
        municipality_ids: municipalityIds
      })
    });

    const result = await r.json();

    if(!r.ok){
      $('#edit-error').textContent = result.error || 'Ошибка обновления пользователя';
      $('#edit-error').classList.add('show');
      return;
    }

    showBanner('Пользователь обновлен успешно!', true);
    setTimeout(() => showBanner(''), 3000);

    // Close modal and reload
    $('#modal-edit-user').classList.remove('show');
    loadUsers();

  }catch(e){
    if(e.message === 'UNAUTHORIZED') return;
    console.error('saveEditUser:', e);
    $('#edit-error').textContent = 'Ошибка обновления: ' + e.message;
    $('#edit-error').classList.add('show');
  }
}

/* ===== change password ===== */
function changePassword(userId){
  changingPasswordUserId = userId;
  $('#new-password').value = '';
  $('#password-error').classList.remove('show');
  $('#password-error').textContent = '';
  $('#modal-change-password').classList.add('show');
  setTimeout(() => $('#new-password').focus(), 100);
}

async function savePassword(){
  const newPassword = $('#new-password').value;

  if(!newPassword || newPassword.length < 6){
    $('#password-error').textContent = 'Пароль должен содержать минимум 6 символов';
    $('#password-error').classList.add('show');
    return;
  }

  try{
    const r = await authFetch(`/api/admin/users/${changingPasswordUserId}/password`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ password: newPassword })
    });

    const result = await r.json();

    if(!r.ok){
      $('#password-error').textContent = result.error || 'Ошибка смены пароля';
      $('#password-error').classList.add('show');
      return;
    }

    showBanner('Пароль изменен успешно!', true);
    setTimeout(() => showBanner(''), 3000);

    $('#modal-change-password').classList.remove('show');

  }catch(e){
    if(e.message === 'UNAUTHORIZED') return;
    console.error('savePassword:', e);
    $('#password-error').textContent = 'Ошибка смены пароля: ' + e.message;
    $('#password-error').classList.add('show');
  }
}

/* ===== delete user ===== */
async function deleteUser(userId, email){
  if(!confirm(`Вы уверены, что хотите удалить пользователя "${email}"?`)){
    return;
  }

  try{
    showBanner('Удаление пользователя...');
    const r = await authFetch(`/api/admin/users/${userId}`, {
      method: 'DELETE'
    });

    const result = await r.json();

    if(!r.ok){
      showBanner(result.error || 'Ошибка удаления пользователя');
      return;
    }

    showBanner('Пользователь удален успешно!', true);
    setTimeout(() => showBanner(''), 3000);

    loadUsers();

  }catch(e){
    if(e.message === 'UNAUTHORIZED') return;
    console.error('deleteUser:', e);
    showBanner('Ошибка удаления пользователя: ' + e.message);
  }
}

/* ===== event listeners ===== */
$('#btn-logout').addEventListener('click', logout);
$('#btn-create-user').addEventListener('click', createUser);
$('#btn-save-edit').addEventListener('click', saveEditUser);
$('#btn-cancel-edit').addEventListener('click', () => {
  $('#modal-edit-user').classList.remove('show');
});
$('#btn-save-password').addEventListener('click', savePassword);
$('#btn-cancel-password').addEventListener('click', () => {
  $('#modal-change-password').classList.remove('show');
});

// Make functions global for onclick handlers
window.editUser = editUser;
window.changePassword = changePassword;
window.deleteUser = deleteUser;

/* ===== init ===== */
(async function init(){
  // Check auth and admin rights
  const isAuth = await checkAuth();
  if(!isAuth) return;

  // Load data
  await loadMunicipalities();
  await loadUsers();
})();
</script>
</body>
</html>
