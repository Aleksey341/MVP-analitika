# Система управления паролями

## Обзор

Система обеспечивает безопасное управление паролями пользователей с функцией принудительной смены при первом входе.

## Применение миграции БД

Перед использованием необходимо применить миграцию:

```sql
-- Выполните на сервере БД
\i database/password-reset-migration.sql
```

Или через psql:
```bash
psql -h your-db-host -U your-user -d reports -f database/password-reset-migration.sql
```

## Для администраторов

### 1. Создание нового пользователя

**Через API:**
```bash
POST /api/admin/users
Content-Type: application/json

{
  "municipality_id": 15,
  "password": "временный_пароль",
  "role": "operator"
}
```

При создании автоматически устанавливается флаг `password_reset_required = TRUE`.

### 2. Генерация временного пароля

**Через API:**
```bash
POST /api/admin/generate-temp-password
```

**Ответ:**
```json
{
  "success": true,
  "password": "липецкданные847"
}
```

Пароль генерируется по шаблону: `слово1` + `слово2` + `3цифры`

### 3. Смена пароля пользователя

**Через API:**
```bash
POST /api/admin/users/:id/password
Content-Type: application/json

{
  "password": "новый_пароль",
  "require_reset": true  // true = пользователь должен сменить при входе
}
```

**Параметры:**
- `password` — новый пароль (минимум 6 символов)
- `require_reset` — требовать смену при следующем входе (по умолчанию `true`)

### 4. Передача пароля пользователю

**Рекомендуемый процесс:**

1. Создайте пользователя или смените пароль с `require_reset: true`
2. Сгенерируйте временный пароль через API
3. Передайте пароль пользователю **безопасным способом**:
   - ✅ По телефону
   - ✅ Через защищённый мессенджер
   - ✅ Лично
   - ❌ **НЕ через email в открытом виде**
   - ❌ **НЕ через SMS**

## Для пользователей (операторов)

### 1. Первый вход

1. Получите временный пароль от администратора
2. Войдите на `/form` с логином (ID муниципалитета) и временным паролем
3. Вас автоматически перенаправит на `/change-password.html?required=true`
4. Смените пароль на постоянный

### 2. Смена пароля в любое время

**Вариант 1: Через интерфейс**
- Нажмите "Сменить пароль" в header страницы
- Введите текущий и новый пароль

**Вариант 2: Прямая ссылка**
- Перейдите на `/change-password.html`

**Вариант 3: Через API**
```bash
POST /api/auth/change-password
Content-Type: application/json

{
  "current_password": "текущий_пароль",
  "new_password": "новый_пароль"
}
```

### 3. Требования к паролю

- ✅ Минимум 6 символов
- ✅ Должен отличаться от текущего
- ✅ Должны совпадать поля "Новый пароль" и "Подтверждение"

## API Endpoints

### Для всех авторизованных пользователей

#### Смена собственного пароля
```
POST /api/auth/change-password
Authorization: Required (session cookie)
Content-Type: application/json

Body:
{
  "current_password": "string",
  "new_password": "string"
}

Response 200:
{
  "success": true,
  "message": "Пароль успешно изменён"
}

Response 401:
{
  "error": "unauthorized",
  "message": "Текущий пароль неверен"
}

Response 400:
{
  "error": "bad_request",
  "message": "Новый пароль должен содержать минимум 6 символов"
}
```

### Для администраторов

#### Генерация временного пароля
```
POST /api/admin/generate-temp-password
Authorization: Required (admin role)

Response 200:
{
  "success": true,
  "password": "липецкданные847"
}
```

#### Смена пароля пользователя
```
POST /api/admin/users/:id/password
Authorization: Required (admin role)
Content-Type: application/json

Body:
{
  "password": "string",
  "require_reset": boolean  // optional, default: true
}

Response 200:
{
  "success": true,
  "message": "Пароль обновлен. Пользователь должен будет сменить пароль при следующем входе."
}
```

## Таблица БД

### Новые поля в `users`

```sql
-- Флаг принудительной смены пароля
password_reset_required BOOLEAN NOT NULL DEFAULT FALSE

-- Дата последней смены пароля
last_password_change TIMESTAMP
```

## Безопасность

### Хранение паролей
- ✅ Используется **bcrypt** с фактором 12
- ✅ Пароли хранятся только в виде хеша
- ✅ Невозможно восстановить пароль из хеша

### Валидация
- ✅ Минимальная длина: 6 символов
- ✅ Проверка текущего пароля перед сменой
- ✅ Новый пароль должен отличаться от текущего

### Принудительная смена
- ✅ При создании пользователя автоматически устанавливается флаг
- ✅ При входе проверяется флаг и перенаправляет на смену
- ✅ Флаг сбрасывается только после успешной смены

## Примеры использования

### Сценарий 1: Создание нового сотрудника

**Администратор:**
```bash
# 1. Генерируем временный пароль
curl -X POST https://your-domain.com/api/admin/generate-temp-password \
  -H "Cookie: sid=your_session_cookie" \
  -H "Content-Type: application/json"

# Ответ: { "password": "липецкслужба523" }

# 2. Создаём пользователя
curl -X POST https://your-domain.com/api/admin/users \
  -H "Cookie: sid=your_session_cookie" \
  -H "Content-Type: application/json" \
  -d '{
    "municipality_id": 15,
    "password": "липецкслужба523",
    "role": "operator"
  }'

# 3. Сообщаем пользователю:
#    Логин: 15
#    Пароль: липецкслужба523
#    При первом входе потребуется сменить пароль
```

**Сотрудник:**
1. Заходит на сайт
2. Вводит логин `15` и пароль `липецкслужба523`
3. Автоматически перенаправляется на страницу смены пароля
4. Вводит временный пароль и новый постоянный пароль
5. После смены попадает на страницу работы с формой

### Сценарий 2: Сброс забытого пароля

**Сотрудник звонит администратору:**
- "Я забыл пароль, помогите войти"

**Администратор:**
```bash
# 1. Генерируем новый временный пароль
curl -X POST https://your-domain.com/api/admin/generate-temp-password \
  -H "Cookie: sid=your_session_cookie"

# Ответ: { "password": "отчетгород892" }

# 2. Устанавливаем новый пароль пользователю (require_reset: true)
curl -X POST https://your-domain.com/api/admin/users/45/password \
  -H "Cookie: sid=your_session_cookie" \
  -H "Content-Type: application/json" \
  -d '{
    "password": "отчетгород892",
    "require_reset": true
  }'

# 3. Сообщаем пользователю новый временный пароль по телефону
```

### Сценарий 3: Плановая смена пароля

**Сотрудник:**
1. Нажимает "Сменить пароль" в header
2. Вводит текущий пароль
3. Вводит новый пароль (дважды для подтверждения)
4. Нажимает "Изменить пароль"
5. Видит сообщение "Пароль успешно изменён"
6. Автоматически перенаправляется на форму

## Troubleshooting

### Пользователь не может войти

1. Проверьте, активен ли пользователь: `SELECT is_active FROM users WHERE id = ?`
2. Проверьте правильность логина (ID муниципалитета)
3. Сбросьте пароль через админ-панель

### "Текущий пароль неверен"

- Убедитесь, что пользователь вводит текущий пароль правильно
- Если забыл, администратор должен сбросить пароль

### Зацикливание на странице смены пароля

- Проверьте, что в БД применена миграция
- Проверьте, что поле `password_reset_required` сбрасывается после смены
- Очистите cookies и войдите заново

## Рекомендации по безопасности

1. **Не передавайте пароли по email** — используйте телефон или личную встречу
2. **Регулярно меняйте пароли** — рекомендуется каждые 90 дней
3. **Используйте уникальные пароли** — не повторяйте старые пароли
4. **Не записывайте пароли** — используйте менеджер паролей
5. **Сообщайте о подозрительной активности** — если заметили несанкционированный вход

---

**Версия:** 1.0
**Дата:** 2025-10-02
